{"version":3,"sources":["../../src/websocket-client/Query.js"],"names":["Logger","AbstractQuery","WebsocketStore","decode","SubscribeReturnType","cancel","stop","logger","Query","store","key","callback","emit","then","_includeInitial","args","eventName","restName","connection","on","err","result","_stopEmitSubscribe","promise","emitSubscribe","stopEmitSubscribe","info","catch","off","Promise","resolve","cb"],"mappings":";;;;;;;;;;AAAA,OAAOA,MAAP,MAAmB,oBAAnB;AACA,OAAOC,aAAP,MAA0B,wBAA1B;AACA,OAAOC,cAAP,MAA2B,kBAA3B;AACA,SAASC,MAAT,QAAuB,YAAvB;;IAEKC,mB;AACHC,Q;AACAC,M;;;AAGF,IAAMC,SAAS,IAAIP,MAAJ,CAAW,6BAAX,CAAf;;IAEqBQ,K;;;AACnB,iBAAYC,KAAZ,EAAmCC,GAAnC,EAAgD;AAAA,YAApCD,KAAoC,EAA7BP,cAA6B;;AAAA,YAAbQ,GAAa;;AAAA;;AAAA,8GACxCD,KADwC;;AAE9C,UAAKC,GAAL,GAAWA,GAAX;AAF8C;AAG/C;;;;0BAEKC,Q,EAA8B;AAAA,cAA9BA,QAA8B;;AAAA;AAClC,eAAO,KAAKF,KAAL,CAAWG,IAAX,CAAgB,OAAhB,EAAyB,KAAKF,GAA9B,EAAmCG,IAAnC,CAAwCF,QAAxC,CAAP;AADkC;AAEnC;;;+BAEUA,Q,EAAoF;AAAA,UAAhEG,eAAgE,uEAA9C,KAA8C;;AAAA,UAAvCC,IAAuC;;AAAA,cAApFJ,QAAoF;;AAAA,cAAvCI,IAAuC;;AAAA;AAAA;;AAC7F,YAAMC,2BAAyB,KAAKP,KAAL,CAAWQ,QAApC,SAAgD,KAAKP,GAA3D;AACA,aAAKD,KAAL,CAAWS,UAAX,CAAsBC,EAAtB,CAAyBH,SAAzB,EAAoC,UAACI,GAAD,EAAMC,MAAN,EAAiB;AACnDV,mBAASS,GAAT,EAAcjB,OAAOkB,MAAP,CAAd;AACD,SAFD;;AAIA,YAAIC,2BAAJ;AACA,YAAIC,UAAU,KAAKd,KAAL,CAAWe,aAAX,CACZV,kBAAkB,mBAAlB,GAAwC,WAD5B,EAEZ,KAAKJ,GAFO,EAGZM,SAHY,EAIZD,IAJY,EAKZF,IALY,CAKP,6BAAqB;AAC1BS,+BAAqBG,iBAArB;AACAlB,iBAAOmB,IAAP,CAAY,YAAZ;AACD,SARa,EAQXC,KARW,CAQL,eAAO;AACd,iBAAKlB,KAAL,CAAWS,UAAX,CAAsBU,GAAtB,CAA0BZ,SAA1B,EAAqCL,QAArC;AACA,gBAAMS,GAAN;AACD,SAXa,CAAd;;AAaA,YAAMd,OAAO,SAAPA,IAAO,GAAM;AACjB,cAAI,CAACiB,OAAL,EAAc;AACdD;AACAC,kBAAQV,IAAR,CAAa,YAAM;AACjBU,sBAAU,IAAV;AACA,mBAAKd,KAAL,CAAWS,UAAX,CAAsBU,GAAtB,CAA0BZ,SAA1B,EAAqCL,QAArC;AACD,WAHD;AAID,SAPD;;AASA,eAAO;AACLN,kBAAQC,IADH;AAELA,oBAFK;AAGLO,gBAAM;AAAA,mBAAMgB,QAAQC,OAAR,CAAgBP,OAAhB,EAAyBV,IAAzB,CAA8BkB,EAA9B,CAAN;AAAA;AAHD,SAAP;AA7B6F,gCAApB3B,mBAAoB;AAkC9F;;;;EA5CgCH,a;;eAAdO,K","file":"Query.js","sourcesContent":["import Logger from 'nightingale-logger';\nimport AbstractQuery from '../store/AbstractQuery';\nimport WebsocketStore from './WebsocketStore';\nimport { decode } from '../msgpack';\n\ntype SubscribeReturnType = {\n  cancel: Function,\n  stop: Function,\n};\n\nconst logger = new Logger('liwi:websocket-client:query');\n\nexport default class Query extends AbstractQuery<WebsocketStore> {\n  constructor(store: WebsocketStore, key: string) {\n    super(store);\n    this.key = key;\n  }\n\n  fetch(callback: ?Function): Promise {\n    return this.store.emit('fetch', this.key).then(callback);\n  }\n\n  _subscribe(callback: Function, _includeInitial = false, args: Array<any>): SubscribeReturnType {\n    const eventName = `subscribe:${this.store.restName}.${this.key}`;\n    this.store.connection.on(eventName, (err, result) => {\n      callback(err, decode(result));\n    });\n\n    let _stopEmitSubscribe;\n    let promise = this.store.emitSubscribe(\n      _includeInitial ? 'fetchAndSubscribe' : 'subscribe',\n      this.key,\n      eventName,\n      args,\n    ).then(stopEmitSubscribe => {\n      _stopEmitSubscribe = stopEmitSubscribe;\n      logger.info('subscribed');\n    }).catch(err => {\n      this.store.connection.off(eventName, callback);\n      throw err;\n    });\n\n    const stop = () => {\n      if (!promise) return;\n      _stopEmitSubscribe();\n      promise.then(() => {\n        promise = null;\n        this.store.connection.off(eventName, callback);\n      });\n    };\n\n    return {\n      cancel: stop,\n      stop,\n      then: cb => Promise.resolve(promise).then(cb),\n    };\n  }\n}\n"]}