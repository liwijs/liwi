{"version":3,"sources":["../../src/mongo/MongoStore.js"],"names":[],"mappings":";;;;;;;;;;AAAA,SAAS,QAAT,QAAyB,SAAzB;AACA,OAAO,UAAP,MAAuB,wBAAvB;AACA,OAAO,EAAP,MAAe,gBAAf;AACA,OAAO,eAAP,MAA4B,mBAA5B;AACA,OAAO,aAAP,MAA0B,wBAA1B;AACA,OAAO,WAAP,MAAwB,eAAxB;;IAEqB,U;;;AAIjB,wBAAY,UAAZ,EAAyC,cAAzC,EAAiE;AAAA;;AAAA,cAArD,UAAqD,YAAzC,eAAyC;AAAA,uIAArD,UAAqD;AAAA;;AAAA,qBAAxB,cAAwB;AAAA,kIAAxB,cAAwB;AAAA;;AAAA,kGACvD,UADuD;;AAAA,cAFjE,OAEiE,GAFvD,KAEuD;;;AAG7D,YAAI,CAAC,cAAL,EAAqB;AACjB,kBAAM,IAAI,KAAJ,+BAAsC,cAAtC,OAAN;AACH;;AAED,cAAK,WAAL,GAAmB,WAAW,aAAX,GACd,IADc,CACT,UAAC,EAAD;AAAA,kBAAC,EAAD,YAAK,EAAL;AAAA,sHAAC,EAAD;AAAA;;AAAA,mBAAY,MAAK,WAAL,GAAmB,GAAG,UAAH,CAAc,cAAd,CAA/B;;AAAA,kBAAY,MAAK,WAAjB,YAXD,UAWC,IAAY,MAAK,WAAjB,YAXU,OAWV;AAAA,yJAAY,MAAK,WAAjB;AAAA;AAAA,SADS,CAAnB;;AAP6D,cAO7D,MAAK,WAPwD,YAHpD,UAGoD,IAO7D,MAAK,WAPwD,YAHzC,OAGyC;AAAA,qJAO7D,MAAK,WAPwD;AAAA;;AAAA;AAShE;;;;kCAUS,M,EAAuC;AAAA;AAAA,sCAAnB,OAAmB;AAAA;AAAA;;AAAA;AAAA;;AAC7C,gBAAI,CAAC,OAAO,GAAZ,EAAiB;AACb,uBAAO,GAAP,GAAc,IAAI,QAAJ,EAAD,CAAiB,QAAjB,EAAb;AACH;AACD,gBAAI,CAAC,OAAO,OAAZ,EAAqB;AACjB,uBAAO,OAAP,GAAiB,IAAI,IAAJ,EAAjB;AACH;;AAN4C,yBAQtC,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,SAAX,CAAqB,MAArB,CAAd;AAAA,aADH,EAEF,IAFE,CAEG,kBAAiC;AAAA,oBAA9B,MAA8B,UAA9B,MAA8B;AAAA,oBAAtB,UAAsB,UAAtB,UAAsB;AAAA,oBAAV,GAAU,UAAV,GAAU;;AACnC,oBAAI,CAAC,OAAO,EAAR,IAAc,OAAO,CAAP,KAAa,CAA/B,EAAkC;AAC9B,0BAAM,IAAI,KAAJ,CAAU,gBAAV,CAAN;AACH;AACJ,aANE,EAOF,IAPE,CAOG;AAAA,uBAAM,MAAN;AAAA,aAPH,CARsC;AAgBhD;;;kCAES,M,EAAuC;AAAA;AAAA,sCAAnB,OAAmB;AAAA;AAAA;;AAAA;AAAA;;AAC7C,gBAAI,CAAC,OAAO,OAAZ,EAAqB;AACjB,uBAAO,OAAP,GAAiB,IAAI,IAAJ,EAAjB;AACH;;AAH4C,yBAKtC,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,SAAX,CAAqB,EAAE,KAAK,OAAO,GAAd,EAArB,EAA0C,MAA1C,CAAd;AAAA,aADH,EAEF,IAFE,CAEG;AAAA,uBAAM,MAAN;AAAA,aAFH,CALsC;AAQhD;;;kCAES,M,EAAuC;AAAA;AAAA,sCAAnB,OAAmB;AAAA;AAAA;;AAAA;AAAA;;AAC7C,gBAAI,CAAC,OAAO,OAAZ,EAAqB;AACjB,uBAAO,OAAP,GAAiB,IAAI,IAAJ,EAAjB;AACH;;AAH4C,yBAKtC,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,SAAX,CAAqB,EAAE,KAAK,OAAO,GAAd,EAArB,EAA0C,EAAE,MAAM,MAAR,EAA1C,EAA4D,EAAE,QAAQ,IAAV,EAA5D,CAAd;AAAA,aADH,EAEF,IAFE,CAEG;AAAA,uBAAM,MAAN;AAAA,aAFH,CALsC;AAQhD;;;sCAEa,O,EAAsD;AAAA;;AAAA;AAAA,sCAA1B,OAA0B;AAAA;AAAA;;AAAA;AAAA;;AAAA,+BAAtD,OAAsD;AAAA,yIAAtD,OAAsD;AAAA;;AAAA,yBACzD,QAAQ,GAAR,CAAY,QAAQ,GAAR,CAAY;AAAA,uBAAU,OAAK,SAAL,CAAe,MAAf,CAAV;AAAA,aAAZ,CAAZ,CADyD;AAEnE;;;uCAEc,a,EAAuB;AAAA,kBAAvB,aAAuB,YAAR,MAAQ;AAAA,qIAAvB,aAAuB;AAAA;;AAClC;AACA;AACA,gBAAI,OAAO,IAAP,CAAY,aAAZ,EAA2B,IAA3B,CAAgC;AAAA,uBAAO,IAAI,CAAJ,MAAW,GAAlB;AAAA,aAAhC,CAAJ,EAA4D;AACxD,uBAAO,aAAP;AACH,aAFD,MAEO;AACH,uBAAO,EAAE,MAAM,aAAR,EAAP;AACH;AACJ;;;2CAEkB,G,EAAU,a,EAAgC;AAAA;AAAA,sCAAR,OAAQ;AAAA;AAAA;;AAAA;AAAA;;AAAA,kBAAhC,aAAgC,YAAjB,MAAiB;AAAA,qIAAhC,aAAgC;AAAA;;AACzD,4BAAgB,KAAK,cAAL,CAAoB,aAApB,CAAhB;AADyD,yBAElD,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,SAAX,CAAqB,EAAE,KAAK,GAAP,EAArB,EAAmC,aAAnC,CAAd;AAAA,aADH,CAFkD;AAI5D;;;yCAEgB,M,EAAmB,a,EAA2C;AAAA;;AAAA;AAAA,sCAAnB,OAAmB;AAAA;AAAA;;AAAA;AAAA;;AAAA,kBAA3C,aAA2C,YAA5B,MAA4B;AAAA,qIAA3C,aAA2C;AAAA;;AAC3E,4BAAgB,KAAK,cAAL,CAAoB,aAApB,CAAhB;AAD2E,yBAEpE,KAAK,kBAAL,CAAwB,OAAO,GAA/B,EAAoC,aAApC,EACF,IADE,CACG;AAAA,uBAAO,OAAK,SAAL,CAAe,OAAO,GAAtB,CAAP;AAAA,aADH,CAFoE;AAI9E;;;0CAEiB,Q,EAAU,a,EAAgC;AAAA;AAAA,sCAAR,OAAQ;AAAA;AAAA;;AAAA;AAAA;;AAAA,kBAAhC,aAAgC,YAAjB,MAAiB;AAAA,qIAAhC,aAAgC;AAAA;;AACxD,4BAAgB,KAAK,cAAL,CAAoB,aAApB,CAAhB;AADwD,yBAEjD,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,UAAX,CAAsB,QAAtB,EAAgC,aAAhC,CAAd;AAAA,aADH,EAEF,IAFE,CAEG;AAAA,uBAAO,IAAP;AAAA,aAFH,CAFiD,GAIhC;AAC3B;;;oCAEW,G,EAAmB;AAAA;AAAA,sCAAR,OAAQ;AAAA;AAAA;;AAAA;AAAA;;AAAA,yBACpB,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,SAAX,CAAqB,EAAE,KAAK,GAAP,EAArB,CAAd;AAAA,aADH,EAEF,IAFE,CAEG;AAAA,uBAAM,IAAN;AAAA,aAFH,CADoB;AAI9B;;;+BAGM,Q,EAAmB,I,EAAgD;AAAA;;AAAA;AAAA,uCAAhC,OAAgC;AAAA;AAAA;;AAAA;AAAA;;AAAA,kBAAnE,QAAmE,YAAnE,QAAmE,YAAxD,MAAwD;AAAA,iIAAnE,QAAmE;AAAA;;AAAA,kBAAhD,IAAgD,YAAhD,IAAgD,YAAzC,MAAyC;AAAA,6HAAhD,IAAgD;AAAA;;AAAA,0BAC/D,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,IAAX,CAAgB,QAAhB,CAAd;AAAA,aADH,EAEF,IAFE,CAEG,QAAS;AAAA,uBAAU,OAAO,IAAP,CAAY,IAAZ,CAAV;AAAA,aAFZ,EAGF,IAHE,CAGG;AAAA,uBAAU,IAAI,WAAJ,SAAsB,MAAtB,CAAV;AAAA,aAHH,CAD+D;AAKzE;;;kCAES,G,EAAU;AAChB,mBAAO,KAAK,OAAL,CAAa,EAAE,KAAK,GAAP,EAAb,CAAP;AACH;;;gCAEO,Q,EAAkB,I,EAAgC;AAAA;AAAA,uCAAhB,OAAgB;AAAA;AAAA;;AAAA;AAAA;;AAAA,kBAAlD,QAAkD,YAAxC,MAAwC;AAAA,gIAAlD,QAAkD;AAAA;;AAAA,kBAAhC,IAAgC,YAAhC,IAAgC,YAAzB,MAAyB;AAAA,6HAAhC,IAAgC;AAAA;;AAAA,0BAC/C,KAAK,UAAL,CACF,IADE,CACG;AAAA,uBAAc,WAAW,IAAX,CAAgB,QAAhB,CAAd;AAAA,aADH,EAEF,IAFE,CAEG,QAAS;AAAA,uBAAU,OAAO,IAAP,CAAY,IAAZ,CAAV;AAAA,aAFZ,EAGF,IAHE,CAGG;AAAA,uBAAU,OAAO,KAAP,CAAa,CAAb,EAAgB,IAAhB,EAAV;AAAA,aAHH,CAD+C;AAKzD;;;4BAtGqC;AAAA;AAAA,qCAApB,OAAoB;AAAA;AAAA;;AAAA;AAAA;;AAClC,gBAAI,KAAK,UAAL,CAAgB,gBAApB,EAAsC;AAAA,4BAC3B,QAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU,2BAAV,CAAf,CAD2B;AAErC;;AAHiC,wBAK3B,QAAQ,OAAR,CAAgB,KAAK,WAArB,CAL2B;AAMrC;;;;EArB8C,a;;eAA9B,U","file":"MongoStore.js","sourcesContent":["import { ObjectID } from 'mongodb';\nimport Collection from 'mongodb/lib/collection';\nimport Db from 'mongodb/lib/db';\nimport MongoConnection from './MongoConnection';\nimport AbstractStore from '../store/AbstractStore';\nimport MongoCursor from './MongoCursor';\n\nexport default class MongoStore<ModelType> extends AbstractStore<MongoConnection> {\n    _collection: Collection|Promise<Collection>;\n    keyPath = '_id';\n\n    constructor(connection: MongoConnection, collectionName: string) {\n        super(connection);\n\n        if (!collectionName) {\n            throw new Error(`Invalid collectionName: \"${collectionName}\"`);\n        }\n\n        this._collection = connection.getConnection()\n            .then((db: Db) => this._collection = db.collection(collectionName));\n    }\n\n    get collection(): Promise<Collection> {\n        if (this.connection.connectionFailed) {\n            return Promise.reject(new Error('MongoDB connection failed'));\n        }\n\n        return Promise.resolve(this._collection);\n    }\n\n    insertOne(object: ModelType): Promise<ModelType> {\n        if (!object._id) {\n            object._id = (new ObjectID()).toString();\n        }\n        if (!object.created) {\n            object.created = new Date();\n        }\n\n        return this.collection\n            .then(collection => collection.insertOne(object))\n            .then(({ result, connection, ops }) => {\n                if (!result.ok || result.n !== 1) {\n                    throw new Error('Fail to insert');\n                }\n            })\n            .then(() => object);\n    }\n\n    updateOne(object: ModelType): Promise<ModelType> {\n        if (!object.updated) {\n            object.updated = new Date();\n        }\n\n        return this.collection\n            .then(collection => collection.updateOne({ _id: object._id }, object))\n            .then(() => object);\n    }\n\n    upsertOne(object: ModelType): Promise<ModelType> {\n        if (!object.updated) {\n            object.updated = new Date();\n        }\n\n        return this.collection\n            .then(collection => collection.updateOne({ _id: object._id }, { $set: object }, { upsert: true }))\n            .then(() => object);\n    }\n\n    updateSeveral(objects: Array<ModelType>): Promise<Array<ModelType>> {\n        return Promise.all(objects.map(object => this.updateOne(object)));\n    }\n\n    _partialUpdate(partialUpdate: Object) {\n        // https://docs.mongodb.com/manual/reference/operator/update/\n        // if has a mongo operator\n        if (Object.keys(partialUpdate).some(key => key[0] === '$')) {\n            return partialUpdate;\n        } else {\n            return { $set: partialUpdate };\n        }\n    }\n\n    partialUpdateByKey(key: any, partialUpdate: Object): Promise {\n        partialUpdate = this._partialUpdate(partialUpdate);\n        return this.collection\n            .then(collection => collection.updateOne({ _id: key }, partialUpdate));\n    }\n\n    partialUpdateOne(object: ModelType, partialUpdate: Object): Promise<ModelType> {\n        partialUpdate = this._partialUpdate(partialUpdate);\n        return this.partialUpdateByKey(object._id, partialUpdate)\n            .then(res => this.findByKey(object._id));\n    }\n\n    partialUpdateMany(criteria, partialUpdate: Object): Promise {\n        partialUpdate = this._partialUpdate(partialUpdate);\n        return this.collection\n            .then(collection => collection.updateMany(criteria, partialUpdate))\n            .then(res => null); // TODO return updated object\n    }\n\n    deleteByKey(key: any): Promise {\n        return this.collection\n            .then(collection => collection.removeOne({ _id: key }))\n            .then(() => null);\n    }\n\n\n    cursor(criteria: ?Object, sort: ?Object): Promise<MongoCursor<ModelType>> {\n        return this.collection\n            .then(collection => collection.find(criteria))\n            .then(sort && (cursor => cursor.sort(sort)))\n            .then(cursor => new MongoCursor(this, cursor));\n    }\n\n    findByKey(key: any) {\n        return this.findOne({ _id: key });\n    }\n\n    findOne(criteria: Object, sort: ?Object): Promise<Object> {\n        return this.collection\n            .then(collection => collection.find(criteria))\n            .then(sort && (cursor => cursor.sort(sort)))\n            .then(cursor => cursor.limit(1).next());\n    }\n}\n"]}