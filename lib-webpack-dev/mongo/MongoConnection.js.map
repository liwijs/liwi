{"version":3,"sources":["../../src/mongo/MongoConnection.js"],"names":[],"mappings":";;;;;;;;;;AAAA,OAAO,MAAP,MAAmB,oBAAnB;AACA,SAAS,WAAT,QAA4B,SAA5B;AACA,OAAO,EAAP,MAAe,gBAAf;AACA,OAAO,kBAAP,MAA+B,6BAA/B;;AAEA,IAAM,SAAS,IAAI,MAAJ,CAAW,4BAAX,CAAf;;IAEqB,e;;;AAKjB,6BAAY,MAAZ,EAAyB;AAAA;;AAAA,cAAb,MAAa;AAAA,uHAAb,MAAa;AAAA;;AAAA;;AAGrB,YAAI,CAAC,OAAO,GAAP,CAAW,MAAX,CAAL,EAAyB;AACrB,mBAAO,GAAP,CAAW,MAAX,EAAmB,WAAnB;AACH;AACD,YAAI,CAAC,OAAO,GAAP,CAAW,MAAX,CAAL,EAAyB;AACrB,mBAAO,GAAP,CAAW,MAAX,EAAmB,OAAnB;AACH;AACD,YAAI,CAAC,OAAO,GAAP,CAAW,UAAX,CAAL,EAA6B;AACzB,kBAAM,IAAI,KAAJ,CAAU,yBAAV,CAAN;AACH;;AAED,YAAM,mBAAmB,gBAAa,OAAO,GAAP,CAAW,MAAX,IAAwB,OAAO,GAAP,CAAW,MAAX,CAAxB,SAA8C,OAAO,GAAP,CAAW,UAAX,CAA9C,SAA0E,EAAvF,KACG,OAAO,GAAP,CAAW,MAAX,CADH,SACyB,OAAO,GAAP,CAAW,MAAX,CADzB,SAC+C,OAAO,GAAP,CAAW,UAAX,CAD/C,CAAzB;;AAGA,cAAK,OAAL,CAAa,gBAAb;AAhBqB;AAiBxB;;;;gCAEO,gB,EAAkB;AAAA;;AACtB,mBAAO,IAAP,CAAY,YAAZ,EAA0B,EAAE,kCAAF,EAA1B;;AAEA,gBAAM,iBAAiB,YAAY,OAAZ,CAAoB,gBAApB,EAClB,IADkB,CACb,sBAAc;AAChB,uBAAO,IAAP,CAAY,WAAZ,EAAyB,EAAE,kCAAF,EAAzB;AACA,2BAAW,EAAX,CAAc,OAAd,EAAuB,YAAM;AACzB,2BAAO,IAAP,CAAY,OAAZ,EAAqB,EAAE,kCAAF,EAArB;AACA,2BAAK,gBAAL,GAAwB,IAAxB;AACA,2BAAK,aAAL,GAAqB;AAAA,+BAAM,QAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU,2BAAV,CAAf,CAAN;AAAA,qBAArB;;AAHyB,iCAGzB,OAAK,aAHoB;AAAA,oJAGzB,OAAK,aAHoB;AAAA;AAI5B,iBAJD;AAKA,2BAAW,EAAX,CAAc,SAAd,EAAyB,YAAM;AAC3B,2BAAO,IAAP,CAAY,SAAZ,EAAuB,EAAE,kCAAF,EAAvB;AACA,2BAAK,gBAAL,GAAwB,IAAxB;AACA,2BAAK,aAAL,GAAqB;AAAA,+BAAM,QAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU,4BAAV,CAAf,CAAN;AAAA,qBAArB;;AAH2B,iCAG3B,OAAK,aAHsB;AAAA,oJAG3B,OAAK,aAHsB;AAAA;AAI9B,iBAJD;AAKA,2BAAW,EAAX,CAAc,WAAd,EAA2B,YAAM;AAC7B,2BAAO,IAAP,CAAY,WAAZ,EAAyB,EAAE,kCAAF,EAAzB;AACA,2BAAK,gBAAL,GAAwB,KAAxB;AACA,2BAAK,aAAL,GAAqB;AAAA,+BAAM,QAAQ,OAAR,CAAgB,OAAK,WAArB,CAAN;AAAA,qBAArB;;AAH6B,iCAG7B,OAAK,aAHwB;AAAA,oJAG7B,OAAK,aAHwB;AAAA;AAIhC,iBAJD;AAKA,2BAAW,EAAX,CAAc,OAAd,EAAuB,eAAO;AAC1B,2BAAO,IAAP,CAAY,OAAZ,EAAqB,EAAE,kCAAF,EAAoB,QAApB,EAArB;AACH,iBAFD;;AAIA,uBAAK,WAAL,GAAmB,UAAnB;;AArBgB,sBAqBhB,OAAK,WArBW,YA3Bf,EA2Be,IAqBhB,OAAK,WArBW;AAAA,sIAqBhB,OAAK,WArBW;AAAA;;AAsBhB,uBAAK,WAAL,GAAmB,IAAnB;;AAtBgB,sBAsBhB,OAAK,WAtBW,YA1Bf,OA0Be,IAsBhB,OAAK,WAtBW;AAAA,2IAsBhB,OAAK,WAtBW;AAAA;;AAuBhB,uBAAK,aAAL,GAAqB;AAAA,2BAAM,QAAQ,OAAR,CAAgB,OAAK,WAArB,CAAN;AAAA,iBAArB;;AAvBgB,6BAuBhB,OAAK,aAvBW;AAAA,gJAuBhB,OAAK,aAvBW;AAAA;;AAwBhB,uBAAO,UAAP;AACH,aA1BkB,EA2BlB,KA3BkB,CA2BZ,eAAO;AACV,uBAAO,IAAP,CAAY,eAAZ,EAA6B,EAAE,kCAAF,EAA7B;AACA,wBAAQ,KAAR,CAAc,IAAI,OAAJ,IAAe,GAA7B;AACA;AACA,wBAAQ,QAAR,CAAiB,YAAM;AACnB,4BAAQ,IAAR,CAAa,CAAb;AACH,iBAFD;;AAIA,sBAAM,GAAN;AACH,aApCkB,CAAvB;;AAsCA,iBAAK,aAAL,GAAqB;AAAA,uBAAM,QAAQ,OAAR,CAAgB,cAAhB,CAAN;AAAA,aAArB;;AAzCsB,yBAyCtB,KAAK,aAzCiB;AAAA,4IAyCtB,KAAK,aAzCiB;AAAA;;AA0CtB,iBAAK,WAAL,GAAmB,KAAK,aAAL,EAAnB;;AA1CsB,kBA0CtB,KAAK,WA1CiB,YAtBb,OAsBa,IA0CtB,KAAK,WA1CiB;AAAA,uIA0CtB,KAAK,WA1CiB;AAAA;AA2CzB;;;wCAE4B;AACzB,kBAAM,IAAI,KAAJ,CAAU,gBAAV,CAAN;AACH;;;gCAEO;AAAA;;AACJ,iBAAK,aAAL,GAAqB;AAAA,uBAAM,QAAQ,MAAR,CAAe,IAAI,KAAJ,CAAU,mBAAV,CAAf,CAAN;AAAA,aAArB;;AADI,yBACJ,KAAK,aADD;AAAA,4IACJ,KAAK,aADD;AAAA;;AAEJ,gBAAI,KAAK,WAAT,EAAsB;AAClB,uBAAO,KAAK,WAAL,CAAiB,KAAjB,EAAP;AACH,aAFD,MAEO,IAAI,KAAK,WAAT,EAAsB;AACzB,uBAAO,KAAK,WAAL,CAAiB,IAAjB,CAAsB;AAAA,2BAAM,OAAK,KAAL,EAAN;AAAA,iBAAtB,CAAP;AACH;AACJ;;;;EAhFwC,kB;;eAAxB,e","file":"MongoConnection.js","sourcesContent":["import Logger from 'nightingale-logger';\nimport { MongoClient } from 'mongodb';\nimport Db from 'mongodb/lib/db';\nimport AbstractConnection from '../store/AbstractConnection';\n\nconst logger = new Logger('liwi.mongo.MongoConnection');\n\nexport default class MongoConnection extends AbstractConnection {\n    _connection: Db|null;\n    _connecting: Promise|null;\n    connectionFailed: boolean;\n\n    constructor(config: Map) {\n        super();\n\n        if (!config.has('host')) {\n            config.set('host', 'localhost');\n        }\n        if (!config.has('port')) {\n            config.set('port', '27017');\n        }\n        if (!config.has('database')) {\n            throw new Error('Missing config database');\n        }\n\n        const connectionString = `mongodb://${config.has('user') ? `${config.get('user')}:${config.get('password')}@` : ''}`\n                               + `${config.get('host')}:${config.get('port')}/${config.get('database')}`;\n\n        this.connect(connectionString);\n    }\n\n    connect(connectionString) {\n        logger.info('connecting', { connectionString });\n\n        const connectPromise = MongoClient.connect(connectionString)\n            .then(connection => {\n                logger.info('connected', { connectionString });\n                connection.on('close', () => {\n                    logger.warn('close', { connectionString });\n                    this.connectionFailed = true;\n                    this.getConnection = () => Promise.reject(new Error('MongoDB connection closed'));\n                });\n                connection.on('timeout', () => {\n                    logger.warn('timeout', { connectionString });\n                    this.connectionFailed = true;\n                    this.getConnection = () => Promise.reject(new Error('MongoDB connection timeout'));\n                });\n                connection.on('reconnect', () => {\n                    logger.warn('reconnect', { connectionString });\n                    this.connectionFailed = false;\n                    this.getConnection = () => Promise.resolve(this._connection);\n                });\n                connection.on('error', err => {\n                    logger.warn('error', { connectionString, err });\n                });\n\n                this._connection = connection;\n                this._connecting = null;\n                this.getConnection = () => Promise.resolve(this._connection);\n                return connection;\n            })\n            .catch(err => {\n                logger.info('not connected', { connectionString });\n                console.error(err.message || err);\n                // throw err;\n                process.nextTick(() => {\n                    process.exit(1);\n                });\n\n                throw err;\n            });\n\n        this.getConnection = () => Promise.resolve(connectPromise);\n        this._connecting = this.getConnection();\n    }\n\n    getConnection(): Promise<Db> {\n        throw new Error('call connect()');\n    }\n\n    close() {\n        this.getConnection = () => Promise.reject(new Error('Connection closed'));\n        if (this._connection) {\n            return this._connection.close();\n        } else if (this._connecting) {\n            return this._connecting.then(() => this.close());\n        }\n    }\n}\n"]}