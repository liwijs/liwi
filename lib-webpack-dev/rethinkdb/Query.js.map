{"version":3,"sources":["../../src/rethinkdb/Query.js"],"names":["AbstractQuery","SubscribeReturnType","cancel","stop","Query","callback","queryCallback","store","query","r","run","then","_includeInitial","args","_feed","promise","changes","includeInitial","includeStates","includeTypes","includeOffsets","length","feed","_promise","each","closeFeed","cb","errCb","close"],"mappings":";;;;;;;;;;AAAA,OAAOA,aAAP,MAA0B,wBAA1B;;IAGKC,mB;AACHC,Q;AACAC,M;;;IAGmBC,K;;;;;;;;;;;0BACbC,Q,EAA8B;AAAA,cAA9BA,QAA8B;;AAAA;AAClC,eAAO,KAAKC,aAAL,CAAmB,KAAKC,KAAL,CAAWC,KAAX,EAAnB,EAAuC,KAAKD,KAAL,CAAWE,CAAlD,EAAqDC,GAArD,GAA2DC,IAA3D,CAAgEN,QAAhE,CAAP;AADkC;AAEnC;;;+BAEUA,Q,EAAoF;AAAA,UAAhEO,eAAgE,uEAA9C,KAA8C;;AAAA,UAAvCC,IAAuC;;AAAA,cAApFR,QAAoF;;AAAA,cAAvCQ,IAAuC;;AAAA;AAAA;;AAC7F,YAAIC,cAAJ;AACA,YAAIC,UACF,KAAKT,aAAL,CAAmB,KAAKC,KAAL,CAAWC,KAAX,EAAnB,EAAuC,KAAKD,KAAL,CAAWE,CAAlD,EAAqDO,OAArD,CAA6D;AAC3DC,0BAAgBL,eAD2C;AAE3DM,yBAAe,IAF4C;AAG3DC,wBAAc,IAH6C;AAI3DC,0BAAgB;AAJ2C,SAA7D,EAMCT,IAND,CAMM,gBAAQ;AACZ,cAAIE,KAAKQ,MAAL,KAAgB,CAApB,EAAuB;AACrBP,oBAAQQ,IAAR;AACA,mBAAO,OAAKC,QAAZ;AACD;;AAEDD,eAAKE,IAAL,CAAUnB,QAAV;AACA,iBAAOiB,IAAP;AACD,SAdD,CADF;;AAiBA,YAAIT,KAAKQ,MAAL,KAAgB,CAApB,EAAuB,KAAKE,QAAL,GAAgBR,OAAhB;;AAEvB,YAAMZ,OAAO,SAAPA,IAAO,GAAM;AACjB,iBAAKsB,SAAL,CAAeX,KAAf,EAAsBC,OAAtB;AACD,SAFD;;AAIA,eAAO;AACLZ,oBADK;AAELD,kBAAQC,IAFH;AAGLQ,gBAAM,cAACe,EAAD,EAAKC,KAAL;AAAA,mBAAeZ,QAAQJ,IAAR,CAAae,EAAb,EAAiBC,KAAjB,CAAf;AAAA;AAHD,SAAP;AAzB6F,gCAApB1B,mBAAoB;AA8B9F;;;8BAESqB,I,EAAMP,O,EAAS;AACvB,UAAIO,IAAJ,EAAU;AACRA,aAAKM,KAAL;AACD,OAFD,MAEO,IAAIb,OAAJ,EAAa;AAClBA,gBAAQJ,IAAR,CAAa;AAAA,iBAAQW,KAAKM,KAAL,EAAR;AAAA,SAAb;AACD;AACF;;;;EA3CgC5B,a;;eAAdI,K","file":"Query.js","sourcesContent":["import AbstractQuery from '../store/AbstractQuery';\nimport RethinkStore from './RethinkStore';\n\ntype SubscribeReturnType = {\n  cancel: Function,\n  stop: Function,\n};\n\nexport default class Query extends AbstractQuery<RethinkStore> {\n  fetch(callback: ?Function): Promise {\n    return this.queryCallback(this.store.query(), this.store.r).run().then(callback);\n  }\n\n  _subscribe(callback: Function, _includeInitial = false, args: Array<any>): SubscribeReturnType {\n    let _feed;\n    let promise =\n      this.queryCallback(this.store.query(), this.store.r).changes({\n        includeInitial: _includeInitial,\n        includeStates: true,\n        includeTypes: true,\n        includeOffsets: true,\n      })\n      .then(feed => {\n        if (args.length === 0) {\n          _feed = feed;\n          delete this._promise;\n        }\n\n        feed.each(callback);\n        return feed;\n      });\n\n    if (args.length === 0) this._promise = promise;\n\n    const stop = () => {\n      this.closeFeed(_feed, promise);\n    };\n\n    return {\n      stop,\n      cancel: stop,\n      then: (cb, errCb) => promise.then(cb, errCb),\n    };\n  }\n\n  closeFeed(feed, promise) {\n    if (feed) {\n      feed.close();\n    } else if (promise) {\n      promise.then(feed => feed.close());\n    }\n  }\n}\n"]}