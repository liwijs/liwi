{"version":3,"sources":["../../src/rethinkdb/RethinkConnection.js"],"names":["Logger","rethinkDB","AbstractConnection","logger","RethinkConnection","config","Map","has","set","Error","connect","host","get","port","db","options","info","_connection","buffer","max","getPoolMaster","on","healthy","getConnection","Promise","resolve","reject","warn","drain","then","_connecting","close"],"mappings":";;;;;;;;;;;;AAAA,OAAOA,MAAP,MAAmB,oBAAnB;AACA,OAAOC,SAAP,MAAsB,eAAtB;AACA,OAAOC,kBAAP,MAA+B,6BAA/B;;AAEA,IAAMC,SAAS,IAAIH,MAAJ,CAAW,8BAAX,CAAf;;IAEqBI,iB;;;AAKnB,6BAAYC,MAAZ,EAAyB;AAAA,YAAbA,MAAa,EAALC,GAAK;;AAAA;;AAAA;;AAGvB,QAAI,CAACD,OAAOE,GAAP,CAAW,MAAX,CAAL,EAAyB;AACvBF,aAAOG,GAAP,CAAW,MAAX,EAAmB,WAAnB;AACD;AACD,QAAI,CAACH,OAAOE,GAAP,CAAW,MAAX,CAAL,EAAyB;AACvBF,aAAOG,GAAP,CAAW,MAAX,EAAmB,OAAnB;AACD;AACD,QAAI,CAACH,OAAOE,GAAP,CAAW,UAAX,CAAL,EAA6B;AAC3B,YAAM,IAAIE,KAAJ,CAAU,yBAAV,CAAN;AACD;;AAED,UAAKC,OAAL,CAAa;AACXC,YAAMN,OAAOO,GAAP,CAAW,MAAX,CADK;AAEXC,YAAMR,OAAOO,GAAP,CAAW,MAAX,CAFK;AAGXE,UAAIT,OAAOO,GAAP,CAAW,UAAX;AAHO,KAAb;AAbuB;AAkBxB;;;;4BAEOG,O,EAAiB;AAAA;;AAAA,cAAjBA,OAAiB;;AACvBZ,aAAOa,IAAP,CAAY,YAAZ,EAA0BD,OAA1B;;AAEA,WAAKE,WAAL,GAAmBhB,uBACdc,OADc;AAEjBG,gBAAQ,EAFS;AAGjBC,aAAK;AAHY,SAAnB;;AAMA,WAAKF,WAAL,CAAiBG,aAAjB,GAAiCC,EAAjC,CAAoC,SAApC,EAA+C,UAACC,OAAD,EAAa;AAC1D,YAAIA,YAAY,IAAhB,EAAsB;AACpB,iBAAKC,aAAL,GAAqB;AAAA,mBAAMC,QAAQC,OAAR,CAAgB,OAAKR,WAArB,CAAN;AAAA,WAArB;AACAd,iBAAOa,IAAP,CAAY,SAAZ;AACD,SAHD,MAGO;AACL,iBAAKO,aAAL,GAAqB;AAAA,mBAAMC,QAAQE,MAAR,CAAe,IAAIjB,KAAJ,CAAU,wBAAV,CAAf,CAAN;AAAA,WAArB;AACAN,iBAAOwB,IAAP,CAAY,aAAZ;AACD;AACF,OARD;;AAUA,WAAKJ,aAAL,GAAqB;AAAA,eAAMC,QAAQC,OAAR,CAAgB,OAAKR,WAArB,CAAN;AAAA,OAArB;AACD;;;oCAEwB;AAAA;AACvB,cAAM,IAAIR,KAAJ,CAAU,gBAAV,CAAN;AADuB;AAExB;;;4BAEO;AAAA;;AACN,WAAKc,aAAL,GAAqB;AAAA,eAAMC,QAAQE,MAAR,CAAe,IAAIjB,KAAJ,CAAU,mBAAV,CAAf,CAAN;AAAA,OAArB;AACA,UAAI,KAAKQ,WAAT,EAAsB;AACpB,eAAO,KAAKA,WAAL,CAAiBG,aAAjB,GAAiCQ,KAAjC,GAAyCC,IAAzC,CAA8C,YAAM;AACzD1B,iBAAOa,IAAP,CAAY,mBAAZ;AACA,iBAAKC,WAAL,GAAmB,IAAnB;AACD,SAHM,CAAP;AAID,OALD,MAKO,IAAI,KAAKa,WAAT,EAAsB;AAC3B,eAAO,KAAKP,aAAL,GAAqBM,IAArB,CAA0B;AAAA,iBAAM,OAAKE,KAAL,EAAN;AAAA,SAA1B,CAAP;AACD;AACF;;;;EA7D4C7B,kB;;eAA1BE,iB","file":"RethinkConnection.js","sourcesContent":["import Logger from 'nightingale-logger';\nimport rethinkDB from 'rethinkdbdash';\nimport AbstractConnection from '../store/AbstractConnection';\n\nconst logger = new Logger('liwi.mongo.RethinkConnection');\n\nexport default class RethinkConnection extends AbstractConnection {\n  _connection: Object|null;\n  _connecting: boolean|null;\n  connectionFailed: boolean;\n\n  constructor(config: Map) {\n    super();\n\n    if (!config.has('host')) {\n      config.set('host', 'localhost');\n    }\n    if (!config.has('port')) {\n      config.set('port', '28015');\n    }\n    if (!config.has('database')) {\n      throw new Error('Missing config database');\n    }\n\n    this.connect({\n      host: config.get('host'),\n      port: config.get('port'),\n      db: config.get('database'),\n    });\n  }\n\n  connect(options: Object) {\n    logger.info('connecting', options);\n\n    this._connection = rethinkDB({\n      ...options,\n      buffer: 20,\n      max: 100,\n    });\n\n    this._connection.getPoolMaster().on('healthy', (healthy) => {\n      if (healthy === true) {\n        this.getConnection = () => Promise.resolve(this._connection);\n        logger.info('healthy');\n      } else {\n        this.getConnection = () => Promise.reject(new Error('Connection not healthy'));\n        logger.warn('not healthy');\n      }\n    });\n\n    this.getConnection = () => Promise.resolve(this._connection);\n  }\n\n  getConnection(): Promise {\n    throw new Error('call connect()');\n  }\n\n  close() {\n    this.getConnection = () => Promise.reject(new Error('Connection closed'));\n    if (this._connection) {\n      return this._connection.getPoolMaster().drain().then(() => {\n        logger.info('connection closed');\n        this._connection = null;\n      });\n    } else if (this._connecting) {\n      return this.getConnection().then(() => this.close());\n    }\n  }\n}\n"]}