{"version":3,"sources":["../../src/rest-websocket/_next.js"],"names":[],"mappings":"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","file":"_next.js","sourcesContent":["import Logger from 'nightingale-logger';\n\nconst MAX_OPENED_CURSORS = 5;\nconst logger = new Logger('liwi.rest-websocket');\n\nexport default function init(io, restService) {\n    io.on('connection', socket => {\n        let openCursors = new Map();\n        let timeouts = new Map();\n        let activeListeners = new Map();\n\n        const closeCursor = (id) => {\n            clearTimeout(timeouts[id]);\n            timeouts.delete(id);\n            openCursors[id].close();\n            openCursors.delete(id);\n        };\n\n        socket.on('disconnect', () => {\n            openCursors.forEach(cursor => cursor.close());\n            timeouts.forEach(timeout => clearTimeout(timeout));\n            activeListeners.forEach(listener => listener.close());\n\n            openCursors = timeouts = activeListeners = null;\n        });\n\n        let nextIdCursor = 1;\n\n        socket.on('rest', ({ type, restName }: { type: string, restName: string }, args: Array, callback: Function) => {\n            logger.info('rest', { type, restName, args });\n            switch (type) {\n                case 'createCursor': {\n                    if (openCursors.size > MAX_OPENED_CURSORS) return callback('too many cursors');\n\n                    const id = nextIdCursor++;\n                    const [options] = args;\n                    const cursor = restService.createCursor(restName, options);\n                    if (!cursor) return callback('failed to create cursor');\n\n                    timeouts.set(id, setTimeout(() => {\n                        logger.warn('socket closed by timeout', { id, restName });\n                        closeCursor(id);\n                    }));\n\n                    return callback(null, id);\n                }\n\n                case 'cursor toArray': {\n                    const [options] = args;\n                    return restService.createCursor(restName, options)\n                        .then(cursor => cursor.toArray())\n                        .then(results => callback(null, results))\n                        .catch(err => callback(err.message));\n                }\n\n                case 'cursor': {\n                    const [{ type: typeCursorAction, id: idCursor }, cursorArgs] = args;\n\n                    const cursor = openCursors.get(idCursor);\n                    if (!cursor) return callback(`failed to find cursor \"${idCursor}\"`);\n                    switch (typeCursorAction) {\n                        case 'close':\n                            closeCursor(idCursor);\n                            return callback();\n\n                        case 'advance':\n                        case 'next':\n                        case 'count':\n                            return cursor[type](...cursorArgs)\n                                .then(result => callback(null, result))\n                                .catch(err => callback(err.message || err));\n                            /* cursor.next().then((key) => {\n                                if (!key) return callback(null);\n                                return cursor.result();\n                            }).then(result => {\n                                    response(null, restService.transform(data));\n                                });\n                            }, () => {\n                                response(null);\n                            }); */\n\n                        default:\n                            callback(`Unknown command: \"${type}\"`);\n                    }\n\n                    break;\n                }\n\n                case 'insertOne':\n                case 'updateOne':\n                case 'updateSeveral':\n                case 'partialUpdateByKey':\n                case 'partialUpdateOne':\n                case 'partialUpdateMany':\n                case 'deleteByKey':\n                case 'deleteOne':\n                case 'findOne':\n                    return restService[type](restName, ...args)\n                        .then(result => callback(null, result))\n                        .catch(err => callback(err.message || err));\n\n                default:\n                    callback(`Unknown command: \"${type}\"`);\n            }\n        });\n    });\n}\n"]}