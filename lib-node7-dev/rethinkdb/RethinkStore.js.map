{"version":3,"sources":["../../src/rethinkdb/RethinkStore.js"],"names":["RethinkStore","constructor","connection","tableName","keyPath","_tableName","r","_connection","table","createQuery","query","_query","criteria","sort","filter","Object","keys","forEach","key","orderBy","desc","create","tableCreate","then","insertOne","object","created","Date","insert","inserted","generated_keys","generatedKeys","Error","id","updateOne","replaceOne","updated","get","replace","upsertOne","conflict","run","replaceSeveral","objects","Promise","all","map","partialUpdateByKey","partialUpdate","update","partialUpdateOne","returnChanges","res","changes","new_val","partialUpdateMany","deleteByKey","delete","cursor","findAll","findByKey","findOne","next","catch"],"mappings":"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","file":"RethinkStore.js","sourcesContent":["import RethinkConnection from './RethinkConnection';\nimport AbstractStore from '../store/AbstractStore';\nimport Query from './Query';\n// import RethinkCursor from './RethinkCursor';\nimport type { InsertType, UpdateType, ResultType } from '../types';\n\nexport default class RethinkStore extends AbstractStore<RethinkConnection> {\n  tableName: string;\n  keyPath = 'id';\n\n  constructor(connection: RethinkConnection, tableName: string) {\n    super(connection);\n    this._tableName = tableName;\n    this.r = this.connection._connection;\n  }\n\n  table() {\n    return this.r.table(this._tableName);\n  }\n\n  createQuery(query) {\n    return new Query(this, query);\n  }\n\n  query() {\n    return this.table();\n  }\n\n  _query(criteria: ?Object, sort: ?Object) {\n    const query = this.table();\n\n    if (criteria) {\n      query.filter(criteria);\n    }\n\n    if (sort) {\n      Object.keys(sort).forEach((key) => {\n        if (sort[key] === -1) {\n          query.orderBy(this.r.desc(key));\n        } else {\n          query.orderBy(key);\n        }\n      });\n    }\n\n    return query;\n  }\n\n  create(): Promise<void> {\n    return this.r.tableCreate(this._tableName).then(() => null);\n  }\n\n  insertOne(object: InsertType): Promise<ResultType> {\n    if (!object.created) object.created = new Date();\n\n    return this.table().insert(object)\n      .then(({ inserted, generated_keys: generatedKeys }) => {\n        if (inserted !== 1) throw new Error('Could not insert');\n        if (object.id == null) {\n          object.id = generatedKeys[0];\n        }\n      })\n      .then(() => object);\n  }\n\n  updateOne(object) {\n    return this.replaceOne(object);\n  }\n\n  replaceOne(object: InsertType): Promise<ResultType> {\n    if (!object.created) object.created = new Date();\n    if (!object.updated) object.updated = new Date();\n\n    return this.table().get(object.id).replace(object)\n      .then(() => object);\n  }\n\n  upsertOne(object: UpdateType): Promise<ResultType> {\n    if (!object.updated) object.updated = new Date();\n\n    return this.table().insert(object, { conflict: 'replace' }).run()\n      .then(() => object);\n  }\n\n  replaceSeveral(objects: Array<InsertType>): Promise<Array<ResultType>> {\n    return Promise.all(objects.map(object => this.replaceOne(object)));\n  }\n\n  partialUpdateByKey(key: any, partialUpdate: Object): Promise<void> {\n    return this.table().get(key).update(partialUpdate).run();\n  }\n\n  partialUpdateOne(object: ResultType, partialUpdate: UpdateType): Promise<ResultType> {\n    return this.table().get(object.id).update(partialUpdate, { returnChanges: true })\n      .then(res => res.changes.new_val);\n  }\n\n  partialUpdateMany(criteria, partialUpdate: Object): Promise<void> {\n    return this.table().filter(criteria).update(partialUpdate).run();\n  }\n\n  deleteByKey(key: any): Promise<void> {\n    return this.table().get(key).delete().run();\n  }\n\n  cursor(query, sort: ?Object) { // : Promise<RethinkCursor<ModelType>> {\n    if (sort) throw new Error('sort is not supported');\n    throw new Error('Not Supported yet, please use query().run({ cursor: true })');\n  }\n\n  findAll(): Promise<void> {\n    throw new Error('Not supported, please use query().run()');\n  }\n\n  findByKey(key: any): Promise<?ResultType> {\n    return this.table().get(key).run();\n  }\n\n  findOne(query): Promise<?ResultType> {\n    return query.run({ cursor: true }).then(cursor => cursor.next().catch(err => null));\n  }\n}\n"]}