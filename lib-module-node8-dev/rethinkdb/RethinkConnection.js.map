{"version":3,"sources":["../../src/rethinkdb/RethinkConnection.js"],"names":["Logger","rethinkDB","AbstractConnection","logger","RethinkConnection","constructor","config","has","set","Error","connect","host","get","port","db","options","info","_connection","buffer","max","getPoolMaster","on","healthy","getConnection","Promise","resolve","reject","warn","close","drain","then","_connecting"],"mappings":";;AAAA,OAAOA,MAAP;AACA,OAAOC,SAAP,MAAsB,eAAtB;AACA,OAAOC,kBAAP,MAA+B,6BAA/B;;;AAEA,MAAMC,SAAS,IAAIH,MAAJ,CAAW,kCAAX,CAAf;;IAEqBI,iB,GAAN,cAAgCF,kBAAhC,CAAmD;;AAKhEG,cAAYC,MAAZ,EAAkD;AAAA,sBAAhC,aAAM,UAAN,EAAc,oBAAS,UAAT,CAAd,CAAgC;;AAShD,uDARA,OAQA,EANKA,OAAOC,GAAP,CAAW,MAAX,CAML,IALED,OAAOE,GAAP,CAAW,MAAX,EAAmB,WAAnB,CAKF,EAHKF,OAAOC,GAAP,CAAW,MAAX,CAGL,IAFED,OAAOE,GAAP,CAAW,MAAX,EAAmB,OAAnB,CAEF,EAAI,CAACF,OAAOC,GAAP,CAAW,UAAX,CAAL,EACE,MAAM,IAAIE,KAAJ,CAAU,yBAAV,CAAN;;AAGF,SAAKC,OAAL,CAAa;AACXC,YAAML,OAAOM,GAAP,CAAW,MAAX,CADK;AAEXC,YAAMP,OAAOM,GAAP,CAAW,MAAX,CAFK;AAGXE,UAAIR,OAAOM,GAAP,CAAW,UAAX;AAHO,KAAb,CAbgD;AAkBjD;;AAEDF,UAAQK,OAAR,EAAyB;AAAA,uBAAV,UAAU;;AAAA,sDACvBZ,OAAOa,IAAP,CAAY,YAAZ,EAA0BD,OAA1B,CADuB,EAGvB,KAAKE,WAAL,GAAmBhB,uBACdc,OADc;AAEjBG,cAAQ,EAFS;AAGjBC,WAAK;AAHY,OAHI,EASvB,KAAKF,WAAL,CAAiBG,aAAjB,GAAiCC,EAAjC,CAAoC,SAApC,EAA+CC,WAAW;AACpDA,kBAAY,IADwC,IAEtD,KAAKC,aAAL,GAAqB,MAAMC,QAAQC,OAAR,CAAgB,KAAKR,WAArB,CAF2B,EAGtDd,OAAOa,IAAP,CAAY,SAAZ,CAHsD,KAKtD,KAAKO,aAAL,GAAqB,MAAMC,QAAQE,MAAR,CAAe,IAAIjB,KAAJ,CAAU,wBAAV,CAAf,CAL2B,EAMtDN,OAAOwB,IAAP,CAAY,aAAZ,CANsD;AAQzD,KARD,CATuB,EAmBvB,KAAKJ,aAAL,GAAqB,MAAMC,QAAQC,OAAR,CAAgB,KAAKR,WAArB,CAnBJ;AAoBxB;;AAEDM,kBAA+B;AAAA,aAAN,QAAM;;AAC7B,UAAM,IAAId,KAAJ,CAAU,gBAAV,CAAN;AACD;;AAEDmB,UAAQ;AAAA,YACN,KAAKL,aAAL,GAAqB,MAAMC,QAAQE,MAAR,CAAe,IAAIjB,KAAJ,CAAU,mBAAV,CAAf,CADrB,EAEF,KAAKQ,WAFH,IAGG,KAAKA,WAAL,CAAiBG,aAAjB,GAAiCS,KAAjC,GAAyCC,IAAzC,CAA8C,MAAM;AACzD3B,aAAOa,IAAP,CAAY,mBAAZ,CADyD,EAEzD,KAAKC,WAAL,GAAmB,IAFsC;AAG1D,KAHM,CAHH,GAOK,KAAKc,WAPV,GAQG,KAAKR,aAAL,GAAqBO,IAArB,CAA0B,MAAM,KAAKF,KAAL,EAAhC,CARH;AAUP;AA7D+D,C;SAA7CxB,iB","file":"RethinkConnection.js","sourcesContent":["import Logger from 'nightingale-logger/src';\nimport rethinkDB from 'rethinkdbdash';\nimport AbstractConnection from '../store/AbstractConnection';\n\nconst logger = new Logger('liwi:rethinkdb:RethinkConnection');\n\nexport default class RethinkConnection extends AbstractConnection {\n  _connection: any;\n  _connecting: boolean | null;\n  connectionFailed: boolean;\n\n  constructor(config: Map<string, string | number>) {\n    super();\n\n    if (!config.has('host')) {\n      config.set('host', 'localhost');\n    }\n    if (!config.has('port')) {\n      config.set('port', '28015');\n    }\n    if (!config.has('database')) {\n      throw new Error('Missing config database');\n    }\n\n    this.connect({\n      host: config.get('host'),\n      port: config.get('port'),\n      db: config.get('database'),\n    });\n  }\n\n  connect(options: Object) {\n    logger.info('connecting', options);\n\n    this._connection = rethinkDB({\n      ...options,\n      buffer: 20,\n      max: 100,\n    });\n\n    this._connection.getPoolMaster().on('healthy', healthy => {\n      if (healthy === true) {\n        this.getConnection = () => Promise.resolve(this._connection);\n        logger.info('healthy');\n      } else {\n        this.getConnection = () => Promise.reject(new Error('Connection not healthy'));\n        logger.warn('not healthy');\n      }\n    });\n\n    this.getConnection = () => Promise.resolve(this._connection);\n  }\n\n  getConnection(): Promise<void> {\n    throw new Error('call connect()');\n  }\n\n  close() {\n    this.getConnection = () => Promise.reject(new Error('Connection closed'));\n    if (this._connection) {\n      return this._connection.getPoolMaster().drain().then(() => {\n        logger.info('connection closed');\n        this._connection = null;\n      });\n    } else if (this._connecting) {\n      return this.getConnection().then(() => this.close());\n    }\n  }\n}\n"]}