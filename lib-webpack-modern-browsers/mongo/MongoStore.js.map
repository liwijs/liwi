{"version":3,"sources":["../../src/mongo/MongoStore.js"],"names":[],"mappings":"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","file":"MongoStore.js","sourcesContent":["import { ObjectID } from 'mongodb';\nimport Collection from 'mongodb/lib/collection';\nimport Db from 'mongodb/lib/db';\nimport MongoConnection from './MongoConnection';\nimport AbstractStore from '../store/AbstractStore';\nimport MongoCursor from './MongoCursor';\n\nexport default class MongoStore<ModelType> extends AbstractStore<MongoConnection> {\n  _collection: Collection|Promise<Collection>;\n  keyPath = '_id';\n\n  constructor(connection: MongoConnection, collectionName: string) {\n    super(connection);\n\n    if (!collectionName) {\n      throw new Error(`Invalid collectionName: \"${collectionName}\"`);\n    }\n\n    this._collection = connection.getConnection()\n            .then((db: Db) => this._collection = db.collection(collectionName));\n  }\n\n  get collection(): Promise<Collection> {\n    if (this.connection.connectionFailed) {\n      return Promise.reject(new Error('MongoDB connection failed'));\n    }\n\n    return Promise.resolve(this._collection);\n  }\n\n  insertOne(object: ModelType): Promise<ModelType> {\n    if (!object._id) {\n      object._id = (new ObjectID()).toString();\n    }\n    if (!object.created) {\n      object.created = new Date();\n    }\n\n    return this.collection\n            .then(collection => collection.insertOne(object))\n            .then(({ result, connection, ops }) => {\n              if (!result.ok || result.n !== 1) {\n                throw new Error('Fail to insert');\n              }\n            })\n            .then(() => object);\n  }\n\n  updateOne(object: ModelType): Promise<ModelType> {\n    if (!object.updated) {\n      object.updated = new Date();\n    }\n\n    return this.collection\n            .then(collection => collection.updateOne({ _id: object._id }, object))\n            .then(() => object);\n  }\n\n  upsertOne(object: ModelType): Promise<ModelType> {\n    if (!object.updated) {\n      object.updated = new Date();\n    }\n\n    return this.collection\n            .then(collection => (\n              collection.updateOne({ _id: object._id }, { $set: object }, { upsert: true })\n            ))\n            .then(() => object);\n  }\n\n  updateSeveral(objects: Array<ModelType>): Promise<Array<ModelType>> {\n    return Promise.all(objects.map(object => this.updateOne(object)));\n  }\n\n  _partialUpdate(partialUpdate: Object) {\n        // https://docs.mongodb.com/manual/reference/operator/update/\n        // if has a mongo operator\n    if (Object.keys(partialUpdate).some(key => key[0] === '$')) {\n      return partialUpdate;\n    } else {\n      return { $set: partialUpdate };\n    }\n  }\n\n  partialUpdateByKey(key: any, partialUpdate: Object): Promise {\n    partialUpdate = this._partialUpdate(partialUpdate);\n    return this.collection\n            .then(collection => collection.updateOne({ _id: key }, partialUpdate));\n  }\n\n  partialUpdateOne(object: ModelType, partialUpdate: Object): Promise<ModelType> {\n    partialUpdate = this._partialUpdate(partialUpdate);\n    return this.partialUpdateByKey(object._id, partialUpdate)\n            .then(res => this.findByKey(object._id));\n  }\n\n  partialUpdateMany(criteria, partialUpdate: Object): Promise {\n    partialUpdate = this._partialUpdate(partialUpdate);\n    return this.collection\n            .then(collection => collection.updateMany(criteria, partialUpdate))\n            .then(res => null); // TODO return updated object\n  }\n\n  deleteByKey(key: any): Promise {\n    return this.collection\n            .then(collection => collection.removeOne({ _id: key }))\n            .then(() => null);\n  }\n\n\n  cursor(criteria: ?Object, sort: ?Object): Promise<MongoCursor<ModelType>> {\n    return this.collection\n            .then(collection => collection.find(criteria))\n            .then(sort && (cursor => cursor.sort(sort)))\n            .then(cursor => new MongoCursor(this, cursor));\n  }\n\n  findByKey(key: any) {\n    return this.findOne({ _id: key });\n  }\n\n  findOne(criteria: Object, sort: ?Object): Promise<Object> {\n    return this.collection\n            .then(collection => collection.find(criteria))\n            .then(sort && (cursor => cursor.sort(sort)))\n            .then(cursor => cursor.limit(1).next());\n  }\n}\n"]}