{"version":3,"sources":["../../src/websocket-client/Query.js"],"names":["Logger","AbstractQuery","WebsocketStore","decode","logger","Query","store","key","callback","emit","then","_includeInitial","args","eventName","restName","listener","err","result","decodedResult","debug","connection","on","_stopEmitSubscribe","promise","emitSubscribe","stopEmitSubscribe","info","catch","off","stop","cancel","Promise","resolve","cb"],"mappings":";;;;;;;;AAAA,OAAOA,MAAP,MAAmB,oBAAnB;AACA,OAAOC,aAAP,MAA0B,wBAA1B;AACA,OAAOC,cAAP,MAA2B,kBAA3B;AACA,SAASC,MAAT,QAAuB,kBAAvB;;;AAEA,wDAA2B,SACzB,qBAAQ,YAAR,CADyB,EAEzB,mBAAM,YAAN,CAFyB,CAA3B;;;AAKA,IAAMC,SAAS,IAAIJ,MAAJ,CAAW,6BAAX,CAAf;;IAEqBK,K;;;AACnB,iBAAYC,KAAZ,EAAmCC,GAAnC,EAAgD;AAAA;;AAAA,qBAA/B,qBAA+B;;AAAA,mBAAV,UAAU;;AAAA;AAAA;;AAAA,8GACxCD,KADwC;;AAAA,gCADD,qBACC;;AAE9C,UAAKC,GAAL,GAAWA,GAAX;AAF8C;AAG/C;;;;0BAEKC,Q,EAAmC;AAAA,0BAA3B,WAAG,YAAH,CAA2B;;AAAA,iCAAL,OAAK;;AAAA;;AACvC,aAAO,KAAKF,KAAL,CAAWG,IAAX,CAAgB,OAAhB,EAAyB,KAAKF,GAA9B,EAAmCG,IAAnC,CAAwCF,QAAxC,CAAP;AAAA;AAAA;AACD;;;+BAEUA,Q,EAAoF;AAAA;;AAAA,UAAhEG,eAAgE,uEAA9C,KAA8C;;AAAA,UAAvCC,IAAuC;;AAAA,2BAA5E,YAA4E;;AAAA,sBAAnC,QAAQ,OAAR,CAAmC;;AAAA,kCAApB,mBAAoB;;AAAA;AAAA;;AAC7F,UAAMC,2BAAyB,KAAKP,KAAL,CAAWQ,QAApC,SAAgD,KAAKP,GAA3D;AACA,UAAMQ,WAAW,SAAXA,QAAW,CAACC,GAAD,EAAMC,MAAN,EAAiB;AAChC,YAAMC,gBAAgBD,UAAUd,OAAOc,MAAP,CAAhC;AACiBb,eAAOe,KAAP,CAAaN,SAAb,EAAwB,EAAEI,cAAF,EAAUC,4BAAV,EAAxB;AACjBV,iBAASQ,GAAT,EAAcE,aAAd;AACD,OAJD;AAKA,WAAKZ,KAAL,CAAWc,UAAX,CAAsBC,EAAtB,CAAyBR,SAAzB,EAAoCE,QAApC;;AAEA,UAAIO,2BAAJ;AACA,UAAIC,UAAU,KAAKjB,KAAL,CACXkB,aADW,CACGb,kBAAkB,mBAAlB,GAAwC,WAD3C,EACwD,KAAKJ,GAD7D,EACkEM,SADlE,EAC6ED,IAD7E,EAEXF,IAFW,CAEN,6BAAqB;AACzBY,6BAAqBG,iBAArB;AACArB,eAAOsB,IAAP,CAAY,YAAZ;AACD,OALW,EAMXC,KANW,CAML,eAAO;AACZ,eAAKrB,KAAL,CAAWc,UAAX,CAAsBQ,GAAtB,CAA0Bf,SAA1B,EAAqCE,QAArC;AACA,cAAMC,GAAN;AACD,OATW,CAAd;;AAWA,UAAMa,OAAO,SAAPA,IAAO,GAAM;AACjB,YAAI,CAACN,OAAL,EAAc;AACdD;AACAC,gBAAQb,IAAR,CAAa,YAAM;AACjBa,oBAAU,IAAV;AACA,iBAAKjB,KAAL,CAAWc,UAAX,CAAsBQ,GAAtB,CAA0Bf,SAA1B,EAAqCE,QAArC;AACD,SAHD;AAID,OAPD;;AASA,iCAAO;AACLe,gBAAQD,IADH;AAELA,kBAFK;AAGLnB,cAAM;AAAA,iBAAMqB,QAAQC,OAAR,CAAgBT,OAAhB,EAAyBb,IAAzB,CAA8BuB,EAA9B,CAAN;AAAA;AAHD,OAAP;AAKD;;;;EA7CgChC,a;;SAAdI,K","file":"Query.js","sourcesContent":["import Logger from 'nightingale-logger';\nimport AbstractQuery from '../store/AbstractQuery';\nimport WebsocketStore from './WebsocketStore';\nimport { decode } from '../extended-json';\n\ntype SubscribeReturnType = {\n  cancel: Function,\n  stop: Function,\n};\n\nconst logger = new Logger('liwi:websocket-client:query');\n\nexport default class Query extends AbstractQuery<WebsocketStore> {\n  constructor(store: WebsocketStore, key: string) {\n    super(store);\n    this.key = key;\n  }\n\n  fetch(callback: ?Function): Promise<any> {\n    return this.store.emit('fetch', this.key).then(callback);\n  }\n\n  _subscribe(callback: Function, _includeInitial = false, args: Array<any>): SubscribeReturnType {\n    const eventName = `subscribe:${this.store.restName}.${this.key}`;\n    const listener = (err, result) => {\n      const decodedResult = result && decode(result);\n      if (!PRODUCTION) logger.debug(eventName, { result, decodedResult });\n      callback(err, decodedResult);\n    };\n    this.store.connection.on(eventName, listener);\n\n    let _stopEmitSubscribe;\n    let promise = this.store\n      .emitSubscribe(_includeInitial ? 'fetchAndSubscribe' : 'subscribe', this.key, eventName, args)\n      .then(stopEmitSubscribe => {\n        _stopEmitSubscribe = stopEmitSubscribe;\n        logger.info('subscribed');\n      })\n      .catch(err => {\n        this.store.connection.off(eventName, listener);\n        throw err;\n      });\n\n    const stop = () => {\n      if (!promise) return;\n      _stopEmitSubscribe();\n      promise.then(() => {\n        promise = null;\n        this.store.connection.off(eventName, listener);\n      });\n    };\n\n    return {\n      cancel: stop,\n      stop,\n      then: cb => Promise.resolve(promise).then(cb),\n    };\n  }\n}\n"]}