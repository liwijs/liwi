{"version":3,"sources":["../../src/rethinkdb/RethinkStore.js"],"names":["RethinkStore","constructor","connection","tableName","keyPath","_tableName","r","_connection","table","createQuery","query","_query","criteria","sort","filter","Object","keys","forEach","key","orderBy","desc","create","tableCreate","insertOne","object","created","Date","insert","then","inserted","generatedKeys","generated_keys","Error","id","updateOne","replaceOne","updated","get","replace","upsertOne","conflict","run","replaceSeveral","objects","Promise","all","map","partialUpdateByKey","partialUpdate","update","partialUpdateOne","returnChanges","res","changes","new_val","partialUpdateMany","deleteByKey","delete","cursor","findAll","findByKey","findOne","next","catch","err"],"mappings":";;;;;;AACA;;;;AACA;;;;;;AACA;;AAEe,MAAMA,YAAN,iCAAuE;;AAIpFC,cAAYC,UAAZ,EAA2CC,SAA3C,EAA8D;AAC5D,UAAMD,UAAN;AAD4D,SAF9DE,OAE8D,GAFpD,IAEoD;AAE5D,SAAKC,UAAL,GAAkBF,SAAlB;AACA,SAAKG,CAAL,GAAS,KAAKJ,UAAL,CAAgBK,WAAzB;AACD;;AAEDC,UAAQ;AACN,WAAO,KAAKF,CAAL,CAAOE,KAAP,CAAa,KAAKH,UAAlB,CAAP;AACD;;AAEDI,cAAYC,KAAZ,EAAmB;AACjB,WAAO,oBAAU,IAAV,EAAgBA,KAAhB,CAAP;AACD;;AAEDA,UAAQ;AACN,WAAO,KAAKF,KAAL,EAAP;AACD;;AAEDG,SAAOC,QAAP,EAA0BC,IAA1B,EAAyC;AACvC,UAAMH,QAAQ,KAAKF,KAAL,EAAd;;AAEA,QAAII,QAAJ,EAAc;AACZF,YAAMI,MAAN,CAAaF,QAAb;AACD;;AAED,QAAIC,IAAJ,EAAU;AACRE,aAAOC,IAAP,CAAYH,IAAZ,EAAkBI,OAAlB,CAA2BC,GAAD,IAAS;AACjC,YAAIL,KAAKK,GAAL,QAAJ,EAAsB;AACpBR,gBAAMS,OAAN,CAAc,KAAKb,CAAL,CAAOc,IAAP,CAAYF,GAAZ,CAAd;AACD,SAFD,MAEO;AACLR,gBAAMS,OAAN,CAAcD,GAAd;AACD;AACF,OAND;AAOD;;AAED,WAAOR,KAAP;AACD;;AAEDW,WAAkB;AAChB,WAAO,KAAKf,CAAL,CAAOgB,WAAP,CAAmB,KAAKjB,UAAxB,CAAP;AACD;;AAEDkB,YAAUC,MAAV,EAAiD;AAC/C,QAAI,CAACA,OAAOC,OAAZ,EAAqB;AACnBD,aAAOC,OAAP,GAAiB,IAAIC,IAAJ,EAAjB;AACD;;AAED,WAAO,KAAKlB,KAAL,GAAamB,MAAb,CAAoBH,MAApB,EACJI,IADI,CACC,QAAiD;AAAA,UAA9CC,QAA8C,QAA9CA,QAA8C;AAAA,UAApBC,aAAoB,QAApCC,cAAoC;;AACrD,UAAIF,aAAa,CAAjB,EAAoB,MAAM,IAAIG,KAAJ,CAAU,kBAAV,CAAN;AACpBR,aAAOS,EAAP,GAAYH,cAAc,CAAd,CAAZ;AACD,KAJI,EAKJF,IALI,CAKC,MAAMJ,MALP,CAAP;AAMD;;AAEDU,YAAUV,MAAV,EAAkB;AAChB,WAAO,KAAKW,UAAL,CAAgBX,MAAhB,CAAP;AACD;;AAEDW,aAAWX,MAAX,EAAkD;AAChD,QAAI,CAACA,OAAOY,OAAZ,EAAqB;AACnBZ,aAAOY,OAAP,GAAiB,IAAIV,IAAJ,EAAjB;AACD;;AAED,WAAO,KAAKlB,KAAL,GAAa6B,GAAb,CAAiBb,OAAOS,EAAxB,EAA4BK,OAA5B,CAAoCd,MAApC,EACJI,IADI,CACC,MAAMJ,MADP,CAAP;AAED;;AAEDe,YAAUf,MAAV,EAAiD;AAC/C,QAAI,CAACA,OAAOY,OAAZ,EAAqB;AACnBZ,aAAOY,OAAP,GAAiB,IAAIV,IAAJ,EAAjB;AACD;;AAED,WAAO,KAAKlB,KAAL,GAAamB,MAAb,CAAoBH,MAApB,EAA4B,EAAEgB,UAAU,SAAZ,EAA5B,EAAqDC,GAArD,GACJb,IADI,CACC,MAAMJ,MADP,CAAP;AAED;;AAEDkB,iBAAeC,OAAf,EAAqE;AACnE,WAAOC,QAAQC,GAAR,CAAYF,QAAQG,GAAR,CAAYtB,UAAU,KAAKW,UAAL,CAAgBX,MAAhB,CAAtB,CAAZ,CAAP;AACD;;AAEDuB,qBAAmB7B,GAAnB,EAA6B8B,aAA7B,EAA6D;AAC3D,WAAO,KAAKxC,KAAL,GAAa6B,GAAb,CAAiBnB,GAAjB,EAAsB+B,MAAtB,CAA6BD,aAA7B,EAA4CP,GAA5C,EAAP;AACD;;AAEDS,mBAAiB1B,MAAjB,EAAoCwB,aAApC,EAA+E;AAC7E,WAAO,KAAKxC,KAAL,GAAa6B,GAAb,CAAiBb,OAAOS,EAAxB,EAA4BgB,MAA5B,CAAmCD,aAAnC,EAAkD,EAAEG,eAAe,IAAjB,EAAlD,EACJvB,IADI,CACCwB,OAAOA,IAAIC,OAAJ,CAAYC,OADpB,CAAP;AAED;;AAEDC,oBAAkB3C,QAAlB,EAA4BoC,aAA5B,EAA4D;AAC1D,WAAO,KAAKxC,KAAL,GAAaM,MAAb,CAAoBF,QAApB,EAA8BqC,MAA9B,CAAqCD,aAArC,EAAoDP,GAApD,EAAP;AACD;;AAEDe,cAAYtC,GAAZ,EAA+B;AAC7B,WAAO,KAAKV,KAAL,GAAa6B,GAAb,CAAiBnB,GAAjB,EAAsBuC,MAAtB,GAA+BhB,GAA/B,EAAP;AACD;;AAEDiB,SAAO9C,QAAP,EAA0BC,IAA1B,EAAyC;AAAE;AACzC,UAAM,IAAImB,KAAJ,CAAU,6DAAV,CAAN;AACD;;AAED2B,UAAQ/C,QAAR,EAA2BC,IAA3B,EAAmD;AACjD,UAAMH,QAAQ,KAAKC,MAAL,CAAYC,QAAZ,EAAsBC,IAAtB,CAAd;AACA,WAAOH,MAAM+B,GAAN,EAAP;AACD;;AAEDmB,YAAU1C,GAAV,EAAoB;AAClB,WAAO,KAAKV,KAAL,GAAa6B,GAAb,CAAiBnB,GAAjB,EAAsBuB,GAAtB,EAAP;AACD;;AAEDoB,UAAQjD,QAAR,EAA0BC,IAA1B,EAA0D;AACxD,UAAMH,QAAQ,KAAKC,MAAL,CAAYC,QAAZ,EAAsBC,IAAtB,CAAd;AACA,WAAOH,MAAM+B,GAAN,CAAU,EAAEiB,QAAQ,IAAV,EAAV,EAA4B9B,IAA5B,CAAiC8B,UAAUA,OAAOI,IAAP,GAAcC,KAAd,CAAoBC,OAAO,IAA3B,CAA3C,CAAP;AACD;AAtHmF;kBAAjEhE,Y","file":"RethinkStore.js","sourcesContent":["import RethinkConnection from './RethinkConnection';\nimport AbstractStore from '../store/AbstractStore';\nimport Query from './Query';\n// import RethinkCursor from './RethinkCursor';\n\nexport default class RethinkStore<ModelType> extends AbstractStore<RethinkConnection> {\n  tableName: string;\n  keyPath = 'id';\n\n  constructor(connection: RethinkConnection, tableName: string) {\n    super(connection);\n    this._tableName = tableName;\n    this.r = this.connection._connection;\n  }\n\n  table() {\n    return this.r.table(this._tableName);\n  }\n\n  createQuery(query) {\n    return new Query(this, query);\n  }\n\n  query() {\n    return this.table();\n  }\n\n  _query(criteria: ?Object, sort: ?Object) {\n    const query = this.table();\n\n    if (criteria) {\n      query.filter(criteria);\n    }\n\n    if (sort) {\n      Object.keys(sort).forEach((key) => {\n        if (sort[key] === -1) {\n          query.orderBy(this.r.desc(key));\n        } else {\n          query.orderBy(key);\n        }\n      });\n    }\n\n    return query;\n  }\n\n  create(): Promise {\n    return this.r.tableCreate(this._tableName);\n  }\n\n  insertOne(object: ModelType): Promise<ModelType> {\n    if (!object.created) {\n      object.created = new Date();\n    }\n\n    return this.table().insert(object)\n      .then(({ inserted, generated_keys: generatedKeys }) => {\n        if (inserted !== 1) throw new Error('Could not insert');\n        object.id = generatedKeys[0];\n      })\n      .then(() => object);\n  }\n\n  updateOne(object) {\n    return this.replaceOne(object);\n  }\n\n  replaceOne(object: ModelType): Promise<ModelType> {\n    if (!object.updated) {\n      object.updated = new Date();\n    }\n\n    return this.table().get(object.id).replace(object)\n      .then(() => object);\n  }\n\n  upsertOne(object: ModelType): Promise<ModelType> {\n    if (!object.updated) {\n      object.updated = new Date();\n    }\n\n    return this.table().insert(object, { conflict: 'replace' }).run()\n      .then(() => object);\n  }\n\n  replaceSeveral(objects: Array<ModelType>): Promise<Array<ModelType>> {\n    return Promise.all(objects.map(object => this.replaceOne(object)));\n  }\n\n  partialUpdateByKey(key: any, partialUpdate: Object): Promise {\n    return this.table().get(key).update(partialUpdate).run();\n  }\n\n  partialUpdateOne(object: ModelType, partialUpdate: Object): Promise<ModelType> {\n    return this.table().get(object.id).update(partialUpdate, { returnChanges: true })\n      .then(res => res.changes.new_val);\n  }\n\n  partialUpdateMany(criteria, partialUpdate: Object): Promise {\n    return this.table().filter(criteria).update(partialUpdate).run();\n  }\n\n  deleteByKey(key: any): Promise {\n    return this.table().get(key).delete().run();\n  }\n\n  cursor(criteria: ?Object, sort: ?Object) { // : Promise<RethinkCursor<ModelType>> {\n    throw new Error('Not Supported yet, please use query().run({ cursor: true })');\n  }\n\n  findAll(criteria: ?Object, sort: ?Object): Promise {\n    const query = this._query(criteria, sort);\n    return query.run();\n  }\n\n  findByKey(key: any) {\n    return this.table().get(key).run();\n  }\n\n  findOne(criteria: Object, sort: ?Object): Promise<Object> {\n    const query = this._query(criteria, sort);\n    return query.run({ cursor: true }).then(cursor => cursor.next().catch(err => null));\n  }\n}\n"]}