{"version":3,"sources":["../../src/rethinkdb/Query.js"],"names":["Query","fetch","callback","queryCallback","store","query","run","then","fetchAndSubscribe","args","subscribe","Error","_subscribe","_includeInitial","length","_subscribers","Set","add","_feed","promise","changes","includeInitial","feed","_promise","each","stop","remove","_checkFeedClose","closeFeed","cancel","close"],"mappings":";;;;;;AAAA;;;;AACA;;;;;;AAOe,MAAMA,KAAN,iCAAgD;AAC7DC,QAAMC,QAAN,EAAoC;AAClC,WAAO,KAAKC,aAAL,CAAmB,KAAKC,KAAL,CAAWC,KAAX,EAAnB,EAAuCC,GAAvC,GAA6CC,IAA7C,CAAkDL,QAAlD,CAAP;AACD;;AAEDM,oBAAkBN,QAAlB,EAA+C;AAAA,sCAANO,IAAM;AAANA,UAAM;AAAA;;AAC7C,WAAO,KAAKC,SAAL,CAAeR,QAAf,EAAyB,IAAzB,EAA+BO,IAA/B,CAAP;AACD;;AAEDC,YAAUR,QAAV,EAAuC;AACrC,UAAM,IAAIS,KAAJ,CAAU,gCAAV,CAAN;;AADqC,uCAANF,IAAM;AAANA,UAAM;AAAA;;AAErC,WAAO,KAAKC,SAAL,CAAeR,QAAf,EAAyB,KAAzB,EAAgCO,IAAhC,CAAP;AACD;;AAEDG,aAAWV,QAAX,EAA+F;AAAA,QAAhEW,eAAgE,yDAA9C,KAA8C;;AAAA,QAAvCJ,IAAuC;;AAC7F,UAAM,IAAIE,KAAJ,CAAU,gCAAV,CAAN;AACA,QAAIF,KAAKK,MAAL,KAAgB,CAAhB,KAAsB,CAAC,KAAKC,YAAN,IAAsB,KAAKA,YAAL,CAAkBD,MAAlB,KAA6B,CAAzE,CAAJ,EAAiF;AAC/E,UAAI,CAAC,KAAKC,YAAV,EAAwB,KAAKA,YAAL,GAAoB,IAAIC,GAAJ,EAApB;AACxB,WAAKD,YAAL,CAAkBE,GAAlB,CAAsBf,QAAtB;AACD;;AAED,QAAIgB,KAAJ;AACA,QAAIC,UACF,KAAKhB,aAAL,CAAmB,KAAKC,KAAL,CAAWC,KAAX,EAAnB,EAAuCe,OAAvC,CAA+C,EAAEC,gBAAgBR,eAAlB,EAA/C,EACCN,IADD,CACMe,QAAQ;AACZ,UAAIb,KAAKK,MAAL,KAAgB,CAApB,EAAuB;AACrBI,gBAAQI,IAAR;AACA,aAAKJ,KAAL,GAAaI,IAAb;AACA,eAAO,KAAKC,QAAZ;AACD;AACDD,WAAKE,IAAL,CAAUtB,QAAV;AACD,KARD,CADF;;AAWA,QAAIO,KAAKK,MAAL,KAAgB,CAApB,EAAuB,KAAKS,QAAL,GAAgBJ,OAAhB;;AAEvB,UAAMM,OAAO,MAAM;AACjB,UAAIhB,KAAKK,MAAL,KAAgB,CAApB,EAAuB;AACrB,aAAKC,YAAL,CAAkBW,MAAlB,CAAyBxB,QAAzB;AACA,aAAKyB,eAAL;AACD,OAHD,MAGO;AACL,aAAKC,SAAL,CAAeV,KAAf,EAAsBC,OAAtB;AACD;AACF,KAPD;;AASA,WAAO,EAAEM,IAAF,EAAQI,QAAQJ,IAAhB,EAAP;AACD;;AAEDE,oBAAkB;AAChB,QAAI,CAAC,KAAKZ,YAAN,IAAsB,KAAKA,YAAL,CAAkBD,MAAlB,KAA6B,CAAvD,EAA0D;AACxD,WAAKc,SAAL,CAAe,KAAKV,KAApB,EAA2B,KAAKK,QAAhC;AACD;AACF;;AAEDK,YAAUN,IAAV,EAAgBH,OAAhB,EAAyB;AACvB,QAAIG,IAAJ,EAAU;AACRA,WAAKQ,KAAL;AACD,KAFD,MAEO,IAAIX,OAAJ,EAAa;AAClBA,cAAQZ,IAAR,CAAa,MAAMe,KAAKQ,KAAL,EAAnB;AACD;AACF;AA3D4D;kBAA1C9B,K","file":"Query.js","sourcesContent":["import AbstractQuery from '../store/AbstractQuery';\nimport RethinkStore from './RethinkStore';\n\ntype SubscribeReturnType = {\n  cancel: Function,\n  stop: Function,\n};\n\nexport default class Query extends AbstractQuery<RethinkStore> {\n  fetch(callback: ?Function): Promise {\n    return this.queryCallback(this.store.query()).run().then(callback);\n  }\n\n  fetchAndSubscribe(callback: Function, ...args) {\n    return this.subscribe(callback, true, args);\n  }\n\n  subscribe(callback: Function, ...args) {\n    throw new Error('Will be implemented next minor');\n    return this.subscribe(callback, false, args);\n  }\n\n  _subscribe(callback: Function, _includeInitial = false, args: Array<any>): SubscribeReturnType {\n    throw new Error('Will be implemented next minor');\n    if (args.length === 0 && (!this._subscribers || this._subscribers.length === 0)) {\n      if (!this._subscribers) this._subscribers = new Set();\n      this._subscribers.add(callback);\n    }\n\n    let _feed;\n    let promise =\n      this.queryCallback(this.store.query()).changes({ includeInitial: _includeInitial })\n      .then(feed => {\n        if (args.length === 0) {\n          _feed = feed;\n          this._feed = feed;\n          delete this._promise;\n        }\n        feed.each(callback);\n      });\n\n    if (args.length === 0) this._promise = promise;\n\n    const stop = () => {\n      if (args.length === 0) {\n        this._subscribers.remove(callback);\n        this._checkFeedClose();\n      } else {\n        this.closeFeed(_feed, promise);\n      }\n    };\n\n    return { stop, cancel: stop };\n  }\n\n  _checkFeedClose() {\n    if (!this._subscribers || this._subscribers.length === 0) {\n      this.closeFeed(this._feed, this._promise);\n    }\n  }\n\n  closeFeed(feed, promise) {\n    if (feed) {\n      feed.close();\n    } else if (promise) {\n      promise.then(() => feed.close());\n    }\n  }\n}\n"]}