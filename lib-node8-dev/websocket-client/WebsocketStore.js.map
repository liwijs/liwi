{"version":3,"sources":["../../src/websocket-client/WebsocketStore.js"],"names":["logger","WebsocketStore","constructor","websocket","restName","keyPath","Error","createQuery","key","debug","emit","type","args","connection","isDisconnected","json","then","result","emitSubscribe","registerOnConnect","on","off","isConnected","Promise","resolve","insertOne","object","updateOne","updateSeveral","objects","partialUpdateByKey","partialUpdate","partialUpdateOne","partialUpdateMany","criteria","deleteByKey","deleteOne","cursor","sort","findByKey","findOne","id"],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;;;;;;;AAEA,MAAMA,SAAS,gCAAW,uBAAX,CAAf;;AAEA,sFAA+B,6BAC7B,uCAAM,gCAAN,CAD6B,EAE7B,8CAAa,gCAAb,CAF6B,CAA/B;;;;IAKqBC,c,qBAAN,sCAA+E;;AAG5FC,cAAYC,SAAZ,EAAgDC,QAAhD,EAAkE;AAAA;AAAA,iBAHhC;AAGgC;;AAAA,wBAAV,8BAAU;;AAAA,6CAA7C,uBAA6C;;AAAA;;AAChE,UAAMD,SAAN;;AADgE,SAFlEE,OAEkE,GAFxD,IAEwD;AAAA;;AAAA,mDAHC,uBAGD;;AAGhE,QAAI,CAACD,QAAL,EAAe;AACb,YAAM,IAAIE,KAAJ,CAAW,sBAAqBF,QAAS,GAAzC,CAAN;AACD;;AAED,SAAKA,QAAL,GAAgBA,QAAhB;AACD;;AAEDG,cAAYC,GAAZ,EAAyB;AAAA,mBAAV,8BAAU;;AAAA;;AACvBR,WAAOS,KAAP,CAAa,aAAb,EAA4B,EAAED,GAAF,EAA5B;AACA,WAAO,oBAAU,IAAV,EAAgBA,GAAhB,CAAP;AACD;;AAEDE,OAAKC,IAAL,EAAW,GAAGC,IAAd,EAAoB;AAClBZ,WAAOS,KAAP,CAAa,MAAb,EAAqB,EAAEE,IAAF,EAAQC,IAAR,EAArB;AACA,QAAI,KAAKC,UAAL,CAAgBC,cAAhB,EAAJ,EAAsC;AACpC,YAAM,IAAIR,KAAJ,CAAU,4BAAV,CAAN;AACD;;AAED,WAAO,KAAKO,UAAL,CACJH,IADI,CACC,MADD,EACS;AACZC,UADY;AAEZP,gBAAU,KAAKA,QAFH;AAGZW,YAAM,0BAAOH,IAAP;AAHM,KADT,EAMJI,IANI,CAMCC,UAAUA,UAAU,0BAAOA,MAAP,CANrB,CAAP;AAOD;;AAEDC,gBAAcP,IAAd,EAAoB,GAAGC,IAAvB,EAA6B;AAC3B,UAAMF,OAAO,MAAM,KAAKA,IAAL,CAAUC,IAAV,EAAgB,GAAGC,IAAnB,CAAnB;AACA,UAAMO,oBAAoB,MAAM;AAC9B,WAAKN,UAAL,CAAgBO,EAAhB,CAAmB,SAAnB,EAA8BV,IAA9B;AACA,aAAO,MAAM,KAAKG,UAAL,CAAgBQ,GAAhB,CAAoB,SAApB,EAA+BX,IAA/B,CAAb;AACD,KAHD;;AAKA,QAAI,KAAKG,UAAL,CAAgBS,WAAhB,EAAJ,EAAmC;AACjC,aAAOZ,OAAOM,IAAP,CAAYG,iBAAZ,CAAP;AACD;;AAED,WAAOI,QAAQC,OAAR,CAAgBL,mBAAhB,CAAP;AACD;;AAEDM,YAAUC,MAAV,EAAiD;AAAA,sBAAjC,mFAAiC;;AAAA,qDAAX,mDAAW;;AAAA;;AAC/C,WAAO,KAAKhB,IAAL,CAAU,WAAV,EAAuBgB,MAAvB,CAAP;AACD;;AAEDC,YAAUD,MAAV,EAAiD;AAAA,uBAAjC,mFAAiC;;AAAA,sDAAX,mDAAW;;AAAA;;AAC/C,WAAO,KAAKhB,IAAL,CAAU,WAAV,EAAuBgB,MAAvB,CAAP;AACD;;AAEDE,gBAAcC,OAAd,EAAoE;AAAA,uBAA/C,4BAAQ,mFAAR,CAA+C;;AAAA,sDAAlB,4BAAM,mDAAN,CAAkB;;AAAA;;AAClE,WAAO,KAAKnB,IAAL,CAAU,eAAV,EAA2BmB,OAA3B,CAAP;AACD;;AAEDC,qBAAmBtB,GAAnB,EAA6BuB,aAA7B,EAAwE;AAAA,oBAAlD,2BAAkD;;AAAA,6BAA9B,8BAA8B;;AAAA,sDAAX,mDAAW;;AAAA;;AAAA;;AACtE,WAAO,KAAKrB,IAAL,CAAU,oBAAV,EAAgCF,GAAhC,EAAqCuB,aAArC,CAAP;AACD;;AAEDC,mBAAiBN,MAAjB,EAAoCK,aAApC,EAA+E;AAAA,uBAAxD,mFAAwD;;AAAA,8BAA9B,8BAA8B;;AAAA,sDAAX,mDAAW;;AAAA;;AAAA;;AAC7E,WAAO,KAAKrB,IAAL,CAAU,kBAAV,EAA8BgB,MAA9B,EAAsCK,aAAtC,CAAP;AACD;;AAEDE,oBAAkBC,QAAlB,EAA4BH,aAA5B,EAAkE;AAAA,8BAAzB,8BAAyB;;AAAA,sDAAN,4BAAM;;AAAA;;AAChE,WAAO,KAAKrB,IAAL,CAAU,mBAAV,EAA+BwB,QAA/B,EAAyCH,aAAzC,CAAP;AACD;;AAEDI,cAAY3B,GAAZ,EAAqC;AAAA,oBAAtB,2BAAsB;;AAAA,sDAAN,4BAAM;;AAAA;;AACnC,WAAO,KAAKE,IAAL,CAAU,aAAV,EAAyBF,GAAzB,CAAP;AACD;;AAED4B,YAAUV,MAAV,EAA4C;AAAA,uBAA5B,mFAA4B;;AAAA,sDAAN,4BAAM;;AAAA;;AAC1C,WAAO,KAAKhB,IAAL,CAAU,WAAV,EAAuBgB,MAAvB,CAAP;AACD;;AAEDW,SAAOH,QAAP,EAA0BI,IAA1B,EAA8E;AAAA,wBAA/D,+BAAG,8BAAH,CAA+D;;AAAA,oBAAhD,+BAAG,8BAAH,CAAgD;;AAAA,sDAA5B,qDAAgB,mDAAhB,CAA4B;;AAAA;;AAAA;;AAC5E,WAAOf,QAAQC,OAAR,CAAgB,8BAAoB,IAApB,EAA0B,EAAEU,QAAF,EAAYI,IAAZ,EAA1B,CAAhB,CAAP;AACD;;AAEDC,YAAU/B,GAAV,EAAoB;AAAA,oBAAP,2BAAO;;AAAA;;AAClB,WAAO,KAAKgC,OAAL,CAAa,EAAEC,IAAIjC,GAAN,EAAb,CAAP;AACD;;AAEDgC,UAAQN,QAAR,EAA0BI,IAA1B,EAA0D;AAAA,yBAA1C,8BAA0C;;AAAA,qBAA5B,+BAAG,8BAAH,CAA4B;;AAAA,uDAAR,8BAAQ;;AAAA;;AAAA;;AACxD,WAAO,KAAK5B,IAAL,CAAU,SAAV,EAAqBwB,QAArB,EAA+BI,IAA/B,CAAP;AACD;AAzF2F,C;kBAAzErC,c","file":"WebsocketStore.js","sourcesContent":["import Logger from 'nightingale-logger/src';\nimport AbstractStore from '../store/AbstractStore';\nimport WebsocketCursor from './WebsocketCursor';\nimport { encode, decode } from '../extended-json';\nimport Query from './Query';\n\nconst logger = new Logger('liwi:websocket-client');\n\ntype WebsocketConnectionType = {\n  emit: Function,\n  isConnected: Function,\n};\n\nexport default class WebsocketStore<ModelType> extends AbstractStore<WebsocketConnectionType> {\n  keyPath = 'id';\n\n  constructor(websocket: WebsocketConnectionType, restName: string) {\n    super(websocket);\n\n    if (!restName) {\n      throw new Error(`Invalid restName: \"${restName}\"`);\n    }\n\n    this.restName = restName;\n  }\n\n  createQuery(key: string) {\n    logger.debug('createQuery', { key });\n    return new Query(this, key);\n  }\n\n  emit(type, ...args) {\n    logger.debug('emit', { type, args });\n    if (this.connection.isDisconnected()) {\n      throw new Error('Websocket is not connected');\n    }\n\n    return this.connection\n      .emit('rest', {\n        type,\n        restName: this.restName,\n        json: encode(args),\n      })\n      .then(result => result && decode(result));\n  }\n\n  emitSubscribe(type, ...args) {\n    const emit = () => this.emit(type, ...args);\n    const registerOnConnect = () => {\n      this.connection.on('connect', emit);\n      return () => this.connection.off('connect', emit);\n    };\n\n    if (this.connection.isConnected()) {\n      return emit().then(registerOnConnect);\n    }\n\n    return Promise.resolve(registerOnConnect());\n  }\n\n  insertOne(object: ModelType): Promise<ModelType> {\n    return this.emit('insertOne', object);\n  }\n\n  updateOne(object: ModelType): Promise<ModelType> {\n    return this.emit('updateOne', object);\n  }\n\n  updateSeveral(objects: Array<ModelType>): Promise<Array<ModelType>> {\n    return this.emit('updateSeveral', objects);\n  }\n\n  partialUpdateByKey(key: any, partialUpdate: Object): Promise<ModelType> {\n    return this.emit('partialUpdateByKey', key, partialUpdate);\n  }\n\n  partialUpdateOne(object: ModelType, partialUpdate: Object): Promise<ModelType> {\n    return this.emit('partialUpdateOne', object, partialUpdate);\n  }\n\n  partialUpdateMany(criteria, partialUpdate: Object): Promise<void> {\n    return this.emit('partialUpdateMany', criteria, partialUpdate);\n  }\n\n  deleteByKey(key: any): Promise<void> {\n    return this.emit('deleteByKey', key);\n  }\n\n  deleteOne(object: ModelType): Promise<void> {\n    return this.emit('deleteOne', object);\n  }\n\n  cursor(criteria: ?Object, sort: ?Object): Promise<WebsocketCursor<ModelType>> {\n    return Promise.resolve(new WebsocketCursor(this, { criteria, sort }));\n  }\n\n  findByKey(key: any) {\n    return this.findOne({ id: key });\n  }\n\n  findOne(criteria: Object, sort: ?Object): Promise<Object> {\n    return this.emit('findOne', criteria, sort);\n  }\n}\n"]}