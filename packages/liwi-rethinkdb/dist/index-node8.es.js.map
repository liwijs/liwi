{"version":3,"file":"index-node8.es.js","sources":["../src/Query.js","../src/RethinkStore.js","../src/RethinkConnection.js"],"sourcesContent":["import { AbstractQuery } from 'liwi-store';\nimport RethinkStore from './RethinkStore';\n\ntype SubscribeReturnType = {\n  cancel: () => void,\n  stop: () => void,\n};\n\nexport default class Query extends AbstractQuery<RethinkStore> {\n  fetch(callback: ?Function): Promise<any> {\n    return this.queryCallback(this.store.query(), this.store.r)\n      .run()\n      .then(callback);\n  }\n\n  _subscribe(callback: Function, _includeInitial = false, args: Array<any>): SubscribeReturnType {\n    let _feed;\n    const promise = this.queryCallback(this.store.query(), this.store.r)\n      .changes({\n        includeInitial: _includeInitial,\n        includeStates: true,\n        includeTypes: true,\n        includeOffsets: true,\n      })\n      .then(feed => {\n        if (args.length === 0) {\n          _feed = feed;\n          delete this._promise;\n        }\n\n        feed.each(callback);\n        return feed;\n      });\n\n    if (args.length === 0) this._promise = promise;\n\n    const stop = () => {\n      this.closeFeed(_feed, promise);\n    };\n\n    return {\n      stop,\n      cancel: stop,\n      then: (cb, errCb) => promise.then(cb, errCb),\n    };\n  }\n\n  closeFeed(feed, promise) {\n    if (feed) {\n      feed.close();\n    } else if (promise) {\n      promise.then(feed => feed.close());\n    }\n  }\n}\n","import { AbstractStore, type InsertType, type UpdateType, type ResultType } from 'liwi-store';\nimport RethinkConnection from './RethinkConnection';\nimport Query from './Query';\n// import RethinkCursor from './RethinkCursor';\n\nexport default class RethinkStore extends AbstractStore<RethinkConnection> {\n  tableName: string;\n  keyPath = 'id';\n\n  constructor(connection: RethinkConnection, tableName: string) {\n    super(connection);\n    this._tableName = tableName;\n    this.r = this.connection._connection;\n  }\n\n  table() {\n    return this.r.table(this._tableName);\n  }\n\n  createQuery(query) {\n    return new Query(this, query);\n  }\n\n  query() {\n    return this.table();\n  }\n\n  _query(criteria: ?Object, sort: ?Object) {\n    const query = this.table();\n\n    if (criteria) {\n      query.filter(criteria);\n    }\n\n    if (sort) {\n      Object.keys(sort).forEach(key => {\n        if (sort[key] === -1) {\n          query.orderBy(this.r.desc(key));\n        } else {\n          query.orderBy(key);\n        }\n      });\n    }\n\n    return query;\n  }\n\n  create(): Promise<void> {\n    return this.r.tableCreate(this._tableName).then(() => null);\n  }\n\n  insertOne(object: InsertType): Promise<ResultType> {\n    if (!object.created) object.created = new Date();\n\n    return this.table()\n      .insert(object)\n      .then(({ inserted, generated_keys: generatedKeys }) => {\n        if (inserted !== 1) throw new Error('Could not insert');\n        if (object.id == null) {\n          // eslint-disable-next-line prefer-destructuring\n          object.id = generatedKeys[0];\n        }\n      })\n      .then(() => object);\n  }\n\n  updateOne(object) {\n    return this.replaceOne(object);\n  }\n\n  replaceOne(object: InsertType): Promise<ResultType> {\n    if (!object.created) object.created = new Date();\n    if (!object.updated) object.updated = new Date();\n\n    return this.table()\n      .get(object.id)\n      .replace(object)\n      .then(() => object);\n  }\n\n  upsertOne(object: UpdateType): Promise<ResultType> {\n    if (!object.updated) object.updated = new Date();\n\n    return this.table()\n      .insert(object, { conflict: 'replace' })\n      .run()\n      .then(() => object);\n  }\n\n  replaceSeveral(objects: Array<InsertType>): Promise<Array<ResultType>> {\n    return Promise.all(objects.map(object => this.replaceOne(object)));\n  }\n\n  partialUpdateByKey(key: any, partialUpdate: Object): Promise<void> {\n    return this.table()\n      .get(key)\n      .update(partialUpdate)\n      .run();\n  }\n\n  partialUpdateOne(object: ResultType, partialUpdate: UpdateType): Promise<ResultType> {\n    return this.table()\n      .get(object.id)\n      .update(partialUpdate, { returnChanges: true })\n      .then(res => res.changes[0].new_val);\n  }\n\n  partialUpdateMany(criteria, partialUpdate: Object): Promise<void> {\n    return this.table()\n      .filter(criteria)\n      .update(partialUpdate)\n      .run();\n  }\n\n  deleteByKey(key: any): Promise<void> {\n    return this.table()\n      .get(key)\n      .delete()\n      .run();\n  }\n\n  cursor(query, sort: ?Object) {\n    // : Promise<RethinkCursor<ModelType>> {\n    if (sort) throw new Error('sort is not supported');\n    throw new Error('Not Supported yet, please use query().run({ cursor: true })');\n  }\n\n  findAll(): Promise<void> {\n    throw new Error('Not supported, please use query().run()');\n  }\n\n  findByKey(key: any): Promise<?ResultType> {\n    return this.table()\n      .get(key)\n      .run();\n  }\n\n  findOne(query): Promise<?ResultType> {\n    return query.run({ cursor: true }).then(cursor => cursor.next().catch(err => null));\n  }\n\n  findValue(field: string, query): Promise<any> {\n    return query\n      .getField(field)\n      .run({ cursor: true })\n      .then(cursor => cursor.next().catch(err => null));\n  }\n}\n","import Logger from 'nightingale-logger';\nimport rethinkDB from 'rethinkdbdash';\nimport { AbstractConnection } from 'liwi-store';\n\nconst logger = new Logger('liwi:rethinkdb:RethinkConnection');\n\nexport default class RethinkConnection extends AbstractConnection {\n  _connection: any;\n  _connecting: boolean | null;\n  connectionFailed: boolean;\n\n  constructor(config: Map<string, string | number>) {\n    super();\n\n    if (!config.has('host')) {\n      config.set('host', 'localhost');\n    }\n    if (!config.has('port')) {\n      config.set('port', '28015');\n    }\n    if (!config.has('database')) {\n      throw new Error('Missing config database');\n    }\n\n    this.connect({\n      host: config.get('host'),\n      port: config.get('port'),\n      db: config.get('database'),\n    });\n  }\n\n  connect(options: Object) {\n    logger.info('connecting', options);\n\n    this._connection = rethinkDB({\n      ...options,\n      buffer: 20,\n      max: 100,\n    });\n\n    this._connection.getPoolMaster().on('healthy', healthy => {\n      if (healthy === true) {\n        this.getConnection = () => Promise.resolve(this._connection);\n        logger.info('healthy');\n      } else {\n        this.getConnection = () => Promise.reject(new Error('Connection not healthy'));\n        logger.warn('not healthy');\n      }\n    });\n\n    this.getConnection = () => Promise.resolve(this._connection);\n  }\n\n  getConnection(): Promise<void> {\n    throw new Error('call connect()');\n  }\n\n  close() {\n    this.getConnection = () => Promise.reject(new Error('Connection closed'));\n    if (this._connection) {\n      return this._connection\n        .getPoolMaster()\n        .drain()\n        .then(() => {\n          logger.info('connection closed');\n          this._connection = null;\n        });\n    } else if (this._connecting) {\n      return this.getConnection().then(() => this.close());\n    }\n  }\n}\n"],"names":["Query","AbstractQuery","callback","queryCallback","store","query","r","run","then","_includeInitial","args","_feed","promise","changes","feed","length","_promise","each","stop","closeFeed","cb","errCb","close","RethinkStore","AbstractStore","connection","tableName","keyPath","_tableName","_connection","table","criteria","sort","filter","keys","forEach","key","orderBy","desc","tableCreate","object","created","Date","insert","inserted","generated_keys","generatedKeys","Error","id","replaceOne","updated","get","replace","conflict","objects","Promise","all","map","partialUpdate","update","returnChanges","res","new_val","delete","cursor","next","catch","field","getField","logger","Logger","RethinkConnection","AbstractConnection","config","has","set","connect","options","info","rethinkDB","getPoolMaster","on","healthy","getConnection","resolve","reject","warn","drain","_connecting"],"mappings":"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"}