{"version":3,"file":"index-node14.cjs","sources":["../src/MongoCursor.ts","../src/MongoQueryCollection.ts","../src/MongoQuerySingleItem.ts","../src/MongoStore.ts","../src/MongoConnection.ts","../src/createMongoSubscribeStore.ts"],"sourcesContent":["import { AbstractStoreCursor } from 'liwi-store';\nimport type { AllowedKeyValue } from 'liwi-types';\nimport type { FindCursor } from 'mongodb';\nimport type { MongoBaseModel } from './MongoBaseModel';\nimport type MongoStore from './MongoStore';\n\nexport default class MongoCursor<\n  Model extends MongoBaseModel<KeyValue>,\n  Result extends Partial<Model> = Model,\n  KeyValue extends AllowedKeyValue = Model['_id'],\n> extends AbstractStoreCursor<\n  MongoStore<Model, KeyValue>,\n  KeyValue,\n  Model,\n  Result\n> {\n  // key in AbstractCursor\n\n  private readonly cursor: FindCursor<Result>;\n\n  private _result?: Result | null;\n\n  constructor(store: MongoStore<Model, KeyValue>, cursor: FindCursor<Result>) {\n    super(store);\n    this.cursor = cursor;\n  }\n\n  advance(count: number): void {\n    this.cursor.skip(count);\n  }\n\n  next(): Promise<KeyValue | undefined> {\n    return this.cursor.next().then((value) => {\n      this._result = value;\n      this.key = value?._id;\n      return this.key;\n    });\n  }\n\n  limit(newLimit: number): Promise<this> {\n    this.cursor.limit(newLimit);\n    return Promise.resolve(this);\n  }\n\n  result(): Promise<Result> {\n    if (!this._result) throw new Error('Cannot call result() before next()');\n    return Promise.resolve(this._result);\n  }\n\n  close(): Promise<void> {\n    if (this.cursor) {\n      this.cursor.close();\n    }\n\n    return Promise.resolve();\n  }\n\n  toArray(): Promise<Result[]> {\n    return this.cursor.toArray();\n  }\n}\n","/* eslint-disable complexity, max-lines */\nimport type {\n  QuerySubscription,\n  SubscribeCallback,\n  QueryResult,\n  QueryParams,\n} from 'liwi-store';\nimport type { Actions } from 'liwi-subscribe-store';\nimport { AbstractSubscribableStoreQuery } from 'liwi-subscribe-store';\nimport type {\n  Changes,\n  QueryOptions,\n  Transformer,\n  AllowedKeyValue,\n} from 'liwi-types';\nimport mingo from 'mingo';\nimport type {\n  MongoBaseModel,\n  MongoInsertType,\n  MongoKeyPath,\n} from './MongoBaseModel';\nimport type MongoCursor from './MongoCursor';\nimport type MongoStore from './MongoStore';\n\nconst identityTransformer = <\n  Model extends MongoBaseModel<any>,\n  Transformed = Model,\n>(\n  model: Model,\n): Transformed => model as unknown as Transformed;\n\ntype TestCriteria = (obj: any) => boolean;\n\nexport default class MongoQueryCollection<\n  Model extends MongoBaseModel<KeyValue>,\n  Params extends QueryParams<Params> = never,\n  KeyValue extends AllowedKeyValue = Model['_id'],\n  Item extends Record<MongoKeyPath, KeyValue> = Model,\n> extends AbstractSubscribableStoreQuery<\n  MongoKeyPath,\n  KeyValue,\n  Model,\n  MongoInsertType<Model, KeyValue>,\n  Params,\n  Item[]\n> {\n  private readonly store: MongoStore<Model, KeyValue>;\n\n  private readonly options: QueryOptions<Model>;\n\n  private testCriteria?: TestCriteria;\n\n  private readonly transformer: Transformer<Model, Item>;\n\n  constructor(\n    store: MongoStore<Model, KeyValue>,\n    options: QueryOptions<Model>,\n    transformer: Transformer<Model, Item> = identityTransformer,\n  ) {\n    super();\n    this.store = store;\n    this.options = options;\n    this.transformer = transformer;\n  }\n\n  createTestCriteria(): TestCriteria {\n    if (!this.testCriteria) {\n      if (!this.options.criteria) {\n        return () => true;\n      }\n\n      const mingoQuery = new mingo.Query(this.options.criteria);\n      this.testCriteria = mingoQuery.test.bind(mingoQuery);\n    }\n    return this.testCriteria;\n  }\n\n  async fetch<T>(onFulfilled: (result: QueryResult<Item[]>) => T): Promise<T> {\n    const [result, count] = await Promise.all([\n      this.createMongoCursor().then((cursor) => cursor.toArray()),\n      this.store.count(),\n    ]);\n\n    return onFulfilled({\n      result: result.map(this.transformer),\n      meta: { total: count },\n      info: {\n        sort: this.options.sort,\n        limit: this.options.limit,\n        keyPath: this.store.keyPath,\n      },\n    });\n  }\n\n  _subscribe(\n    callback: SubscribeCallback<KeyValue, Item[]>,\n    _includeInitial: boolean,\n  ): QuerySubscription {\n    const store = super.getSubscribeStore();\n    const testCriteria: TestCriteria = this.createTestCriteria();\n\n    const promise: Promise<void> = _includeInitial\n      ? this.fetch(({ result, meta, info }: QueryResult<Item[]>) => {\n          callback(null, [\n            {\n              type: 'initial',\n              initial: result,\n              queryInfo: info,\n              meta,\n            },\n          ]);\n        })\n      : Promise.resolve();\n\n    const unsubscribe = store.subscribe((action: Actions<Model>) => {\n      const changes: Changes<KeyValue, Item[]> = [];\n      switch (action.type) {\n        case 'inserted': {\n          const filtered = action.next.filter(testCriteria);\n          if (filtered.length > 0) {\n            changes.push({\n              type: 'inserted',\n              result: filtered.map(this.transformer),\n            });\n          }\n          break;\n        }\n        case 'deleted': {\n          const filtered = action.prev.filter(testCriteria);\n          if (filtered.length > 0) {\n            changes.push({\n              type: 'deleted',\n              keys: filtered.map((object) => object[this.store.keyPath]),\n            });\n          }\n          break;\n        }\n        case 'updated': {\n          const {\n            deleted,\n            updated,\n            inserted,\n          }: {\n            deleted: KeyValue[];\n            updated: Item[];\n            inserted: Item[];\n          } = { deleted: [], updated: [], inserted: [] };\n\n          action.changes.forEach(([prevObject, nextObject]: [Model, Model]) => {\n            if (testCriteria(prevObject)) {\n              if (!testCriteria(nextObject)) {\n                deleted.push(prevObject[this.store.keyPath]);\n              } else {\n                updated.push(this.transformer(nextObject));\n              }\n            } else if (testCriteria(nextObject)) {\n              inserted.push(this.transformer(nextObject));\n            }\n          });\n\n          if (deleted.length > 0) {\n            changes.push({ type: 'deleted', keys: deleted });\n          }\n          if (updated.length > 0) {\n            changes.push({ type: 'updated', result: updated });\n          }\n          if (inserted.length > 0) {\n            changes.push({ type: 'inserted', result: inserted });\n          }\n\n          break;\n        }\n        default:\n          throw new Error('Unsupported type');\n      }\n\n      if (changes.length === 0) return;\n\n      callback(null, changes);\n    });\n    // let _feed;\n    // const promise = this.queryCallback(this.store.query(), this.store.r)\n    //   .changes({\n    //     includeInitial: _includeInitial,\n    //     includeStates: true,\n    //     includeTypes: true,\n    //     includeOffsets: true,\n    //   })\n    //   .then((feed) => {\n    //     if (args.length === 0) {\n    //       _feed = feed;\n    //       delete this._promise;\n    //     }\n    //\n    //     feed.each(callback);\n    //     return feed;\n    //   });\n    //\n    // if (args.length === 0) this._promise = promise;\n\n    return {\n      stop: unsubscribe,\n      cancel: unsubscribe,\n      then: <T, U>(\n        onFulfilled: () => T | Promise<T>,\n        onRejected?: (error: any) => U | Promise<U>,\n      ): Promise<T | U> => promise.then(onFulfilled, onRejected),\n    };\n  }\n\n  private async createMongoCursor(): Promise<\n    MongoCursor<Model, Model, KeyValue>\n  > {\n    const cursor = await this.store.cursor(\n      this.options.criteria,\n      this.options.sort,\n    );\n\n    if (this.options.skip) {\n      cursor.advance(this.options.skip);\n    }\n\n    if (this.options.limit) {\n      await cursor.limit(this.options.limit);\n    }\n\n    return cursor;\n  }\n}\n","import type {\n  QuerySubscription,\n  SubscribeCallback,\n  QueryResult,\n  QueryParams,\n} from 'liwi-store';\nimport type { Actions } from 'liwi-subscribe-store';\nimport { AbstractSubscribableStoreQuery } from 'liwi-subscribe-store';\nimport type {\n  Changes,\n  QueryOptions,\n  Transformer,\n  AllowedKeyValue,\n} from 'liwi-types';\nimport mingo from 'mingo';\nimport type {\n  MongoBaseModel,\n  MongoInsertType,\n  MongoKeyPath,\n} from './MongoBaseModel';\nimport type MongoCursor from './MongoCursor';\nimport type MongoStore from './MongoStore';\n\nconst identityTransformer = <\n  Model extends MongoBaseModel<any>,\n  Transformed = Model,\n>(\n  model: Model,\n): Transformed => model as unknown as Transformed;\n\ntype TestCriteria = (obj: any) => boolean;\n\nexport default class MongoQuerySingleItem<\n  Model extends MongoBaseModel<KeyValue>,\n  Params extends QueryParams<Params> = never,\n  Result extends Record<MongoKeyPath, KeyValue> | null = Model | null,\n  KeyValue extends AllowedKeyValue = Model['_id'],\n> extends AbstractSubscribableStoreQuery<\n  MongoKeyPath,\n  KeyValue,\n  Model,\n  MongoInsertType<Model, KeyValue>,\n  Params,\n  Result\n> {\n  private readonly store: MongoStore<Model, KeyValue>;\n\n  private readonly options: QueryOptions<Model>;\n\n  private testCriteria?: TestCriteria;\n\n  private readonly transformer: Transformer<Model, Result>;\n\n  constructor(\n    store: MongoStore<Model, KeyValue>,\n    options: QueryOptions<Model>,\n    transformer: Transformer<Model, Result> = identityTransformer,\n  ) {\n    super();\n    this.store = store;\n    this.options = options;\n    this.transformer = transformer;\n  }\n\n  createMingoTestCriteria(): TestCriteria {\n    if (!this.testCriteria) {\n      if (!this.options.criteria) {\n        return () => true;\n      }\n\n      const mingoQuery = new mingo.Query(this.options.criteria);\n      this.testCriteria = mingoQuery.test.bind(mingoQuery);\n    }\n\n    return this.testCriteria;\n  }\n\n  async fetch<T>(onFulfilled: (result: QueryResult<Result>) => T): Promise<T> {\n    const cursor = await this.createMongoCursor();\n    await cursor.limit(1);\n    return cursor.toArray().then((result: Model[]) => {\n      const item: Result =\n        result.length === 0 ? (null as Result) : this.transformer(result[0]);\n      return onFulfilled({\n        result: item,\n        meta: { total: result === null ? 0 : 1 },\n        info: {\n          limit: 1,\n          keyPath: this.store.keyPath,\n        },\n      });\n    });\n  }\n\n  _subscribe(\n    callback: SubscribeCallback<KeyValue, Result>,\n    _includeInitial: boolean,\n  ): QuerySubscription {\n    const store = super.getSubscribeStore();\n    const testCriteria: TestCriteria = this.createMingoTestCriteria();\n\n    const promise: Promise<void> = _includeInitial\n      ? this.fetch(({ result, meta, info }: QueryResult<Result>) => {\n          callback(null, [\n            {\n              type: 'initial',\n              initial: result,\n              queryInfo: info,\n              meta,\n            },\n          ]);\n        })\n      : Promise.resolve();\n\n    const unsubscribe = store.subscribe(async (action: Actions<Model>) => {\n      const changes: Changes<KeyValue, Result> = [];\n      switch (action.type) {\n        case 'inserted': {\n          const filtered = action.next.filter(testCriteria);\n          if (filtered.length > 0) {\n            changes.push({\n              type: 'updated',\n              result: this.transformer(filtered[0]),\n            });\n          }\n          break;\n        }\n        case 'deleted': {\n          const filtered = action.prev.filter(testCriteria);\n          if (filtered.length > 0) {\n            changes.push({\n              type: 'deleted',\n              keys: filtered.map((object) => object[this.store.keyPath]),\n            });\n          }\n          break;\n        }\n        case 'updated': {\n          const filtered = action.changes.filter(([prev, next]) =>\n            testCriteria(prev),\n          );\n          if (filtered.length > 0) {\n            if (this.options.sort) {\n              const { result } = await this.fetch((res) => res);\n              changes.push({\n                type: 'updated',\n                result,\n              });\n            } else if (filtered.length !== 1) {\n              throw new Error(\n                'should not match more than 1, use sort if you can have multiple match',\n              );\n            } else {\n              const [, next] = filtered[0];\n              changes.push({\n                type: 'updated',\n                result: testCriteria(next) ? this.transformer(next) : null!,\n              });\n            }\n          } else if (filtered.length === 0) {\n          }\n          break;\n        }\n        default:\n          throw new Error('Unsupported type');\n      }\n\n      if (changes.length === 0) return;\n\n      callback(null, changes);\n    });\n\n    return {\n      stop: unsubscribe,\n      cancel: unsubscribe,\n      then: <T, U>(\n        onFulfilled: () => T | Promise<T>,\n        onRejected?: (error: any) => U | Promise<U>,\n      ): Promise<T | U> => promise.then(onFulfilled, onRejected),\n    };\n  }\n\n  private async createMongoCursor(): Promise<\n    MongoCursor<Model, Model, KeyValue>\n  > {\n    const cursor = await this.store.cursor(\n      this.options.criteria,\n      this.options.sort,\n    );\n\n    if (this.options.limit) {\n      await cursor.limit(this.options.limit);\n    }\n\n    return cursor;\n  }\n}\n","/* eslint-disable max-lines */\nimport type {\n  UpsertResult,\n  SubscribableStore,\n  QueryParams,\n  UpsertPartialObject,\n} from 'liwi-store';\nimport type {\n  Criteria,\n  Sort,\n  Update,\n  QueryOptions,\n  Transformer,\n  AllowedKeyValue,\n  OptionalBaseModelKeysForInsert,\n} from 'liwi-types';\nimport type {\n  Collection,\n  FindCursor,\n  MongoClient,\n  UpdateFilter,\n} from 'mongodb';\nimport mongodb from 'mongodb';\nimport type {\n  MongoBaseModel,\n  MongoKeyPath,\n  MongoInsertType,\n} from './MongoBaseModel';\nimport type MongoConnection from './MongoConnection';\nimport MongoCursor from './MongoCursor';\nimport MongoQueryCollection from './MongoQueryCollection';\nimport MongoQuerySingleItem from './MongoQuerySingleItem';\n\nexport interface MongoUpsertResult<\n  KeyValue extends AllowedKeyValue,\n  Model extends MongoBaseModel<KeyValue>,\n> extends UpsertResult<Model> {\n  object: Model;\n  inserted: boolean;\n}\n\nexport default class MongoStore<\n  Model extends MongoBaseModel<KeyValue>,\n  KeyValue extends AllowedKeyValue = Model[MongoKeyPath],\n> implements\n    SubscribableStore<\n      MongoKeyPath,\n      KeyValue,\n      Model,\n      MongoInsertType<Model>,\n      MongoConnection\n    >\n{\n  readonly keyPath: MongoKeyPath = '_id';\n\n  readonly connection: MongoConnection;\n\n  private _collection: Collection<Model> | Promise<Collection<Model>>;\n\n  constructor(connection: MongoConnection, collectionName: string) {\n    this.connection = connection;\n\n    if (!collectionName) {\n      throw new Error(`Invalid collectionName: \"${collectionName}\"`);\n    }\n\n    this._collection = connection.getConnection().then(\n      (client: MongoClient) => {\n        this._collection = client.db().collection(collectionName);\n        return this._collection;\n      },\n      (err: any) => {\n        this._collection = Promise.reject(err);\n        return this._collection;\n      },\n    );\n  }\n\n  get collection(): Promise<Collection<Model>> {\n    if (this.connection.connectionFailed) {\n      return Promise.reject(new Error('MongoDB connection failed'));\n    }\n\n    return Promise.resolve(this._collection);\n  }\n\n  createQuerySingleItem<\n    Result extends Record<MongoKeyPath, KeyValue> = Model,\n    Params extends QueryParams<Params> = never,\n  >(\n    options: QueryOptions<Model>,\n    transformer?: Transformer<Model, Result>,\n  ): MongoQuerySingleItem<Model, Params, Result, KeyValue> {\n    return new MongoQuerySingleItem<Model, Params, Result, KeyValue>(\n      this,\n      options,\n      transformer,\n    );\n  }\n\n  createQueryCollection<\n    Item extends Record<MongoKeyPath, KeyValue> = Model,\n    Params extends QueryParams<Params> = never,\n  >(\n    options: QueryOptions<Model>,\n    transformer?: Transformer<Model, Item>,\n  ): MongoQueryCollection<Model, Params, Model['_id'], Item> {\n    return new MongoQueryCollection<Model, Params, KeyValue, Item>(\n      this,\n      options,\n      transformer,\n    );\n  }\n\n  async insertOne(object: MongoInsertType<Model>): Promise<Model> {\n    if (!object._id) {\n      object._id = new mongodb.ObjectId().toString() as Model['_id'];\n    }\n\n    if (!object.created) object.created = new Date();\n    if (!object.updated) object.updated = new Date();\n\n    const collection = await this.collection;\n    const { acknowledged: isAcknowledged } = await collection.insertOne(\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      object as any,\n    );\n    if (!isAcknowledged) {\n      throw new Error('Fail to insert');\n    }\n\n    return object as Model;\n  }\n\n  async replaceOne(object: Model): Promise<Model> {\n    if (!object.updated) object.updated = new Date();\n\n    const collection = await this.collection;\n    await collection.replaceOne({ _id: object._id } as Criteria<Model>, object);\n    return object;\n  }\n\n  async upsertOne<\n    K extends Exclude<\n      keyof Model,\n      MongoKeyPath | OptionalBaseModelKeysForInsert\n    >,\n  >(\n    object: UpsertPartialObject<MongoKeyPath, KeyValue, Model, K>,\n    setOnInsertPartialObject?: Update<Model>['$setOnInsert'],\n  ): Promise<Model> {\n    const result = await this.upsertOneWithInfo(\n      object,\n      setOnInsertPartialObject,\n    );\n    return result.object;\n  }\n\n  async upsertOneWithInfo<\n    K extends Exclude<\n      keyof Model,\n      MongoKeyPath | OptionalBaseModelKeysForInsert\n    >,\n  >(\n    object: UpsertPartialObject<MongoKeyPath, KeyValue, Model, K>,\n    setOnInsertPartialObject?: Update<Model>['$setOnInsert'],\n  ): Promise<MongoUpsertResult<KeyValue, Model>> {\n    const $setOnInsert = {\n      created: object.created || new Date(),\n      ...setOnInsertPartialObject,\n    };\n\n    if (!object.updated) {\n      (object as MongoBaseModel).updated = new Date();\n    }\n\n    const $set: Partial<typeof object> = { ...object };\n    delete $set.created;\n\n    const collection = await this.collection;\n\n    const { upsertedCount } = await collection.updateOne(\n      { _id: object._id } as Criteria<Model>,\n      { $set, $setOnInsert } as UpdateFilter<Model>,\n      { upsert: true },\n    );\n\n    if (upsertedCount) {\n      Object.assign(object, $setOnInsert);\n    }\n\n    return { object: object as unknown as Model, inserted: !!upsertedCount };\n  }\n\n  replaceSeveral(objects: Model[]): Promise<Model[]> {\n    return Promise.all(objects.map((object: Model) => this.replaceOne(object)));\n  }\n\n  async partialUpdateByKey(\n    key: KeyValue,\n    partialUpdate: Update<Model>,\n    criteria?: Criteria<Model>,\n  ): Promise<Model> {\n    const collection = await this.collection;\n    const commandResult = await collection.updateOne(\n      { _id: key, ...criteria } as Criteria<Model>,\n      partialUpdate as UpdateFilter<Model>,\n    );\n    if (!commandResult.acknowledged) {\n      console.error(commandResult);\n      throw new Error('Update failed');\n    }\n    const object = await this.findByKey(key);\n    return object!;\n  }\n\n  partialUpdateOne(\n    object: Model,\n    partialUpdate: Update<Model>,\n  ): Promise<Model> {\n    return this.partialUpdateByKey(object._id, partialUpdate);\n  }\n\n  partialUpdateMany(\n    criteria: Criteria<Model>,\n    partialUpdate: Update<Model>,\n  ): Promise<void> {\n    return this.collection\n      .then((collection) =>\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        collection.updateMany(criteria, partialUpdate as any),\n      )\n      .then((res) => undefined); // TODO return updated object\n  }\n\n  deleteByKey(key: KeyValue, criteria?: Criteria<Model>): Promise<void> {\n    return this.collection\n      .then((collection) =>\n        collection.deleteOne({ _id: key, ...criteria } as Criteria<Model>),\n      )\n      .then(() => undefined);\n  }\n\n  deleteOne(object: Model): Promise<void> {\n    return this.deleteByKey(object._id);\n  }\n\n  deleteMany(selector: Criteria<Model>): Promise<void> {\n    return this.collection\n      .then((collection) => collection.deleteMany(selector))\n      .then(() => undefined);\n  }\n\n  async count(filter?: Criteria<Model>): Promise<number> {\n    const collection = await this.collection;\n    return filter\n      ? collection.countDocuments(filter)\n      : collection.countDocuments();\n  }\n\n  async cursor<Result = Model>(\n    filter?: Criteria<Model>,\n    sort?: Sort<Model>,\n  ): Promise<MongoCursor<Model, Result, KeyValue>> {\n    const collection = await this.collection;\n    const findCursor = filter\n      ? collection.find<Result>(filter)\n      : (collection.find() as unknown as FindCursor<Result>);\n    if (sort) findCursor.sort(sort);\n    return new MongoCursor<Model, Result, KeyValue>(this, findCursor);\n  }\n\n  async findByKey(\n    key: KeyValue,\n    criteria?: Criteria<Model>,\n  ): Promise<Model | undefined> {\n    const collection = await this.collection;\n    const result = await collection.findOne<Model>({\n      _id: key,\n      ...criteria,\n    } as Criteria<Model>);\n    return result || undefined;\n  }\n\n  findAll(criteria?: Criteria<Model>, sort?: Sort<Model>): Promise<Model[]> {\n    return this.cursor<Model>(criteria, sort).then((cursor) =>\n      cursor.toArray(),\n    );\n  }\n\n  async findOne(\n    filter: Criteria<Model>,\n    sort?: Sort<Model>,\n  ): Promise<Model | undefined> {\n    const collection = await this.collection;\n    const result = await collection.findOne<Model>(filter, {\n      sort,\n    });\n    return result || undefined;\n  }\n}\n","import { AbstractConnection } from 'liwi-store';\nimport mongodb from 'mongodb';\nimport { Logger } from 'nightingale-logger';\n\nconst logger = new Logger('liwi:mongo:MongoConnection');\n\nexport default class MongoConnection extends AbstractConnection {\n  _connection?: mongodb.MongoClient;\n\n  _connecting?: Promise<mongodb.MongoClient>;\n\n  connectionFailed?: boolean;\n\n  // TODO interface\n  constructor(config: Map<string, string | number>) {\n    super();\n\n    if (!config.has('host')) {\n      config.set('host', 'localhost');\n    }\n    if (!config.has('port')) {\n      config.set('port', '27017');\n    }\n    if (!config.has('database')) {\n      throw new Error('Missing config database');\n    }\n\n    const buildConnectionString = (redactCredentials: boolean): string =>\n      `mongodb://${\n        config.has('user')\n          ? `${\n              redactCredentials\n                ? `${(config.get('user') as string).slice(0, 2)}[redacted]`\n                : (config.get('user') as string)\n            }:${\n              redactCredentials\n                ? '[redacted]'\n                : (config.get('password') as string)\n            }@`\n          : ''\n      }` +\n      `${config.get('host') as string}:${config.get('port') as string}/${\n        config.get('database') as string\n      }`;\n\n    const connectionString = buildConnectionString(false);\n    const connectionStringRedacted = buildConnectionString(true);\n\n    this.connect(connectionString, connectionStringRedacted);\n  }\n\n  connect(connectionString: string, connectionStringRedacted: string): void {\n    logger.info('connecting', { connectionStringRedacted });\n\n    const connectPromise = mongodb.MongoClient.connect(connectionString)\n      .then((connection) => {\n        logger.info('connected', { connectionStringRedacted });\n        connection.on('close', () => {\n          logger.warn('close', { connectionStringRedacted });\n          this.connectionFailed = true;\n          this.getConnection = () => {\n            throw new Error('MongoDB connection closed');\n          };\n        });\n        connection.on('timeout', () => {\n          logger.warn('timeout', { connectionStringRedacted });\n          this.connectionFailed = true;\n          this.getConnection = () => {\n            throw new Error('MongoDB connection timeout');\n          };\n        });\n        connection.on('reconnect', () => {\n          logger.warn('reconnect', { connectionStringRedacted });\n          this.connectionFailed = false;\n          this.getConnection = () => Promise.resolve(this._connection!);\n        });\n        connection.on('error', (err) => {\n          logger.warn('error', { connectionStringRedacted, err });\n        });\n\n        this._connection = connection;\n        this._connecting = undefined;\n        this.getConnection = () => Promise.resolve(this._connection!);\n        return connection;\n      })\n      .catch((err) => {\n        logger.info('not connected', { connectionStringRedacted });\n        console.error(err.message || err);\n        // throw err;\n        process.nextTick(() => {\n          // eslint-disable-next-line unicorn/no-process-exit\n          process.exit(1);\n        });\n\n        throw err;\n      });\n\n    this.getConnection = () => Promise.resolve(connectPromise);\n    this._connecting = this.getConnection();\n  }\n\n  getConnection(): Promise<mongodb.MongoClient> {\n    throw new Error('call connect()');\n  }\n\n  async close(): Promise<void> {\n    this.getConnection = () => Promise.reject(new Error('Connection closed'));\n    if (this._connection) {\n      await this._connection.close();\n      this._connection = undefined;\n    } else if (this._connecting) {\n      await this._connecting;\n      await this.close();\n    }\n  }\n}\n","import { SubscribeStore } from 'liwi-subscribe-store';\nimport type { AllowedKeyValue } from 'liwi-types';\nimport type {\n  MongoBaseModel,\n  MongoInsertType,\n  MongoKeyPath,\n} from './MongoBaseModel';\nimport type MongoConnection from './MongoConnection';\nimport type MongoStore from './MongoStore';\n\nexport default function createMongoSubscribeStore<\n  Model extends MongoBaseModel<KeyValue>,\n  KeyValue extends AllowedKeyValue = Model[MongoKeyPath],\n>(\n  mongoStore: MongoStore<Model, KeyValue>,\n): SubscribeStore<\n  MongoKeyPath,\n  KeyValue,\n  Model,\n  MongoInsertType<Model, KeyValue>,\n  MongoConnection,\n  MongoStore<Model, KeyValue>\n> {\n  return new SubscribeStore(mongoStore);\n}\n"],"names":["MongoCursor","AbstractStoreCursor","constructor","store","cursor","advance","count","skip","next","then","value","_result","key","_id","limit","newLimit","Promise","resolve","result","Error","close","toArray","identityTransformer","model","MongoQueryCollection","AbstractSubscribableStoreQuery","options","transformer","createTestCriteria","testCriteria","criteria","mingoQuery","mingo","Query","test","bind","fetch","onFulfilled","all","createMongoCursor","map","meta","total","info","sort","keyPath","_subscribe","callback","_includeInitial","getSubscribeStore","promise","type","initial","queryInfo","unsubscribe","subscribe","action","changes","filtered","filter","length","push","prev","keys","object","deleted","updated","inserted","forEach","prevObject","nextObject","stop","cancel","onRejected","MongoQuerySingleItem","createMingoTestCriteria","item","res","MongoStore","connection","collectionName","_collection","getConnection","client","db","collection","err","reject","connectionFailed","createQuerySingleItem","createQueryCollection","insertOne","mongodb","ObjectId","toString","created","Date","acknowledged","isAcknowledged","replaceOne","upsertOne","setOnInsertPartialObject","upsertOneWithInfo","$setOnInsert","$set","upsertedCount","updateOne","upsert","Object","assign","replaceSeveral","objects","partialUpdateByKey","partialUpdate","commandResult","console","error","findByKey","partialUpdateOne","partialUpdateMany","updateMany","undefined","deleteByKey","deleteOne","deleteMany","selector","countDocuments","findCursor","find","findOne","findAll","logger","Logger","MongoConnection","AbstractConnection","config","has","set","buildConnectionString","redactCredentials","get","slice","connectionString","connectionStringRedacted","connect","connectPromise","MongoClient","on","warn","_connection","_connecting","catch","message","process","nextTick","exit","createMongoSubscribeStore","mongoStore","SubscribeStore"],"mappings":"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"}