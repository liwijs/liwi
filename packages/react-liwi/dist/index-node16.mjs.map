{"version":3,"file":"index-node16.mjs","sources":["../src/useResource.ts","../src/usePaginatedResource.ts","../src/useOperation.ts","../src/TransportClientProvider.tsx","../src/index.ts"],"sourcesContent":["import { POB_TARGET } from 'pob-babel';\nimport type { Query, QueryParams } from 'liwi-resources-client';\nimport type { SetOptional } from 'liwi-store';\nimport type { ResourceResult } from './createResourceResultFromState';\nimport { useRetrieveResource } from './useRetrieveResource';\nimport type { UseResourceAndSubscribeOptions } from './useRetrieveResourceAndSubscribe';\nimport { useRetrieveResourceAndSubscribe } from './useRetrieveResourceAndSubscribe';\n\ninterface UseResourceOptionsRequiredParams<Params extends QueryParams<Params>> {\n  params: Params;\n  skip?: boolean;\n  subscribe?: boolean;\n  subscribeOptions?: UseResourceAndSubscribeOptions;\n}\n\nexport type UseResourceOptions<Params extends QueryParams<Params>> =\n  Params extends Record<string, never>\n    ? SetOptional<UseResourceOptionsRequiredParams<Params>, 'params'>\n    : UseResourceOptionsRequiredParams<Params>;\n\nconst isSSR = typeof window === 'undefined';\n\nexport function useResource<Result, Params extends QueryParams<Params>>(\n  createQuery: (initialParams: Params) => Query<Result, Params>,\n  {\n    params,\n    skip = false,\n    subscribe,\n    subscribeOptions,\n  }: UseResourceOptions<Params>,\n  deps: any[],\n): ResourceResult<Result, Params> {\n  if (POB_TARGET === 'node') {\n    return {\n      query: undefined as any,\n      initialLoading: true,\n      initialError: false,\n      fetched: false,\n      fetching: true,\n      data: undefined,\n      meta: undefined,\n      queryInfo: undefined,\n      error: undefined,\n    };\n  }\n\n  const result =\n    subscribe && !isSSR\n      ? // eslint-disable-next-line react-hooks/rules-of-hooks\n        useRetrieveResourceAndSubscribe<Result, Params>(\n          createQuery,\n          params as Params,\n          skip,\n          deps,\n          subscribeOptions,\n        )\n      : // eslint-disable-next-line react-hooks/rules-of-hooks\n        useRetrieveResource<Result, Params>(\n          createQuery,\n          params as Params,\n          skip,\n          deps,\n        );\n\n  return result;\n}\n","import type { Query, QueryParams } from 'liwi-resources-client';\nimport { useMemo } from 'react';\nimport type {\n  ResourceResultInitialLoading,\n  ResourceResultInitialError,\n  ResourceResultLoaded,\n} from './createResourceResultFromState';\nimport type { UseResourceOptions } from './useResource';\nimport { useResource } from './useResource';\n\nexport interface PaginatedQueryRequiredParams {\n  page: number;\n}\n\ntype PaginatedQueryParams<Params extends Record<string, unknown>> =\n  PaginatedQueryRequiredParams & QueryParams<Params>;\n\ntype UsePaginatedResourceOptions<Params extends PaginatedQueryParams<Params>> =\n  UseResourceOptions<Params>;\n\nexport interface Pagination {\n  totalPages: number;\n}\n\ninterface PaginatedResourceResultInitialLoading<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> extends ResourceResultInitialLoading<Data, Params> {\n  pagination: undefined;\n}\n\ninterface PaginatedResourceResultInitialError<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> extends ResourceResultInitialError<Data, Params> {\n  pagination: undefined;\n}\n\ninterface PaginatedResourceResultLoaded<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> extends ResourceResultLoaded<Data, Params> {\n  pagination: Pagination;\n}\n\nexport type PaginatedResourceResult<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> =\n  | PaginatedResourceResultInitialError<Data, Params>\n  | PaginatedResourceResultInitialLoading<Data, Params>\n  | PaginatedResourceResultLoaded<Data, Params>;\n\nexport function usePaginatedResource<\n  Result,\n  Params extends PaginatedQueryParams<Params>,\n>(\n  createQuery: (initialParams: Params) => Query<Result, Params>,\n  options: UsePaginatedResourceOptions<Params>,\n  deps: any[],\n): PaginatedResourceResult<Result, Params> {\n  const result = useResource(createQuery, options, deps);\n  const total = result.meta?.total;\n  const limit = result.queryInfo?.limit;\n\n  const pagination = useMemo<Pagination | undefined>(() => {\n    if (total === undefined) return undefined;\n\n    return {\n      totalPages: limit ? Math.ceil(total / limit) : 1,\n    };\n  }, [total, limit]);\n\n  return useMemo(\n    () =>\n      ({ ...result, pagination } as PaginatedResourceResult<Result, Params>),\n    [result, pagination],\n  );\n}\n","import { useCallback, useState } from 'react';\n\nexport interface OperationState {\n  loading: boolean;\n  error: Error | undefined;\n}\n\nexport type OperationCallWrapper<T extends (...args: any) => Promise<any>> = (\n  ...args: Parameters<T>\n) => Promise<[Error | any | undefined, Awaited<ReturnType<T>> | undefined]>;\n\nexport function useOperation<T extends (...args: any) => Promise<any>>(\n  operationCall: T,\n): [OperationCallWrapper<T>, OperationState] {\n  const [state, setState] = useState<OperationState>(() => ({\n    loading: false,\n    error: undefined,\n  }));\n\n  const operationCallWrapper = useCallback<OperationCallWrapper<T>>(\n    (...params: Parameters<T>) => {\n      setState({\n        loading: true,\n        error: undefined,\n      });\n      try {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        return operationCall(...(params as any)).then(\n          (result) => {\n            setState({\n              loading: false,\n              error: undefined,\n            });\n            return [undefined, result];\n          },\n          (err) => {\n            setState({\n              loading: false,\n              error: err,\n            });\n            return [err, undefined];\n          },\n        );\n      } catch (err) {\n        setState({\n          loading: false,\n          error: err as Error,\n        });\n        return Promise.resolve([err, undefined]);\n      }\n    },\n    [operationCall],\n  );\n  return [operationCallWrapper, state];\n}\n","import type { TransportClient, ConnectionStates } from 'liwi-resources-client';\nimport type { ReactElement, ReactNode } from 'react';\nimport { useContext, createContext, useState, useEffect } from 'react';\n\nexport const TransportClientContext = createContext<TransportClient>(\n  undefined as unknown as TransportClient,\n);\n\nexport const TransportClientStateContext =\n  createContext<ConnectionStates>('opening');\nexport const TransportClientReadyContext = createContext<boolean>(false);\n\nexport const useTransportClientState = (): ConnectionStates =>\n  useContext(TransportClientStateContext);\nexport const useTransportClientIsReady = (): boolean =>\n  useContext(TransportClientReadyContext);\n\ntype TransportClientProviderProps<P extends Record<never, unknown>> = P & {\n  createFn: (params: Omit<P, 'children' | 'createFn'>) => TransportClient;\n  children: ReactNode;\n};\n\nexport function TransportClientProvider<P extends Record<never, unknown>>({\n  createFn,\n  children,\n  ...params\n}: TransportClientProviderProps<P>): ReactElement {\n  const [client] = useState(() => {\n    return createFn(params);\n  });\n  const [connectionState, setConnectionState] =\n    useState<ConnectionStates>('opening');\n\n  useEffect(() => {\n    const closeConnectionStateListener =\n      client.listenStateChange(setConnectionState);\n    client.connect();\n\n    return (): void => {\n      closeConnectionStateListener();\n      client.close();\n    };\n  }, [client]);\n\n  return (\n    <TransportClientContext.Provider value={client}>\n      <TransportClientStateContext.Provider value={connectionState}>\n        <TransportClientReadyContext.Provider\n          value={connectionState === 'connected'}\n        >\n          {children}\n        </TransportClientReadyContext.Provider>\n      </TransportClientStateContext.Provider>\n    </TransportClientContext.Provider>\n  );\n}\n","import type { ConnectionStates } from 'liwi-resources-client/src/TransportClient';\n\nexport { useResource } from './useResource';\nexport type {\n  PaginatedQueryRequiredParams,\n  Pagination,\n} from './usePaginatedResource';\nexport { usePaginatedResource } from './usePaginatedResource';\nexport { useOperation } from './useOperation';\nexport type { OperationCallWrapper } from './useOperation';\nexport type { ResourceResult } from './createResourceResultFromState';\nexport {\n  TransportClientProvider,\n  TransportClientContext,\n  TransportClientStateContext,\n  TransportClientReadyContext,\n  useTransportClientState,\n  useTransportClientIsReady,\n} from './TransportClientProvider';\nexport { ResourcesServerError } from 'liwi-resources-client';\n\nexport type SimplifiedConnectionState =\n  | 'connected'\n  | 'connecting'\n  | 'disconnected';\n\nexport const transportClientStateToSimplifiedState = (\n  state: ConnectionStates,\n): SimplifiedConnectionState => {\n  switch (state) {\n    case 'opening':\n    case 'connecting':\n    case 'reconnect-scheduled':\n    case 'wait-for-visibility':\n      return 'connecting';\n\n    case 'connected':\n      return 'connected';\n\n    case 'closed':\n      return 'disconnected';\n  }\n};\n"],"names":["useResource","createQuery","params","skip","subscribe","subscribeOptions","deps","query","undefined","initialLoading","initialError","fetched","fetching","data","meta","queryInfo","error","usePaginatedResource","options","result","total","limit","pagination","useMemo","totalPages","Math","ceil","useOperation","operationCall","state","setState","useState","loading","operationCallWrapper","useCallback","then","err","Promise","resolve","TransportClientContext","createContext","TransportClientStateContext","TransportClientReadyContext","useTransportClientState","useContext","useTransportClientIsReady","TransportClientProvider","createFn","children","client","connectionState","setConnectionState","useEffect","closeConnectionStateListener","listenStateChange","connect","close","_jsx","Provider","value","transportClientStateToSimplifiedState"],"mappings":"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"}