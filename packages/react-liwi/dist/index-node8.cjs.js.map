{"version":3,"file":"index-node8.cjs.js","sources":["../src/Find.ts","../src/applyChanges.ts","../src/FindAndSubscribe.ts"],"sourcesContent":["import React, { Component, ReactNode, ComponentType } from 'react';\nimport { AbstractQuery } from 'liwi-store';\nimport { BaseModel } from 'liwi-types';\n\ninterface LoadingProps {}\n\ntype Record<K extends string, T> = { [P in K]: T };\n\ninterface Props<Name extends string, Model extends BaseModel> {\n  component: ComponentType<Record<Name, Model[]>>;\n  loadingComponent?: ComponentType<LoadingProps>;\n  name: Name;\n  query: AbstractQuery<Model>;\n}\n\ninterface State<Result> {\n  fetched: boolean;\n  result: Result | undefined;\n}\n\nexport default class FindComponent<\n  Name extends string,\n  Model extends BaseModel\n> extends Component<Props<Name, Model>, State<Model[]>> {\n  state = {\n    fetched: false,\n    result: undefined,\n  };\n\n  // eslint-disable-next-line react/sort-comp\n  _find?: Promise<void>;\n\n  componentDidMount() {\n    const { query } = this.props;\n    this._find = query.fetch((result: Model[]) => {\n      if (!this._find) return;\n      this.setState({\n        fetched: true,\n        result,\n      });\n      delete this._find;\n    });\n  }\n\n  componentWillUnmount() {\n    if (this._find) {\n      // this._find.cancel();\n      delete this._find;\n    }\n  }\n\n  render(): ReactNode {\n    if (!this.state.fetched) {\n      return this.props.loadingComponent\n        ? React.createElement(this.props.loadingComponent)\n        : null;\n    }\n\n    return React.createElement(this.props.component, {\n      [this.props.name]: this.state.result,\n    } as any);\n  }\n}\n","/* eslint-disable camelcase, complexity */\nimport { BaseModel, Change, Changes } from 'liwi-types';\n\nconst copy = <Model>(state: Model[]) => state.slice();\n\nconst applyChange = <Model extends BaseModel>(\n  state: Model[],\n  change: Change<Model>,\n  keyPath: string,\n): Model[] => {\n  switch (change.type) {\n    case 'initial':\n      return change.initial;\n\n    case 'inserted': {\n      return [...change.objects, ...state.slice(0, -change.objects.length)];\n    }\n\n    case 'deleted': {\n      const deletedKeys = change.keys;\n      return state.filter((value) => !deletedKeys.includes(value[keyPath]));\n    }\n\n    case 'updated': {\n      const newState = copy(state);\n      change.objects.forEach((newObject) => {\n        const index = newState.findIndex(\n          (o: Model) => o[keyPath] === newObject[keyPath],\n        );\n        if (index === -1) return;\n        newState[index] = newObject;\n      });\n      return newState;\n    }\n\n    default:\n      throw new Error('Invalid type');\n  }\n};\n\n// https://github.com/rethinkdb/horizon/blob/next/client/src/ast.js\nexport default <Model extends BaseModel>(\n  state: undefined | Model[],\n  changes: Changes<Model>,\n  keyPath: string,\n): undefined | Model[] => {\n  if (changes.length === 1) {\n    const firstChange = changes[0];\n    if (firstChange.type === 'initial') {\n      return firstChange.initial;\n    }\n  }\n\n  if (state === undefined) return state;\n\n  return changes.reduce(\n    (stateValue: Model[], change: Change<Model>) =>\n      applyChange(stateValue, change, keyPath),\n    state,\n  );\n};\n","import React, { Component, ReactNode, ComponentType } from 'react';\nimport Logger from 'nightingale-logger';\nimport { BaseModel, Changes } from 'liwi-types';\nimport { AbstractQuery, SubscribeResult } from 'liwi-store';\nimport applyChanges from './applyChanges';\n\ninterface LoadingProps {}\n\ninterface Props<Name extends string, Model extends BaseModel> {\n  component: ComponentType<{ [P in Name]: Model[] }>;\n  loadingComponent?: ComponentType<LoadingProps>;\n  name: Name;\n  query: AbstractQuery<Model>;\n  visibleTimeout?: number;\n}\n\ninterface State<Result> {\n  fetched: boolean;\n  result: Result | undefined;\n}\n\nconst logger = new Logger('react-liwi:FindAndSubscribe');\n\nexport default class FindAndSubscribeComponent<\n  Name extends string,\n  Model extends BaseModel\n> extends Component<Props<Name, Model>, State<Model[]>> {\n  static defaultProps = {\n    visibleTimeout: 1000 * 60 * 2, // 2 minutes\n  };\n\n  state = {\n    fetched: false,\n    result: undefined,\n  };\n\n  private timeout: number | undefined = undefined;\n\n  private _subscribe: SubscribeResult<Model[]> | undefined = undefined;\n\n  componentDidMount() {\n    this.subscribe();\n    document.addEventListener(\n      'visibilitychange',\n      this.handleVisibilityChange,\n      false,\n    );\n  }\n\n  componentWillUnmount() {\n    this.unsubscribe();\n  }\n\n  private handleVisibilityChange = () => {\n    if (!document.hidden) {\n      if (this.timeout !== undefined) {\n        logger.log('timeout cleared', {\n          name: this.props.name,\n        });\n        clearTimeout(this.timeout);\n        this.timeout = undefined;\n      } else {\n        logger.debug('resubscribe', {\n          name: this.props.name,\n        });\n        this.subscribe();\n      }\n      return;\n    }\n\n    if (this._subscribe === undefined) return;\n\n    logger.log('timeout visible', {\n      name: this.props.name,\n    });\n    this.timeout = setTimeout(this.unsubscribe, this.props.visibleTimeout);\n  };\n\n  private subscribe = (): void => {\n    const { query } = this.props;\n    this._subscribe = query.fetchAndSubscribe(\n      (err: Error | null, changes: Changes<Model>) => {\n        if (err) {\n          // eslint-disable-next-line no-alert\n          alert(`Unexpected error: ${err}`);\n          return;\n        }\n\n        const newResult = applyChanges(\n          this.state.result,\n          changes,\n          '_id', // TODO get keyPath from client(/store)\n        );\n\n        if (!this.state.fetched) {\n          this.setState({ fetched: true, result: newResult });\n        } else if (newResult !== this.state.result) {\n          this.setState({ result: newResult });\n        }\n      },\n    );\n  };\n\n  private unsubscribe(): void {\n    if (this._subscribe) {\n      this._subscribe.stop();\n      this._subscribe = undefined;\n    }\n  }\n\n  render(): ReactNode {\n    if (!this.state.fetched) {\n      return this.props.loadingComponent\n        ? React.createElement(this.props.loadingComponent)\n        : null;\n    }\n\n    return React.createElement(this.props.component, {\n      [this.props.name]: this.state.result,\n    } as any);\n  }\n}\n"],"names":["FindComponent","Component","state","fetched","result","undefined","componentDidMount","query","props","_find","fetch","setState","componentWillUnmount","render","loadingComponent","React","createElement","component","name","copy","slice","applyChange","change","keyPath","type","initial","objects","length","deletedKeys","keys","filter","value","includes","newState","forEach","newObject","index","findIndex","o","Error","changes","firstChange","reduce","stateValue","logger","Logger","FindAndSubscribeComponent","timeout","_subscribe","handleVisibilityChange","document","hidden","log","clearTimeout","debug","subscribe","setTimeout","unsubscribe","visibleTimeout","fetchAndSubscribe","err","alert","newResult","applyChanges","addEventListener","stop","defaultProps"],"mappings":";;;;;;;;;;AAoBe,MAAMA,aAAN,SAGLC,eAHK,CAGyC;;;SACtDC,KADsD,GAC9C;MACNC,OAAO,EAAE,KADH;MAENC,MAAM,EAAEC;KAH4C;;;EAStDC,iBAAiB,GAAG;UACZ;MAAEC;QAAU,KAAKC,KAAvB;SACKC,KAAL,GAAaF,KAAK,CAACG,KAAN,CAAaN,MAAD,IAAqB;UACxC,CAAC,KAAKK,KAAV,EAAiB;WACZE,QAAL,CAAc;QACZR,OAAO,EAAE,IADG;QAEZC;OAFF;aAIO,KAAKK,KAAZ;KANW,CAAb;;;EAUFG,oBAAoB,GAAG;QACjB,KAAKH,KAAT,EAAgB;;aAEP,KAAKA,KAAZ;;;;EAIJI,MAAM,GAAc;QACd,CAAC,KAAKX,KAAL,CAAWC,OAAhB,EAAyB;aAChB,KAAKK,KAAL,CAAWM,gBAAX,GACHC,cAAK,CAACC,aAAN,CAAoB,KAAKR,KAAL,CAAWM,gBAA/B,CADG,GAEH,IAFJ;;;WAKKC,cAAK,CAACC,aAAN,CAAoB,KAAKR,KAAL,CAAWS,SAA/B,EAA0C;OAC9C,KAAKT,KAAL,CAAWU,IAAZ,GAAmB,KAAKhB,KAAL,CAAWE;KADzB,CAAP;;;;;AC1DJ;AAGA,MAAMe,IAAI,GAAWjB,KAAP,IAA0BA,KAAK,CAACkB,KAAN,EAAxC;;AAEA,MAAMC,WAAW,GAAI,CACnBnB,KADmB,EAEnBoB,MAFmB,EAGnBC,OAHmB,KAIP;UACJD,MAAM,CAACE,IAAf;SACO,SAAL;aACSF,MAAM,CAACG,OAAd;;SAEG,UAAL;;eACS,CAAC,GAAGH,MAAM,CAACI,OAAX,EAAoB,GAAGxB,KAAK,CAACkB,KAAN,CAAY,CAAZ,EAAe,CAACE,MAAM,CAACI,OAAP,CAAeC,MAA/B,CAAvB,CAAP;;;SAGG,SAAL;;cACQC,WAAW,GAAGN,MAAM,CAACO,IAA3B;eACO3B,KAAK,CAAC4B,MAAN,CAAcC,KAAD,IAAW,CAACH,WAAW,CAACI,QAAZ,CAAqBD,KAAK,CAACR,OAAD,CAA1B,CAAzB,CAAP;;;SAGG,SAAL;;cACQU,QAAQ,GAAGd,IAAI,CAACjB,KAAD,CAArB;QACAoB,MAAM,CAACI,OAAP,CAAeQ,OAAf,CAAwBC,SAAD,IAAe;gBAC9BC,KAAK,GAAGH,QAAQ,CAACI,SAAT,CACXC,CAAD,IAAcA,CAAC,CAACf,OAAD,CAAD,KAAeY,SAAS,CAACZ,OAAD,CAD1B,CAAd;cAGIa,KAAK,KAAK,CAAC,CAAf,EAAkB;UAClBH,QAAQ,CAACG,KAAD,CAAR,GAAkBD,SAAlB;SALF;eAOOF,QAAP;;;;YAIM,IAAIM,KAAJ,CAAU,cAAV,CAAN;;CA/BN;;;AAoCA,oBAAgB,CACdrC,KADc,EAEdsC,OAFc,EAGdjB,OAHc,KAIU;MACpBiB,OAAO,CAACb,MAAR,KAAmB,CAAvB,EAA0B;UAClBc,WAAW,GAAGD,OAAO,CAAC,CAAD,CAA3B;;QACIC,WAAW,CAACjB,IAAZ,KAAqB,SAAzB,EAAoC;aAC3BiB,WAAW,CAAChB,OAAnB;;;;MAIAvB,KAAK,KAAKG,SAAd,EAAyB,OAAOH,KAAP;SAElBsC,OAAO,CAACE,MAAR,CACL,CAACC,UAAD,EAAsBrB,MAAtB,KACED,WAAW,CAACsB,UAAD,EAAarB,MAAb,EAAqBC,OAArB,CAFR,EAGLrB,KAHK,CAAP;CAdF;;ACpBA,MAAM0C,MAAM,GAAG,IAAIC,MAAJ,CAAW,6BAAX,CAAf;AAEA,AAAe,MAAMC,yBAAN,SAGL7C,eAHK,CAGyC;;;SAKtDC,KALsD,GAK9C;MACNC,OAAO,EAAE,KADH;MAENC,MAAM,EAAEC;KAP4C;SAU9C0C,OAV8C,GAUhB1C,SAVgB;SAY9C2C,UAZ8C,GAYK3C,SAZL;;SA2B9C4C,sBA3B8C,GA2BrB,MAAM;UACjC,CAACC,QAAQ,CAACC,MAAd,EAAsB;YAChB,KAAKJ,OAAL,KAAiB1C,SAArB,EAAgC;UAC9BuC,MAAM,CAACQ,GAAP,CAAW,iBAAX,EAA8B;YAC5BlC,IAAI,EAAE,KAAKV,KAAL,CAAWU;WADnB;UAGAmC,YAAY,CAAC,KAAKN,OAAN,CAAZ;eACKA,OAAL,GAAe1C,SAAf;SALF,MAMO;UACLuC,MAAM,CAACU,KAAP,CAAa,aAAb,EAA4B;YAC1BpC,IAAI,EAAE,KAAKV,KAAL,CAAWU;WADnB;eAGKqC,SAAL;;;;;;UAKA,KAAKP,UAAL,KAAoB3C,SAAxB,EAAmC;MAEnCuC,MAAM,CAACQ,GAAP,CAAW,iBAAX,EAA8B;QAC5BlC,IAAI,EAAE,KAAKV,KAAL,CAAWU;OADnB;WAGK6B,OAAL,GAAeS,UAAU,CAAC,KAAKC,WAAN,EAAmB,KAAKjD,KAAL,CAAWkD,cAA9B,CAAzB;KAjDoD;;SAoD9CH,SApD8C,GAoDlC,MAAY;YACxB;QAAEhD;UAAU,KAAKC,KAAvB;WACKwC,UAAL,GAAkBzC,KAAK,CAACoD,iBAAN,CAChB,CAACC,GAAD,EAAoBpB,OAApB,KAAgD;YAC1CoB,GAAJ,EAAS;;UAEPC,KAAK,CAAE,qBAAoBD,GAAI,EAA1B,CAAL;;;;cAIIE,SAAS,GAAGC,YAAY,CAC5B,KAAK7D,KAAL,CAAWE,MADiB,EAE5BoC,OAF4B,EAG5B,KAH4B;SAA9B;;YAMI,CAAC,KAAKtC,KAAL,CAAWC,OAAhB,EAAyB;eAClBQ,QAAL,CAAc;YAAER,OAAO,EAAE,IAAX;YAAiBC,MAAM,EAAE0D;WAAvC;SADF,MAEO,IAAIA,SAAS,KAAK,KAAK5D,KAAL,CAAWE,MAA7B,EAAqC;eACrCO,QAAL,CAAc;YAAEP,MAAM,EAAE0D;WAAxB;;OAjBY,CAAlB;KAtDoD;;;EActDxD,iBAAiB,GAAG;SACbiD,SAAL;IACAL,QAAQ,CAACc,gBAAT,CACE,kBADF,EAEE,KAAKf,sBAFP,EAGE,KAHF;;;EAOFrC,oBAAoB,GAAG;SAChB6C,WAAL;;;EAqDMA,WAAR,GAA4B;QACtB,KAAKT,UAAT,EAAqB;WACdA,UAAL,CAAgBiB,IAAhB;;WACKjB,UAAL,GAAkB3C,SAAlB;;;;EAIJQ,MAAM,GAAc;QACd,CAAC,KAAKX,KAAL,CAAWC,OAAhB,EAAyB;aAChB,KAAKK,KAAL,CAAWM,gBAAX,GACHC,cAAK,CAACC,aAAN,CAAoB,KAAKR,KAAL,CAAWM,gBAA/B,CADG,GAEH,IAFJ;;;WAKKC,cAAK,CAACC,aAAN,CAAoB,KAAKR,KAAL,CAAWS,SAA/B,EAA0C;OAC9C,KAAKT,KAAL,CAAWU,IAAZ,GAAmB,KAAKhB,KAAL,CAAWE;KADzB,CAAP;;;;AA9FiB0C,0BAIZoB,eAAe;EACpBR,cAAc,QADM;;;;;;;"}