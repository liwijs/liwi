{"version":3,"file":"index-browsermodern-dev.es.js","sources":["../src/Find.ts","../src/applyChanges.ts","../src/FindAndSubscribe.ts"],"sourcesContent":["import React, { Component, ReactNode, ComponentType } from 'react';\nimport { AbstractQuery, AbstractStore } from 'liwi-store';\nimport { BaseModel } from 'liwi-types';\n\ninterface LoadingProps {}\n\ntype Record<K extends string, T> = { [P in K]: T };\n\ninterface Props<\n  Name extends string,\n  Model extends BaseModel,\n  Store extends AbstractStore<any, any, any, any, any>\n> {\n  component: ComponentType<Record<Name, Array<Model>>>;\n  loadingComponent?: ComponentType<LoadingProps>;\n  name: Name;\n  query: AbstractQuery<Model, Store>;\n}\n\ninterface State<Result> {\n  fetched: boolean;\n  result: Result | undefined;\n}\n\nexport default class FindComponent<\n  Name extends string,\n  Model extends BaseModel,\n  Store extends AbstractStore<any, any, any, any, any>\n> extends Component<Props<Name, Model, Store>, State<Array<Model>>> {\n  state = {\n    fetched: false,\n    result: undefined,\n  };\n\n  // eslint-disable-next-line react/sort-comp\n  _find?: Promise<void>;\n\n  componentDidMount() {\n    const { query } = this.props;\n    this._find = query.fetch((result: Array<Model>) => {\n      if (!this._find) return;\n      this.setState({\n        fetched: true,\n        result,\n      });\n      delete this._find;\n    });\n  }\n\n  componentWillUnmount() {\n    if (this._find) {\n      // this._find.cancel();\n      delete this._find;\n    }\n  }\n\n  render(): ReactNode {\n    if (!this.state.fetched) {\n      return this.props.loadingComponent\n        ? React.createElement(this.props.loadingComponent)\n        : null;\n    }\n\n    return React.createElement(this.props.component, {\n      [this.props.name]: this.state.result,\n    } as any);\n  }\n}\n","/* eslint-disable camelcase, complexity */\nimport { BaseModel, Change, Changes } from 'liwi-types';\n\nconst copy = <Model>(state: Array<Model>) => state.slice();\n\nconst applyChange = <Model extends BaseModel>(\n  state: Array<Model>,\n  change: Change<Model>,\n  keyPath: string,\n): Array<Model> => {\n  switch (change.type) {\n    case 'initial':\n      return change.initial;\n\n    case 'inserted': {\n      const newState = copy(state);\n      newState.push(...change.objects);\n      return newState;\n    }\n\n    case 'deleted': {\n      const deletedKeys = change.keys;\n      return state.filter((value) => !deletedKeys.includes(value[keyPath]));\n    }\n\n    case 'updated': {\n      const newState = copy(state);\n      change.objects.forEach((newObject) => {\n        const index = newState.findIndex(\n          (o: Model) => o[keyPath] === newObject[keyPath],\n        );\n        if (index === -1) return;\n        newState[index] = newObject;\n      });\n      return newState;\n    }\n\n    default:\n      throw new Error('Invalid type');\n  }\n};\n\n// https://github.com/rethinkdb/horizon/blob/next/client/src/ast.js\nexport default <Model extends BaseModel>(\n  state: undefined | Array<Model>,\n  changes: Changes<Model>,\n  keyPath: string,\n): undefined | Array<Model> => {\n  if (changes.length === 1) {\n    const firstChange = changes[0];\n    if (firstChange.type === 'initial') {\n      return firstChange.initial;\n    }\n  }\n\n  if (state === undefined) return state;\n\n  return changes.reduce(\n    (stateValue: Array<Model>, change: Change<Model>) =>\n      applyChange(stateValue, change, keyPath),\n    state,\n  );\n};\n","import React, { Component, ReactNode, ComponentType } from 'react';\nimport { BaseModel, Changes } from 'liwi-types';\nimport { AbstractQuery, AbstractStore } from 'liwi-store';\nimport applyChanges from './applyChanges';\n\ninterface LoadingProps {}\n\ntype Record<K extends string, T> = { [P in K]: T };\n\ninterface Props<\n  Name extends string,\n  Model extends BaseModel,\n  Store extends AbstractStore<any, any, any, any, any>\n> {\n  component: ComponentType<Record<Name, Array<Model>>>;\n  loadingComponent?: ComponentType<LoadingProps>;\n  name: Name;\n  query: AbstractQuery<Model, Store>;\n}\n\ninterface State<Result> {\n  fetched: boolean;\n  result: Result | undefined;\n}\n\nexport default class FindAndSubscribeComponent<\n  Name extends string,\n  Model extends BaseModel,\n  Store extends AbstractStore<Model, any, any, any, any>\n> extends Component<Props<Name, Model, Store>, State<Array<Model>>> {\n  state = {\n    fetched: false,\n    result: undefined,\n  };\n\n  // eslint-disable-next-line react/sort-comp\n  _subscribe?: any;\n\n  componentDidMount() {\n    const { query } = this.props;\n    this._subscribe = query.fetchAndSubscribe(\n      (err: Error | null, changes: Changes<Model>) => {\n        if (err) {\n          // eslint-disable-next-line no-alert\n          alert(`Unexpected error: ${err}`);\n          return;\n        }\n\n        const newResult = applyChanges(\n          this.state.result,\n          changes,\n          query.store.keyPath,\n        );\n\n        if (!this.state.fetched) {\n          this.setState({ fetched: true, result: newResult });\n        } else if (newResult !== this.state.result) {\n          this.setState({ result: newResult });\n        }\n      },\n    );\n  }\n\n  componentWillUnmount() {\n    if (this._subscribe) {\n      this._subscribe.stop();\n      delete this._subscribe;\n    }\n  }\n\n  render(): ReactNode {\n    if (!this.state.fetched) {\n      return this.props.loadingComponent\n        ? React.createElement(this.props.loadingComponent)\n        : null;\n    }\n\n    return React.createElement(this.props.component, {\n      [this.props.name]: this.state.result,\n    } as any);\n  }\n}\n"],"names":["FindComponent","Component","state","fetched","result","undefined","componentDidMount","query","props","_find","fetch","setState","componentWillUnmount","render","loadingComponent","React","createElement","component","name","copy","slice","applyChange","change","keyPath","type","initial","newState","push","objects","deletedKeys","keys","filter","value","includes","forEach","newObject","index","findIndex","o","Error","changes","length","firstChange","reduce","stateValue","FindAndSubscribeComponent","_subscribe","fetchAndSubscribe","err","alert","newResult","applyChanges","store","stop"],"mappings":"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"}