{"version":3,"file":"index-browser.es.js","sources":["../src/reducer.ts","../src/hooks/useRetrieveResource.ts","../src/applyChanges.ts","../src/hooks/useRetrieveResourceAndSubscribe.ts","../src/hooks/useResources.ts","../src/hooks/useResource.ts"],"sourcesContent":["import { Reducer } from 'react';\n\nexport interface InitialState {\n  fetched: false;\n  promise: Promise<void>;\n}\n\nexport interface FetchedState<Result> {\n  fetched: true;\n  result: Result;\n}\n\nexport interface InitAction {\n  type: 'init';\n}\n\nexport interface ResolveAction<Result> {\n  type: 'resolve';\n  result: Result;\n}\n\nexport type Action<Result> = ResolveAction<Result>;\nexport type State<Result> = InitialState | FetchedState<Result>;\nexport type Reducer<Result> = Reducer<State<Result>, Action<Result>>;\n\nexport function initReducer(initializer: () => Promise<void>): InitialState {\n  return {\n    fetched: false,\n    promise: initializer(),\n  };\n}\n\nexport default function reducer<Result>(\n  state: State<Result>,\n  action: Action<Result>,\n): State<Result> {\n  switch (action.type) {\n    case 'resolve':\n      return {\n        fetched: true,\n        result: action.result,\n      };\n    default:\n      throw new Error('Invalid action');\n  }\n}\n","import { useReducer } from 'react';\nimport { BaseModel } from 'liwi-types';\nimport { AbstractQuery } from 'liwi-store';\nimport reducer, { initReducer, Reducer } from '../reducer';\n\nexport default function useRetrieveResource<Model extends BaseModel>(\n  createQuery: () => AbstractQuery<Model>,\n) {\n  const [state, dispatch] = useReducer<Reducer<Model[]>, () => Promise<void>>(\n    reducer,\n    () =>\n      createQuery().fetch((result: Model[]) => {\n        (state as any).resolve();\n        dispatch({ type: 'resolve', result });\n      }),\n    initReducer,\n  );\n\n  return state;\n}\n","/* eslint-disable camelcase, complexity */\nimport { Change, Changes } from 'liwi-types';\n\nconst copy = <Value>(state: Value[]): Value[] => state.slice();\n\nconst applyChange = <\n  KeyPath extends string,\n  Value extends { [K in KeyPath]: any }\n>(\n  state: Value[],\n  change: Change<Value>,\n  keyPath: KeyPath,\n): Value[] => {\n  switch (change.type) {\n    case 'initial':\n      return change.initial;\n\n    case 'inserted': {\n      return [...change.objects, ...state.slice(0, -change.objects.length)];\n    }\n\n    case 'deleted': {\n      const deletedKeys = change.keys;\n      return state.filter((value) => !deletedKeys.includes(value[keyPath]));\n    }\n\n    case 'updated': {\n      const newState = copy(state);\n      change.objects.forEach((newObject) => {\n        const index = newState.findIndex(\n          (o: Value) => o[keyPath] === newObject[keyPath],\n        );\n        if (index === -1) return;\n        newState[index] = newObject;\n      });\n      return newState;\n    }\n\n    default:\n      throw new Error('Invalid type');\n  }\n};\n\n// https://github.com/rethinkdb/horizon/blob/next/client/src/ast.js\nexport default <Value>(\n  state: undefined | Value[],\n  changes: Changes<Value>,\n  keyPath: string,\n): undefined | Value[] => {\n  if (changes.length === 1) {\n    const firstChange = changes[0];\n    if (firstChange.type === 'initial') {\n      return firstChange.initial;\n    }\n  }\n\n  if (state === undefined) return state;\n\n  return changes.reduce(\n    (stateValue: Value[], change: Change<Value>) =>\n      applyChange(stateValue, change, keyPath),\n    state,\n  );\n};\n","import { useEffect, useReducer, useRef } from 'react';\nimport { BaseModel, Changes } from 'liwi-types';\nimport { AbstractQuery, SubscribeResult } from 'liwi-store';\nimport Logger from 'nightingale-logger';\nimport applyChanges from '../applyChanges';\nimport reducer, { Reducer, initReducer } from '../reducer';\n\ninterface UseResourceAndSubscribeOptions {\n  visibleTimeout: number;\n}\n\nconst defaultOptions = {\n  visibleTimeout: 1000 * 60 * 2, // 2 minutes\n};\n\nconst logger = new Logger('react-liwi:useResourceAndSubscribe');\n\nexport default function useRetrieveResourceAndSubscribe<\n  Model extends BaseModel\n>(\n  createQuery: () => AbstractQuery<Model>,\n  { visibleTimeout }: UseResourceAndSubscribeOptions = defaultOptions,\n) {\n  const subscribeResultRef = useRef<SubscribeResult<Model[]> | undefined>(\n    undefined,\n  );\n  const timeoutRef = useRef<ReturnType<typeof setTimeout> | undefined>(\n    undefined,\n  );\n  const resultRef = useRef<Model[] | undefined>(undefined);\n\n  const unsubscribe = (): void => {\n    logger.log('unsubscribe');\n\n    // reset timeout to allow resubscribing\n    timeoutRef.current = undefined;\n    resultRef.current = undefined;\n\n    if (subscribeResultRef.current) {\n      subscribeResultRef.current.stop();\n      subscribeResultRef.current = undefined;\n    }\n  };\n\n  const [state, dispatch] = useReducer<Reducer<Model[]>, () => Promise<void>>(\n    reducer,\n    () =>\n      new Promise((resolve, reject) => {\n        const query = createQuery();\n        const queryLogger = logger.context({\n          resourceName: (query as any).client.resourceName,\n          key: (query as any).key,\n        });\n        queryLogger.debug('init');\n\n        const subscribe = (): void => {\n          queryLogger.debug('subscribing', {\n            subscribeResultRef: subscribeResultRef.current,\n            timeoutRef: timeoutRef.current,\n          });\n          subscribeResultRef.current = query.fetchAndSubscribe(\n            (err: Error | null, changes: Changes<Model>) => {\n              queryLogger.debug('received changes', {\n                err,\n                changes,\n              });\n              if (err) {\n                // eslint-disable-next-line no-alert\n                alert(`Unexpected error: ${err}`);\n                return;\n              }\n\n              const currentResult = resultRef.current;\n              const newResult = applyChanges(\n                currentResult,\n                changes,\n                '_id', // TODO get keyPath from client(/store)\n              );\n\n              if (newResult && newResult !== currentResult) {\n                resultRef.current = newResult;\n                dispatch({ type: 'resolve', result: newResult });\n              }\n            },\n          );\n        };\n\n        const handleVisibilityChange = () => {\n          if (!document.hidden) {\n            if (timeoutRef.current !== undefined) {\n              queryLogger.debug('timeout cleared');\n              clearTimeout(timeoutRef.current);\n              timeoutRef.current = undefined;\n            } else if (!subscribeResultRef.current) {\n              queryLogger.info('resubscribe');\n              subscribe();\n            }\n            return;\n          }\n\n          if (subscribeResultRef.current === undefined) return;\n\n          queryLogger.debug('timeout visible');\n          timeoutRef.current = setTimeout(unsubscribe, visibleTimeout);\n        };\n\n        document.addEventListener(\n          'visibilitychange',\n          handleVisibilityChange,\n          false,\n        );\n\n        if (!document.hidden) {\n          subscribe();\n        }\n      }),\n    initReducer,\n  );\n\n  useEffect(() => {\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n        timeoutRef.current = undefined;\n      }\n\n      unsubscribe();\n    };\n  }, []);\n\n  return state;\n}\n","/* eslint-disable import/export */\n\nimport { POB_TARGET } from 'pob-babel';\nimport { AbstractQuery } from 'liwi-store';\nimport { BaseModel } from 'liwi-types';\nimport { InitialState, FetchedState } from '../reducer';\nimport useRetrieveResource from './useRetrieveResource';\nimport useRetrieveResourceAndSubscribe from './useRetrieveResourceAndSubscribe';\n\ntype CreateQuery<M extends BaseModel> = () => AbstractQuery<M>;\ntype UseResourceResult<Results> = [true, []] | [false, Results];\n\nexport default function useResources<T1 extends BaseModel>(\n  createQueries: [CreateQuery<T1>],\n  queriesToSubscribe: [boolean],\n): UseResourceResult<[T1[]]>;\nexport default function useResources<\n  T1 extends BaseModel,\n  T2 extends BaseModel\n>(\n  createQueries: [CreateQuery<T1>, CreateQuery<T2>],\n  queriesToSubscribe: [boolean, boolean],\n): UseResourceResult<[T1[], T2[]]>;\nexport default function useResources<\n  T1 extends BaseModel,\n  T2 extends BaseModel,\n  T3 extends BaseModel\n>(\n  createQueries: [CreateQuery<T1>, CreateQuery<T2>, CreateQuery<T3>],\n  queriesToSubscribe: [boolean, boolean, boolean],\n): UseResourceResult<[T1[], T2[], T3[]]>;\nexport default function useResources<\n  T1 extends BaseModel,\n  T2 extends BaseModel,\n  T3 extends BaseModel,\n  T4 extends BaseModel\n>(\n  createQueries: [\n    CreateQuery<T1>,\n    CreateQuery<T2>,\n    CreateQuery<T3>,\n    CreateQuery<T4>\n  ],\n  queriesToSubscribe: [boolean, boolean, boolean, boolean],\n): UseResourceResult<[T1[], T2[], T3[], T4[]]>;\nexport default function useResources<\n  T1 extends BaseModel,\n  T2 extends BaseModel,\n  T3 extends BaseModel,\n  T4 extends BaseModel,\n  T5 extends BaseModel\n>(\n  createQueries: [\n    CreateQuery<T1>,\n    CreateQuery<T2>,\n    CreateQuery<T3>,\n    CreateQuery<T4>,\n    CreateQuery<T5>\n  ],\n  queriesToSubscribe: [boolean, boolean, boolean, boolean, boolean],\n): UseResourceResult<[T1[], T2[], T3[], T4[], T5[]]>;\nexport default function useResources<T extends BaseModel>(\n  createQueries: (CreateQuery<T>)[],\n  queriesToSubscribe: boolean[],\n): UseResourceResult<T[][]> {\n  if (POB_TARGET === 'node') return [true, []];\n\n  const states = createQueries.map((createQuery, index) => {\n    return queriesToSubscribe[index]\n      ? // eslint-disable-next-line react-hooks/rules-of-hooks\n        useRetrieveResourceAndSubscribe(createQuery)\n      : // eslint-disable-next-line react-hooks/rules-of-hooks\n        useRetrieveResource(createQuery);\n  });\n\n  const nonFetchedStates: InitialState[] = states.filter(\n    (state) => !state.fetched,\n  ) as InitialState[];\n\n  if (nonFetchedStates.length !== 0) {\n    return [true, []];\n  }\n\n  return [false, states.map((state) => (state as FetchedState<any>).result)];\n}\n","import { POB_TARGET } from 'pob-babel';\nimport { AbstractQuery } from 'liwi-store';\nimport { BaseModel } from 'liwi-types';\nimport useRetrieveResource from './useRetrieveResource';\nimport useRetrieveResourceAndSubscribe from './useRetrieveResourceAndSubscribe';\n\ntype UseResourceResult<Result> = [true, undefined] | [false, Result];\n\nexport default function useResource<Model extends BaseModel>(\n  createQuery: () => AbstractQuery<Model>,\n  subscribe: boolean,\n): UseResourceResult<Model[]> {\n  if (POB_TARGET === 'node') return [true, undefined];\n\n  const state = subscribe\n    ? // eslint-disable-next-line react-hooks/rules-of-hooks\n      useRetrieveResourceAndSubscribe(createQuery)\n    : // eslint-disable-next-line react-hooks/rules-of-hooks\n      useRetrieveResource(createQuery);\n\n  if (!state.fetched) {\n    return [true, undefined];\n  }\n\n  return [false, state.result];\n}\n"],"names":["initReducer","initializer","fetched","promise","reducer","state","action","type","result","Error","useRetrieveResource","createQuery","useReducer","fetch","resolve","dispatch","copy","slice","applyChange","change","keyPath","initial","objects","length","deletedKeys","keys","filter","value","includes","newState","forEach","newObject","index","findIndex","o","changes","firstChange","undefined","reduce","stateValue","defaultOptions","visibleTimeout","logger","Logger","useRetrieveResourceAndSubscribe","subscribeResultRef","useRef","timeoutRef","resultRef","unsubscribe","log","current","stop","Promise","query","queryLogger","context","resourceName","client","key","debug","subscribe","fetchAndSubscribe","err","alert","currentResult","newResult","applyChanges","document","addEventListener","handleVisibilityChange","hidden","clearTimeout","info","setTimeout","useEffect","useResources","createQueries","queriesToSubscribe","states","map","nonFetchedStates","useResource"],"mappings":"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"}