{"version":3,"file":"index-node14.cjs","sources":["../src/useResource.ts","../src/usePaginatedResource.ts","../src/useOperation.ts","../src/TransportClientProvider.tsx","../src/index.ts"],"sourcesContent":["import { POB_TARGET } from 'pob-babel';\nimport type { Query, QueryParams } from 'liwi-resources-client';\nimport type { SetOptional } from 'liwi-types';\nimport type { ResourceResult } from './createResourceResultFromState';\nimport { useRetrieveResource } from './useRetrieveResource';\nimport type { UseResourceAndSubscribeOptions } from './useRetrieveResourceAndSubscribe';\nimport { useRetrieveResourceAndSubscribe } from './useRetrieveResourceAndSubscribe';\n\ninterface UseResourceOptionsRequiredParams<Params extends QueryParams<Params>> {\n  params: Params;\n  skip?: boolean;\n  subscribe?: boolean;\n  subscribeOptions?: UseResourceAndSubscribeOptions;\n}\n\nexport type UseResourceOptions<Params extends QueryParams<Params>> =\n  Params extends Record<string, never>\n    ? SetOptional<UseResourceOptionsRequiredParams<Params>, 'params'>\n    : UseResourceOptionsRequiredParams<Params>;\n\nconst isSSR = typeof window === 'undefined';\n\nexport function useResource<Result, Params extends QueryParams<Params>>(\n  createQuery: (initialParams: Params) => Query<Result, Params>,\n  {\n    params,\n    skip = false,\n    subscribe,\n    subscribeOptions,\n  }: UseResourceOptions<Params>,\n  deps: any[],\n): ResourceResult<Result, Params> {\n  if (POB_TARGET === 'node') {\n    return {\n      query: undefined as any,\n      initialLoading: true,\n      initialError: false,\n      fetched: false,\n      fetching: true,\n      data: undefined,\n      meta: undefined,\n      queryInfo: undefined,\n      error: undefined,\n    };\n  }\n\n  const result =\n    subscribe && !isSSR\n      ? // eslint-disable-next-line react-hooks/rules-of-hooks\n        useRetrieveResourceAndSubscribe<Result, Params>(\n          createQuery,\n          params as Params,\n          skip,\n          deps,\n          subscribeOptions,\n        )\n      : // eslint-disable-next-line react-hooks/rules-of-hooks\n        useRetrieveResource<Result, Params>(\n          createQuery,\n          params as Params,\n          skip,\n          deps,\n        );\n\n  return result;\n}\n","import type { Query, QueryParams } from 'liwi-resources-client';\nimport { useMemo } from 'react';\nimport type {\n  ResourceResultInitialLoading,\n  ResourceResultInitialError,\n  ResourceResultLoaded,\n} from './createResourceResultFromState';\nimport type { UseResourceOptions } from './useResource';\nimport { useResource } from './useResource';\n\ntype PaginatedQueryParams<Params extends Record<string, unknown>> =\n  QueryParams<Params> & Record<'page', number>;\n\ntype UsePaginatedResourceOptions<Params extends PaginatedQueryParams<Params>> =\n  UseResourceOptions<Params>;\n\ninterface Pagination {\n  totalPages: number;\n}\n\ninterface PaginatedResourceResultInitialLoading<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> extends ResourceResultInitialLoading<Data, Params> {\n  pagination: undefined;\n}\n\ninterface PaginatedResourceResultInitialError<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> extends ResourceResultInitialError<Data, Params> {\n  pagination: undefined;\n}\n\ninterface PaginatedResourceResultLoaded<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> extends ResourceResultLoaded<Data, Params> {\n  pagination: Pagination;\n}\n\nexport type PaginatedResourceResult<\n  Data,\n  Params extends PaginatedQueryParams<Params>,\n> =\n  | PaginatedResourceResultInitialLoading<Data, Params>\n  | PaginatedResourceResultInitialError<Data, Params>\n  | PaginatedResourceResultLoaded<Data, Params>;\n\nexport function usePaginatedResource<\n  Result,\n  Params extends PaginatedQueryParams<Params>,\n>(\n  createQuery: (initialParams: Params) => Query<Result, Params>,\n  options: UsePaginatedResourceOptions<Params>,\n  deps: any[],\n): PaginatedResourceResult<Result, Params> {\n  const result = useResource(createQuery, options, deps);\n  const total = result.meta?.total;\n  const limit = result.queryInfo?.limit;\n\n  const pagination = useMemo<Pagination | undefined>(() => {\n    if (total === undefined) return undefined;\n\n    return {\n      totalPages: limit ? Math.ceil(total / limit) : 1,\n    };\n  }, [total, limit]);\n\n  return useMemo(\n    () =>\n      ({ ...result, pagination } as PaginatedResourceResult<Result, Params>),\n    [result, pagination],\n  );\n}\n","import { useCallback, useState } from 'react';\n\nexport interface OperationState {\n  loading: boolean;\n  error: undefined | Error;\n}\n\nexport type OperationCallWrapper<T extends (...args: any) => Promise<any>> = (\n  ...args: Parameters<T>\n) => Promise<[undefined | Error | any, undefined | ReturnType<T>]>;\n\nexport function useOperation<T extends (...args: any) => Promise<any>>(\n  operationCall: T,\n): [OperationCallWrapper<T>, OperationState] {\n  const [state, setState] = useState<OperationState>(() => ({\n    loading: false,\n    error: undefined,\n  }));\n\n  const operationCallWrapper = useCallback<OperationCallWrapper<T>>(\n    (...params: Parameters<T>) => {\n      setState({\n        loading: true,\n        error: undefined,\n      });\n      try {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        return operationCall(...(params as any)).then(\n          (result) => {\n            setState({\n              loading: false,\n              error: undefined,\n            });\n            return [undefined, result];\n          },\n          (err) => {\n            setState({\n              loading: false,\n              error: err,\n            });\n            return [err, undefined];\n          },\n        );\n      } catch (err) {\n        setState({\n          loading: false,\n          error: err as Error,\n        });\n        return Promise.resolve([err, undefined]);\n      }\n    },\n    [operationCall],\n  );\n  return [operationCallWrapper, state];\n}\n","import type { TransportClient, ConnectionStates } from 'liwi-resources-client';\nimport type { ReactElement, ReactNode } from 'react';\nimport { useContext, createContext, useState, useEffect } from 'react';\n\nexport const TransportClientContext = createContext<TransportClient>(\n  undefined as unknown as TransportClient,\n);\n\nexport const TransportClientStateContext =\n  createContext<ConnectionStates>('opening');\nexport const TransportClientReadyContext = createContext<boolean>(false);\n\nexport const useTransportClientState = (): ConnectionStates =>\n  useContext(TransportClientStateContext);\nexport const useTransportClientIsReady = (): boolean =>\n  useContext(TransportClientReadyContext);\n\ntype TransportClientProviderProps<P extends Record<never, unknown>> = {\n  createFn: (params: Omit<P, 'createFn' | 'children'>) => TransportClient;\n  children: ReactNode;\n} & P;\n\nexport function TransportClientProvider<P extends Record<never, unknown>>({\n  createFn,\n  children,\n  ...params\n}: TransportClientProviderProps<P>): ReactElement {\n  const [client] = useState(() => {\n    return createFn(params);\n  });\n  const [connectionState, setConnectionState] =\n    useState<ConnectionStates>('opening');\n\n  useEffect(() => {\n    const closeConnectionStateListener =\n      client.listenStateChange(setConnectionState);\n    client.connect();\n\n    return (): void => {\n      closeConnectionStateListener();\n      client.close();\n    };\n  }, [client]);\n\n  return (\n    <TransportClientContext.Provider value={client}>\n      <TransportClientStateContext.Provider value={connectionState}>\n        <TransportClientReadyContext.Provider\n          value={connectionState === 'connected'}\n        >\n          {children}\n        </TransportClientReadyContext.Provider>\n      </TransportClientStateContext.Provider>\n    </TransportClientContext.Provider>\n  );\n}\n","import type { ConnectionStates } from 'liwi-resources-client/src/TransportClient';\n\nexport { useResource } from './useResource';\nexport { usePaginatedResource } from './usePaginatedResource';\nexport { useOperation } from './useOperation';\nexport type { OperationCallWrapper } from './useOperation';\nexport type { ResourceResult } from './createResourceResultFromState';\nexport {\n  TransportClientProvider,\n  TransportClientContext,\n  TransportClientStateContext,\n  TransportClientReadyContext,\n  useTransportClientState,\n  useTransportClientIsReady,\n} from './TransportClientProvider';\nexport { ResourcesServerError } from 'liwi-resources-client';\n\nexport type SimplifiedConnectionState =\n  | 'connecting'\n  | 'connected'\n  | 'disconnected';\n\nexport const transportClientStateToSimplifiedState = (\n  state: ConnectionStates,\n): SimplifiedConnectionState => {\n  switch (state) {\n    case 'opening':\n    case 'connecting':\n    case 'reconnect-scheduled':\n    case 'wait-for-visibility':\n      return 'connecting';\n\n    case 'connected':\n      return 'connected';\n\n    case 'closed':\n      return 'disconnected';\n  }\n};\n"],"names":["useResource","createQuery","params","skip","subscribe","subscribeOptions","deps","query","undefined","initialLoading","initialError","fetched","fetching","data","meta","queryInfo","error","usePaginatedResource","options","result","total","limit","pagination","useMemo","totalPages","Math","ceil","useOperation","operationCall","state","setState","useState","loading","operationCallWrapper","useCallback","then","err","Promise","resolve","TransportClientContext","createContext","TransportClientStateContext","TransportClientReadyContext","useTransportClientState","useContext","useTransportClientIsReady","TransportClientProvider","createFn","children","client","connectionState","setConnectionState","useEffect","closeConnectionStateListener","listenStateChange","connect","close","_jsx","transportClientStateToSimplifiedState"],"mappings":"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"}