{"version":3,"file":"index-browser-dev.cjs.js","sources":["../src/createSimpleWebsocketClient.ts","../src/createWebsocketTransportClient.ts"],"sourcesContent":["/* eslint-disable unicorn/prefer-add-event-listener */\nimport Backoff from 'backo2';\n\ntype States =\n  | 'closed'\n  | 'opening'\n  | 'connecting'\n  | 'connected'\n  | 'reconnecting';\n\nexport type StateChangeListener = (newState: States) => void;\n\nexport type StateChangeListenerCreator = (\n  listener: StateChangeListener,\n) => () => void;\n\nexport interface SimpleWebsocketClientOptions {\n  url: string;\n  protocols?: string | string[];\n  timeout?: number;\n  reconnection?: boolean;\n  reconnectionDelayMin?: number;\n  reconnectionDelayMax?: number;\n  reconnectionAttempts?: number;\n  inactivityTimeout?: number;\n  onMessage: (message: MessageEvent) => void;\n  onError: (event: Event) => void;\n}\n\ntype Message = Parameters<WebSocket['send']>[0];\n\nexport interface WebsocketTransport {\n  connect(): void;\n  close(): void;\n  isConnected(): boolean;\n  sendMessage(message: Message): void;\n  listenStateChange: StateChangeListenerCreator;\n}\n\ntype Timeouts = 'maxConnect' | 'tryReconnect' | 'inactivity';\n\nexport default function createSimpleWebsocketClient({\n  url,\n  protocols,\n  reconnection = true,\n  reconnectionDelayMin = 1000,\n  reconnectionDelayMax = 30000,\n  reconnectionAttempts = Infinity,\n  onMessage,\n  onError,\n}: SimpleWebsocketClientOptions): WebsocketTransport {\n  let ws: WebSocket | null = null;\n  let currentState: States = 'closed';\n  let isConnected = false;\n  const stateChangeListeners = new Set<StateChangeListener>();\n\n  const backoff = new Backoff({\n    min: reconnectionDelayMin,\n    max: reconnectionDelayMax,\n    factor: 1.2,\n  });\n\n  const timeouts: Record<Timeouts, null | ReturnType<typeof setTimeout>> = {\n    maxConnect: null,\n    tryReconnect: null,\n    inactivity: null,\n  };\n\n  const setCurrentState = (newState: States): void => {\n    if (currentState === newState) return;\n    currentState = newState;\n    isConnected = currentState === 'connected';\n    stateChangeListeners.forEach((listener) => listener(newState));\n  };\n\n  const clearInternalTimeout = (timeoutKey: Timeouts): void => {\n    const timeout = timeouts[timeoutKey];\n    if (timeout) {\n      clearTimeout(timeout);\n      timeouts[timeoutKey] = null;\n    }\n  };\n\n  const closeWebsocket = (): void => {\n    clearInternalTimeout('inactivity');\n    if (ws) {\n      clearInternalTimeout('maxConnect');\n      clearInternalTimeout('tryReconnect');\n      ws = null;\n      setCurrentState('closed');\n    }\n  };\n\n  let tryReconnect: () => void;\n\n  const connect = (): void => {\n    setCurrentState('opening');\n    const webSocket = new WebSocket(url, protocols);\n    ws = webSocket;\n    clearInternalTimeout('maxConnect');\n    webSocket.onopen = (): void => {\n      setCurrentState('connecting');\n      clearInternalTimeout('maxConnect');\n    };\n\n    webSocket.onclose = (): void => {\n      if (currentState !== 'closed') {\n        if (tryReconnect) {\n          tryReconnect();\n        } else {\n          closeWebsocket();\n        }\n      }\n    };\n\n    webSocket.onmessage = (message): void => {\n      if (message.data === 'connection-ack') {\n        setCurrentState('connected');\n      } else {\n        onMessage(message);\n      }\n    };\n\n    webSocket.onerror = (event): void => {\n      onError(event);\n    };\n  };\n\n  if (reconnection) {\n    tryReconnect = () => {\n      if (backoff.attempts >= reconnectionAttempts) {\n        return;\n      }\n\n      if (currentState === 'reconnecting') {\n        return;\n      }\n\n      setCurrentState('reconnecting');\n      clearInternalTimeout('tryReconnect');\n      const delay = backoff.duration();\n      timeouts.tryReconnect = setTimeout(() => {\n        connect();\n      }, delay);\n    };\n  }\n\n  const wsTransport: WebsocketTransport = {\n    connect,\n\n    close() {\n      if (ws) {\n        if (currentState === 'connected') {\n          ws.send('close');\n        }\n        closeWebsocket();\n      }\n    },\n\n    isConnected() {\n      return isConnected;\n    },\n\n    sendMessage(message): void {\n      if (!ws) throw new Error('Cannot send message');\n      ws.send(message);\n    },\n\n    listenStateChange: (listener) => {\n      stateChangeListeners.add(listener);\n      return (): void => {\n        stateChangeListeners.delete(listener);\n      };\n    },\n  };\n\n  return wsTransport;\n}\n","/* eslint-disable max-lines */\nimport { encode, decode, ExtendedJsonValue } from 'extended-json';\nimport { ResourcesServerError } from 'liwi-resources-client';\nimport type {\n  TransportClient,\n  TransportClientSubscribeCallback,\n  TransportClientSubscribeResult,\n  ToClientMessage,\n  ToServerMessages,\n  ToServerSubscribeMessages,\n  AckError,\n} from 'liwi-resources-client';\nimport Logger from 'nightingale-logger';\nimport createSimpleWebsocketClient, {\n  SimpleWebsocketClientOptions,\n} from './createSimpleWebsocketClient';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\ntype Resolve<T> = (result: T) => void;\ntype Reject = (reason?: any) => void;\n\ninterface Ack<T> {\n  reject: Reject;\n  resolve: Resolve<T>;\n}\n\ninterface Subscription<\n  T extends keyof ToServerSubscribeMessages<any>,\n  U,\n  Message extends { payload: any } = any\n> extends Ack<U> {\n  type: T;\n  message: Message;\n  callback: TransportClientSubscribeCallback<U>;\n}\n\nexport type WebsocketTransportClientOptions = Omit<\n  SimpleWebsocketClientOptions,\n  'onMessage' | 'url'\n> &\n  Partial<Pick<SimpleWebsocketClientOptions, 'url'>>;\n\ntype PromiseExecutor<T> = (\n  resolve: (value?: T | PromiseLike<T>) => void,\n  reject: (reason?: any) => void,\n) => void;\n\ntype Handler<T> = (id: number, error: AckError | null, result: T) => void;\n\nclass SubscribeResultPromise<\n  Result,\n  Payload extends Record<keyof Payload & string, ExtendedJsonValue | undefined>\n>\n  implements\n    TransportClientSubscribeResult<Result, Payload>,\n    PromiseLike<Result> {\n  private readonly promise: Promise<Result>;\n\n  readonly stop: TransportClientSubscribeResult<Result, Payload>['stop'];\n\n  readonly cancel: TransportClientSubscribeResult<Result, Payload>['cancel'];\n\n  // readonly changePayload: TransportClientSubscribeResult<\n  //   Result,\n  //   Payload\n  // >['changePayload'];\n\n  constructor({\n    executor,\n    stop,\n  }: {\n    executor: PromiseExecutor<Result>;\n    stop: TransportClientSubscribeResult<Result, Payload>['stop'];\n    // changePayload: TransportClientSubscribeResult<\n    //   Result,\n    //   Payload\n    // >['changePayload'];\n  }) {\n    this.promise = new Promise((resolve, reject) => {\n      return executor(resolve, reject);\n    });\n    this.stop = stop;\n    this.cancel = stop;\n    // this.changePayload = changePayload;\n  }\n\n  then<TResult1 = Result, TResult2 = never>(\n    onfulfilled?:\n      | ((value: Result) => TResult1 | PromiseLike<TResult1>)\n      | null\n      | undefined,\n    onrejected?:\n      | ((reason: any) => TResult2 | PromiseLike<TResult2>)\n      | null\n      | undefined,\n  ): PromiseLike<TResult1 | TResult2> {\n    return this.promise.then(onfulfilled, onrejected);\n  }\n\n  catch<TResult2 = never>(\n    onrejected?:\n      | ((reason: any) => TResult2 | PromiseLike<TResult2>)\n      | null\n      | undefined,\n  ): PromiseLike<Result | TResult2> {\n    return this.promise.catch(onrejected);\n  }\n}\n\n// TODO handle resubscriptions after reconnect (or in useEffect ?)\n// TODO handle send before connected\n// TODO reject on connection close OR keep promise hang ?\n\nconst createSafeError = (error: AckError): ResourcesServerError => {\n  return new ResourcesServerError(error.code, error.message);\n};\n\nexport default function createResourcesWebsocketClient({\n  url,\n  ...options\n}: WebsocketTransportClientOptions): TransportClient {\n  let currentId = 1;\n  let currentSubscriptionId = 1;\n  const acks = new Map<number, Ack<any>>(); // TODO in progress / unsent / sending => find better name\n  const subscriptions = new Map<number, Subscription<any, any>>();\n\n  if (!url) {\n    url = `ws${window.location.protocol === 'https' ? 's' : ''}://${\n      window.location.host\n    }/ws`;\n  }\n  logger.info('create', { url });\n\n  const handlers: Record<ToClientMessage[0], Handler<any>> = {\n    ack: (id, error, result) => {\n      logger.debug('ack', { id });\n      const ack = acks.get(id);\n      if (!ack) {\n        logger.warn('no ack found', { id });\n      } else if (error) {\n        ack.reject(createSafeError(error));\n      } else {\n        ack.resolve(result);\n      }\n    },\n    subscription: (id, error, result) => {\n      logger.debug('subscription', { id });\n      const subscription = subscriptions.get(id);\n      if (!subscription) {\n        if (id < currentSubscriptionId) {\n          logger.warn('subscription previously closed', { id });\n        } else {\n          logger.warn('no subscription found', { id });\n        }\n      } else if (error) {\n        subscription.callback(createSafeError(error), null);\n      } else {\n        subscription.callback(null, result);\n      }\n    },\n  };\n\n  const wsClient = createSimpleWebsocketClient({\n    ...options,\n    url,\n    onMessage: (event) => {\n      logger.info('message', { data: event.data });\n      const [type, id, error, result] = decode<ToClientMessage>(event.data);\n      const handler = handlers[type];\n\n      if (handler) {\n        handler(id, error, result);\n      }\n    },\n  });\n\n  const sendMessage = <T extends keyof ToServerMessages>(\n    type: T,\n    id: number | null,\n    payload: ToServerMessages[T][0],\n  ): void => wsClient.sendMessage(encode([type, id, payload as any]));\n\n  const sendWithAck = <T extends keyof ToServerMessages>(\n    type: T,\n    message: ToServerMessages[T][0],\n  ): Promise<ToServerMessages[T][1]> => {\n    return new Promise((resolve, reject) => {\n      const id = currentId++;\n      acks.set(id, {\n        resolve: (result) => {\n          acks.delete(id);\n          resolve(result);\n        },\n        reject: (err) => {\n          acks.delete(id);\n          reject(err);\n        },\n      });\n      sendMessage(type, id, message);\n    });\n  };\n\n  const sendThrowNotConnected = (): never => {\n    const error = new Error('Websocket not connected');\n    error.name = 'NetworkError';\n    throw error;\n  };\n\n  const resourcesClient: TransportClient = {\n    connect: () => wsClient.connect(),\n    close: () => wsClient.close(),\n    listenStateChange: wsClient.listenStateChange,\n    send: sendThrowNotConnected,\n\n    subscribe: <\n      T extends keyof ToServerSubscribeMessages<Payload>,\n      Payload extends Record<keyof Payload & string, ExtendedJsonValue>,\n      Result,\n      V extends ToServerSubscribeMessages<Payload>[T][2]\n    >(\n      type: T,\n      messageWithoutSubscriptionId: Omit<\n        ToServerSubscribeMessages<Payload, Result>[T][0],\n        'subscriptionId'\n      >,\n      callback: TransportClientSubscribeCallback<V>,\n    ): TransportClientSubscribeResult<Result, Payload> => {\n      const id = currentId++;\n      const subscriptionId = currentSubscriptionId++;\n      const message = { ...messageWithoutSubscriptionId, subscriptionId };\n\n      return new SubscribeResultPromise<Result, Payload>({\n        executor: (resolve, reject) => {\n          subscriptions.set(subscriptionId, {\n            type,\n            message,\n            resolve,\n            reject,\n            callback,\n          });\n          if (wsClient.isConnected()) {\n            // TODO reject should remove subscription ?\n            sendWithAck(type, message).then(resolve, reject);\n          }\n        },\n        stop: (): void => {\n          acks.delete(id);\n          subscriptions.delete(subscriptionId);\n          // TODO what if reconnect (backend keeps subscription) and closed at this time ?\n          if (wsClient.isConnected()) {\n            sendMessage('subscribe:close', null, { subscriptionId });\n          }\n        },\n\n        // changePayload: (payload: Payload): Promise<void> => {\n        //   return new Promise((resolve, reject) => {\n        //     const subscription = subscriptions.get(subscriptionId);\n        //     if (!subscription) return reject(new Error('Invalid subscription'));\n        //     subscription.message.payload = payload;\n        //     if (wsClient.isConnected()) {\n        //       sendWithAck('subscribe:changePayload', payload).then(\n        //         resolve,\n        //         reject,\n        //       );\n        //     } else {\n        //       return reject(new Error('Not connected'));\n        //     }\n        //   });\n        // },\n      });\n    },\n  };\n\n  wsClient.listenStateChange((newState) => {\n    logger.info('newState', { newState });\n    if (newState === 'connected') {\n      resourcesClient.send = sendWithAck as TransportClient['send'];\n      subscriptions.forEach((subscription, subscriptionId) => {\n        sendWithAck(subscription.type, subscription.message).then(\n          subscription.resolve,\n          subscription.reject,\n        );\n      });\n    } else {\n      resourcesClient.send = sendThrowNotConnected;\n      acks.forEach((ack) => {\n        ack.reject(\n          new Error(`Failed to get ack, connection state is now ${newState}`),\n        );\n      });\n      acks.clear();\n\n      if (newState === 'closed') {\n        subscriptions.forEach((subscription) => {\n          subscription.reject(new Error('Subscription closed'));\n        });\n      }\n    }\n  });\n\n  return resourcesClient;\n}\n"],"names":["createSimpleWebsocketClient","url","protocols","reconnection","reconnectionDelayMin","reconnectionDelayMax","reconnectionAttempts","Infinity","onMessage","onError","ws","currentState","isConnected","stateChangeListeners","Set","backoff","Backoff","min","max","factor","timeouts","maxConnect","tryReconnect","inactivity","setCurrentState","newState","forEach","listener","clearInternalTimeout","timeoutKey","timeout","clearTimeout","closeWebsocket","connect","webSocket","WebSocket","onopen","onclose","onmessage","message","data","onerror","event","attempts","delay","duration","setTimeout","wsTransport","close","send","sendMessage","Error","listenStateChange","add","delete","logger","Logger","SubscribeResultPromise","executor","stop","promise","Promise","resolve","reject","cancel","then","onfulfilled","onrejected","catch","createSafeError","error","ResourcesServerError","code","createResourcesWebsocketClient","options","currentId","currentSubscriptionId","acks","Map","subscriptions","window","location","protocol","host","info","handlers","ack","id","result","debug","get","warn","subscription","callback","wsClient","decode","type","handler","payload","encode","sendWithAck","set","err","sendThrowNotConnected","name","resourcesClient","subscribe","messageWithoutSubscriptionId","subscriptionId","clear"],"mappings":"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"}