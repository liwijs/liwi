{"version":3,"file":"index-node10.es.js","sources":["../src/WebsocketClient.ts"],"sourcesContent":["import Logger from 'nightingale-logger';\nimport { encode, decode } from 'extended-json';\nimport { BaseModel, QueryOptions } from 'liwi-types';\nimport { AbstractClient } from 'liwi-resources-client';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\nexport interface Websocket {\n  emit: (event: string, ...args: any[]) => Promise<any>;\n  isConnected: () => boolean;\n  isDisconnected: () => boolean;\n  on: <T extends Function>(event: string, handler: T) => T;\n  off: (event: string, handler: Function) => void;\n}\n\ntype UnsubscribeCallback = () => void;\n\nexport default class WebsocketClient<\n  Model extends BaseModel,\n  KeyPath extends string\n> extends AbstractClient<Model, KeyPath> {\n  readonly resourceName: string;\n\n  private readonly websocket: Websocket;\n\n  // eslint-disable-next-line typescript/member-ordering\n  constructor(websocket: Websocket, resourceName: string, keyPath: KeyPath) {\n    super(resourceName, keyPath);\n    this.websocket = websocket;\n    this.resourceName = resourceName;\n  }\n\n  emitSubscribe(type: string, ...args: any[]): Promise<UnsubscribeCallback> {\n    const websocket = this.websocket;\n    const emit = () => this.send(type, ...args);\n    const registerOnConnect = () => {\n      websocket.on('connect', emit);\n      return () => {\n        websocket.off('connect', emit);\n      };\n    };\n\n    if (websocket.isConnected()) {\n      return emit().then(registerOnConnect);\n    }\n\n    return Promise.resolve(registerOnConnect());\n  }\n\n  createCursor(options: QueryOptions<Model>): Promise<number> {\n    return this.websocket.emit('createCursor', options);\n  }\n\n  send(type: string, ...args: any[]) {\n    logger.debug('emit', { type, args });\n    if (this.websocket.isDisconnected()) {\n      throw new Error('Websocket is not connected');\n    }\n\n    if (!this.resourceName) {\n      throw new Error('Invalid resourceName');\n    }\n\n    return this.websocket\n      .emit('resource', {\n        type,\n        resourceName: this.resourceName,\n        json: encode(args),\n      })\n      .then((result: any) => result && decode(result));\n  }\n\n  on(event: string, handler: Function) {\n    this.websocket.on(event, handler);\n    return handler;\n  }\n\n  off(event: string, handler: Function) {\n    this.websocket.off(event, handler);\n  }\n}\n"],"names":["logger","Logger","WebsocketClient","AbstractClient","constructor","websocket","resourceName","keyPath","emitSubscribe","type","args","emit","send","registerOnConnect","on","off","isConnected","then","Promise","resolve","createCursor","options","debug","isDisconnected","Error","json","encode","result","decode","event","handler"],"mappings":";;;;AAKA,MAAMA,MAAM,GAAG,IAAIC,MAAJ,CAAW,iCAAX,CAAf;AAYA,AAAe,MAAMC,eAAN,SAGLC,cAHK,CAG0B;;EAMvCC,WAAW,CAACC,SAAD,EAAuBC,YAAvB,EAA6CC,OAA7C,EAA+D;UAClED,YAAN,EAAoBC,OAApB;SACKF,SAAL,GAAiBA,SAAjB;SACKC,YAAL,GAAoBA,YAApB;;;EAGFE,aAAa,CAACC,IAAD,EAAe,GAAGC,IAAlB,EAA6D;UAClEL,SAAS,GAAG,KAAKA,SAAvB;;UACMM,IAAI,GAAG,MAAM,KAAKC,IAAL,CAAUH,IAAV,EAAgB,GAAGC,IAAnB,CAAnB;;UACMG,iBAAiB,GAAG,MAAM;MAC9BR,SAAS,CAACS,EAAV,CAAa,SAAb,EAAwBH,IAAxB;aACO,MAAM;QACXN,SAAS,CAACU,GAAV,CAAc,SAAd,EAAyBJ,IAAzB;OADF;KAFF;;QAOIN,SAAS,CAACW,WAAV,EAAJ,EAA6B;aACpBL,IAAI,GAAGM,IAAP,CAAYJ,iBAAZ,CAAP;;;WAGKK,OAAO,CAACC,OAAR,CAAgBN,iBAAiB,EAAjC,CAAP;;;EAGFO,YAAY,CAACC,OAAD,EAAgD;WACnD,KAAKhB,SAAL,CAAeM,IAAf,CAAoB,cAApB,EAAoCU,OAApC,CAAP;;;EAGFT,IAAI,CAACH,IAAD,EAAe,GAAGC,IAAlB,EAA+B;IACjCV,MAAM,CAACsB,KAAP,CAAa,MAAb,EAAqB;MAAEb,IAAF;MAAQC;KAA7B;;QACI,KAAKL,SAAL,CAAekB,cAAf,EAAJ,EAAqC;YAC7B,IAAIC,KAAJ,CAAU,4BAAV,CAAN;;;QAGE,CAAC,KAAKlB,YAAV,EAAwB;YAChB,IAAIkB,KAAJ,CAAU,sBAAV,CAAN;;;WAGK,KAAKnB,SAAL,CACJM,IADI,CACC,UADD,EACa;MAChBF,IADgB;MAEhBH,YAAY,EAAE,KAAKA,YAFH;MAGhBmB,IAAI,EAAEC,MAAM,CAAChB,IAAD;KAJT,EAMJO,IANI,CAMEU,MAAD,IAAiBA,MAAM,IAAIC,MAAM,CAACD,MAAD,CANlC,CAAP;;;EASFb,EAAE,CAACe,KAAD,EAAgBC,OAAhB,EAAmC;SAC9BzB,SAAL,CAAeS,EAAf,CAAkBe,KAAlB,EAAyBC,OAAzB;WACOA,OAAP;;;EAGFf,GAAG,CAACc,KAAD,EAAgBC,OAAhB,EAAmC;SAC/BzB,SAAL,CAAeU,GAAf,CAAmBc,KAAnB,EAA0BC,OAA1B;;;;;;;"}