{"version":3,"file":"index-node8-dev.cjs.js","sources":["../src/WebsocketClient.ts"],"sourcesContent":["import Logger from 'nightingale-logger';\nimport { encode, decode } from 'extended-json';\nimport { BaseModel, QueryOptions } from 'liwi-types';\nimport { AbstractClient } from 'liwi-resources-client';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\nexport interface Websocket {\n  emit: (event: string, ...args: any[]) => Promise<any>;\n  isConnected: () => boolean;\n  isDisconnected: () => boolean;\n  on: <T extends Function>(event: string, handler: T) => T;\n  off: (event: string, handler: Function) => void;\n}\n\ntype UnsubscribeEmitOnConnectCallback = () => void;\n\nexport default class WebsocketClient<\n  Model extends BaseModel,\n  KeyPath extends string\n> extends AbstractClient<Model, KeyPath> {\n  readonly resourceName: string;\n\n  readonly websocket: Websocket;\n\n  // eslint-disable-next-line typescript/member-ordering\n  constructor(websocket: Websocket, resourceName: string, keyPath: KeyPath) {\n    super(resourceName, keyPath);\n    this.websocket = websocket;\n    this.resourceName = resourceName;\n  }\n\n  emitSubscribe(\n    type: string,\n    args: any[],\n  ): Promise<UnsubscribeEmitOnConnectCallback> {\n    const websocket = this.websocket;\n    const emit = () => this.send(type, args);\n    const registerOnConnect = () => {\n      websocket.on('connect', emit);\n      return () => {\n        websocket.off('connect', emit);\n      };\n    };\n\n    if (websocket.isConnected()) {\n      return emit().then(registerOnConnect);\n    }\n\n    return Promise.resolve(registerOnConnect());\n  }\n\n  createCursor(options: QueryOptions<Model>): Promise<number> {\n    return this.websocket.emit('createCursor', options);\n  }\n\n  send(type: string, value: any[]) {\n    logger.debug('emit', { type, value });\n    if (this.websocket.isDisconnected()) {\n      throw new Error('Websocket is not connected');\n    }\n\n    if (!this.resourceName) {\n      throw new Error('Invalid resourceName');\n    }\n\n    return this.websocket\n      .emit('resource', {\n        type,\n        resourceName: this.resourceName,\n        json: encode(value),\n      })\n      .then((result: any) => result && decode(result));\n  }\n\n  on(event: string, handler: Function) {\n    this.websocket.on(event, handler);\n    return handler;\n  }\n\n  off(event: string, handler: Function) {\n    this.websocket.off(event, handler);\n  }\n}\n\nexport function createMongoResourcesWebsocketClient(websocket: Websocket) {\n  return class WebsocketResourcesClient<\n    Model extends BaseModel\n  > extends WebsocketClient<Model, '_id'> {\n    public constructor(resourceName: string) {\n      super(websocket, resourceName, '_id');\n    }\n  };\n}\n"],"names":["logger","Logger","WebsocketClient","AbstractClient","constructor","websocket","resourceName","keyPath","emitSubscribe","type","args","emit","send","registerOnConnect","on","off","isConnected","then","Promise","resolve","createCursor","options","value","debug","isDisconnected","Error","json","encode","result","decode","event","handler","createMongoResourcesWebsocketClient","WebsocketResourcesClient"],"mappings":";;;;;;;;;;AAKA,MAAMA,MAAM,GAAG,IAAIC,MAAJ,CAAW,iCAAX,CAAf;AAYA,AAAe,MAAMC,eAAN,SAGLC,kCAHK,CAG0B;;EAMvCC,WAAW,CAACC,SAAD,EAAuBC,YAAvB,EAA6CC,OAA7C,EAA+D;UAClED,YAAN,EAAoBC,OAApB;SACKF,SAAL,GAAiBA,SAAjB;SACKC,YAAL,GAAoBA,YAApB;;;EAGFE,aAAa,CACXC,IADW,EAEXC,IAFW,EAGgC;UACrCL,SAAS,GAAG,KAAKA,SAAvB;;UACMM,IAAI,GAAG,MAAM,KAAKC,IAAL,CAAUH,IAAV,EAAgBC,IAAhB,CAAnB;;UACMG,iBAAiB,GAAG,MAAM;MAC9BR,SAAS,CAACS,EAAV,CAAa,SAAb,EAAwBH,IAAxB;aACO,MAAM;QACXN,SAAS,CAACU,GAAV,CAAc,SAAd,EAAyBJ,IAAzB;OADF;KAFF;;QAOIN,SAAS,CAACW,WAAV,EAAJ,EAA6B;aACpBL,IAAI,GAAGM,IAAP,CAAYJ,iBAAZ,CAAP;;;WAGKK,OAAO,CAACC,OAAR,CAAgBN,iBAAiB,EAAjC,CAAP;;;EAGFO,YAAY,CAACC,OAAD,EAAgD;WACnD,KAAKhB,SAAL,CAAeM,IAAf,CAAoB,cAApB,EAAoCU,OAApC,CAAP;;;EAGFT,IAAI,CAACH,IAAD,EAAea,KAAf,EAA6B;IAC/BtB,MAAM,CAACuB,KAAP,CAAa,MAAb,EAAqB;MAAEd,IAAF;MAAQa;KAA7B;;QACI,KAAKjB,SAAL,CAAemB,cAAf,EAAJ,EAAqC;YAC7B,IAAIC,KAAJ,CAAU,4BAAV,CAAN;;;QAGE,CAAC,KAAKnB,YAAV,EAAwB;YAChB,IAAImB,KAAJ,CAAU,sBAAV,CAAN;;;WAGK,KAAKpB,SAAL,CACJM,IADI,CACC,UADD,EACa;MAChBF,IADgB;MAEhBH,YAAY,EAAE,KAAKA,YAFH;MAGhBoB,IAAI,EAAEC,mBAAM,CAACL,KAAD;KAJT,EAMJL,IANI,CAMEW,MAAD,IAAiBA,MAAM,IAAIC,mBAAM,CAACD,MAAD,CANlC,CAAP;;;EASFd,EAAE,CAACgB,KAAD,EAAgBC,OAAhB,EAAmC;SAC9B1B,SAAL,CAAeS,EAAf,CAAkBgB,KAAlB,EAAyBC,OAAzB;WACOA,OAAP;;;EAGFhB,GAAG,CAACe,KAAD,EAAgBC,OAAhB,EAAmC;SAC/B1B,SAAL,CAAeU,GAAf,CAAmBe,KAAnB,EAA0BC,OAA1B;;;;AAIJ,AAAO,SAASC,mCAAT,CAA6C3B,SAA7C,EAAmE;SACjE,MAAM4B,wBAAN,SAEG/B,eAFH,CAEiC;IAC/BE,WAAP,CAAmBE,YAAnB,EAAyC;YACjCD,SAAN,EAAiBC,YAAjB,EAA+B,KAA/B;;;GAJJ;;;;;;"}