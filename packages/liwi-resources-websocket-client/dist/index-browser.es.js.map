{"version":3,"file":"index-browser.es.js","sources":["../src/createSimpleWebsocketClient.ts","../src/createWebsocketTransportClient.ts"],"sourcesContent":["/* eslint-disable max-lines */\nimport Backoff from 'backo2';\nimport type { ConnectionStates } from 'liwi-resources-client';\n\nexport type StateChangeListener = (newState: ConnectionStates) => void;\n\nexport type StateChangeListenerCreator = (\n  listener: StateChangeListener,\n) => () => void;\n\nexport interface SimpleWebsocketClientOptions {\n  url: string;\n  protocols?: string | string[];\n  timeout?: number;\n  reconnection?: boolean;\n  reconnectionDelayMin?: number;\n  reconnectionDelayMax?: number;\n  reconnectionAttempts?: number;\n  inactivityTimeout?: number;\n  thirdWebsocketArgument?: unknown;\n  onMessage: (message: MessageEvent) => void;\n  onError?: (event: Event) => void;\n}\n\ntype Message = Parameters<WebSocket['send']>[0];\n\nexport interface WebsocketTransport {\n  connect: () => void;\n  close: () => void;\n  isConnected: () => boolean;\n  sendMessage: (message: Message) => void;\n  listenStateChange: StateChangeListenerCreator;\n}\n\ntype Timeouts = 'maxConnect' | 'tryReconnect' | 'inactivity';\n\nexport default function createSimpleWebsocketClient({\n  url,\n  protocols,\n  reconnection = true,\n  reconnectionDelayMin = 1000,\n  reconnectionDelayMax = 30 * 1000,\n  reconnectionAttempts = Infinity,\n  thirdWebsocketArgument,\n  onMessage,\n  onError,\n}: SimpleWebsocketClientOptions): WebsocketTransport {\n  let ws: WebSocket | null = null;\n  let currentState: ConnectionStates = 'closed';\n  let isConnected = false;\n  const stateChangeListeners = new Set<StateChangeListener>();\n\n  const backoff = new Backoff({\n    min: reconnectionDelayMin,\n    max: reconnectionDelayMax,\n    factor: 1.2,\n  });\n\n  const timeouts: Record<Timeouts, null | ReturnType<typeof setTimeout>> = {\n    maxConnect: null,\n    tryReconnect: null,\n    inactivity: null,\n  };\n\n  const setCurrentState = (newState: ConnectionStates): void => {\n    if (currentState === newState) return;\n    currentState = newState;\n    isConnected = currentState === 'connected';\n    stateChangeListeners.forEach((listener) => {\n      listener(newState);\n    });\n  };\n\n  const clearInternalTimeout = (timeoutKey: Timeouts): void => {\n    const timeout = timeouts[timeoutKey];\n    if (timeout) {\n      clearTimeout(timeout);\n      timeouts[timeoutKey] = null;\n    }\n  };\n\n  const closeWebsocket = (): void => {\n    clearInternalTimeout('inactivity');\n    if (ws) {\n      clearInternalTimeout('maxConnect');\n      clearInternalTimeout('tryReconnect');\n      ws = null;\n      setCurrentState('closed');\n    }\n  };\n\n  let tryReconnect: (() => void) | undefined;\n\n  const connect = (): void => {\n    const webSocket = thirdWebsocketArgument\n      ? // @ts-expect-error third argument for react-native\n        new WebSocket(url, protocols, thirdWebsocketArgument)\n      : new WebSocket(url, protocols);\n    ws = webSocket;\n    clearInternalTimeout('maxConnect');\n    setCurrentState('connecting');\n\n    webSocket.addEventListener('open', (): void => {\n      backoff.reset();\n      clearInternalTimeout('maxConnect');\n    });\n\n    const handleCloseOrError = (): void => {\n      if (currentState === 'closed') return;\n      if (!tryReconnect) {\n        closeWebsocket();\n      } else if (document.visibilityState === 'hidden') {\n        setCurrentState('wait-for-visibility');\n      } else {\n        tryReconnect();\n      }\n    };\n\n    webSocket.addEventListener('close', handleCloseOrError);\n\n    webSocket.addEventListener('message', (message): void => {\n      if (message.data === 'connection-ack') {\n        setCurrentState('connected');\n      } else {\n        onMessage(message);\n      }\n    });\n\n    webSocket.addEventListener('error', (event): void => {\n      if (onError) {\n        onError(event);\n      } else {\n        console.error('ws error', event);\n      }\n      handleCloseOrError();\n    });\n  };\n\n  if (reconnection) {\n    tryReconnect = () => {\n      if (backoff.attempts >= reconnectionAttempts) {\n        return;\n      }\n\n      if (currentState === 'reconnect-scheduled') {\n        return;\n      }\n\n      setCurrentState('reconnect-scheduled');\n      clearInternalTimeout('tryReconnect');\n      const delay = backoff.duration();\n      timeouts.tryReconnect = setTimeout(() => {\n        connect();\n      }, delay);\n    };\n  }\n\n  const visibilityChangeHandler: (() => void) | undefined = !tryReconnect\n    ? undefined\n    : () => {\n        if (document.visibilityState === 'hidden') {\n          if (currentState === 'reconnect-scheduled') {\n            setCurrentState('wait-for-visibility');\n            if (timeouts.tryReconnect !== null) {\n              clearTimeout(timeouts.tryReconnect);\n            }\n          }\n          return;\n        }\n        if (currentState !== 'wait-for-visibility') return;\n\n        if (tryReconnect) {\n          backoff.reset();\n          tryReconnect();\n        }\n      };\n\n  if (visibilityChangeHandler) {\n    window.addEventListener('visibilitychange', visibilityChangeHandler);\n  }\n  const wsTransport: WebsocketTransport = {\n    connect,\n\n    close() {\n      if (ws) {\n        if (currentState === 'connected') {\n          ws.send('close');\n        }\n        closeWebsocket();\n      }\n      if (visibilityChangeHandler) {\n        window.removeEventListener('visibilitychange', visibilityChangeHandler);\n      }\n    },\n\n    isConnected() {\n      return isConnected;\n    },\n\n    sendMessage(message): void {\n      if (!ws) throw new Error('Cannot send message');\n      ws.send(message);\n    },\n\n    listenStateChange: (listener) => {\n      stateChangeListeners.add(listener);\n      return (): void => {\n        stateChangeListeners.delete(listener);\n      };\n    },\n  };\n\n  return wsTransport;\n}\n","/* eslint-disable max-lines */\nimport type { ExtendedJsonValue } from 'extended-json';\nimport { encode, decode } from 'extended-json';\nimport { ResourcesServerError } from 'liwi-resources-client';\nimport type {\n  TransportClient,\n  TransportClientSubscribeCallback,\n  TransportClientSubscribeResult,\n  ToClientMessage,\n  ToServerMessages,\n  ToServerSubscribeMessages,\n  AckError,\n} from 'liwi-resources-client';\nimport { Logger } from 'nightingale-logger';\nimport type { SimpleWebsocketClientOptions } from './createSimpleWebsocketClient';\nimport createSimpleWebsocketClient from './createSimpleWebsocketClient';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\ntype Resolve<T> = (result: T) => void;\ntype Reject = (reason?: any) => void;\n\ninterface Ack<T> {\n  reject: Reject;\n  resolve: Resolve<T>;\n}\n\ninterface Subscription<\n  T extends keyof ToServerSubscribeMessages<any>,\n  U,\n  Message extends { payload: any } = any,\n> extends Ack<U> {\n  type: T;\n  message: Message;\n  callback: TransportClientSubscribeCallback<U>;\n}\n\nexport type WebsocketTransportClientOptions = Omit<\n  SimpleWebsocketClientOptions,\n  'onMessage' | 'url'\n> &\n  Partial<Pick<SimpleWebsocketClientOptions, 'url'>>;\n\ntype PromiseExecutor<T> = (\n  resolve: (value: T | PromiseLike<T>) => void,\n  reject: (reason?: any) => void,\n) => void;\n\ntype Handler<T> = (id: number, error: AckError | null, result: T) => void;\n\nclass SubscribeResultPromise<\n  Result,\n  Payload extends Record<keyof Payload & string, ExtendedJsonValue | undefined>,\n> implements\n    TransportClientSubscribeResult<Result, Payload>,\n    PromiseLike<Result>\n{\n  private readonly promise: Promise<Result>;\n\n  readonly stop: TransportClientSubscribeResult<Result, Payload>['stop'];\n\n  readonly cancel: TransportClientSubscribeResult<Result, Payload>['cancel'];\n\n  // readonly changePayload: TransportClientSubscribeResult<\n  //   Result,\n  //   Payload\n  // >['changePayload'];\n\n  constructor({\n    executor,\n    stop,\n  }: {\n    executor: PromiseExecutor<Result>;\n    stop: TransportClientSubscribeResult<Result, Payload>['stop'];\n    // changePayload: TransportClientSubscribeResult<\n    //   Result,\n    //   Payload\n    // >['changePayload'];\n  }) {\n    this.promise = new Promise<Result>((resolve, reject) => {\n      executor(resolve, reject);\n    });\n    this.stop = stop;\n    this.cancel = stop;\n    // this.changePayload = changePayload;\n  }\n\n  then<TResult1 = Result, TResult2 = never>(\n    onfulfilled?:\n      | ((value: Result) => TResult1 | PromiseLike<TResult1>)\n      | null\n      | undefined,\n    onrejected?:\n      | ((reason: any) => TResult2 | PromiseLike<TResult2>)\n      | null\n      | undefined,\n  ): PromiseLike<TResult1 | TResult2> {\n    return this.promise.then(onfulfilled, onrejected);\n  }\n\n  catch<TResult2 = never>(\n    onrejected?:\n      | ((reason: any) => TResult2 | PromiseLike<TResult2>)\n      | null\n      | undefined,\n  ): PromiseLike<Result | TResult2> {\n    return this.promise.catch(onrejected);\n  }\n}\n\n// TODO handle resubscriptions after reconnect (or in useEffect ?)\n// TODO handle send before connected\n// TODO reject on connection close OR keep promise hang ?\n\nconst createSafeError = (error: AckError): ResourcesServerError => {\n  return new ResourcesServerError(error.code, error.message);\n};\n\nexport default function createResourcesWebsocketClient({\n  url,\n  ...options\n}: WebsocketTransportClientOptions): TransportClient {\n  const isSSR = typeof window === 'undefined';\n\n  if (isSSR) {\n    return {\n      connect: () => {},\n      close: () => {},\n      listenStateChange: () => {\n        return () => {};\n      },\n      send: (type, message) => {\n        throw new Error('Cannot work on SSR.');\n      },\n\n      subscribe: (type, messageWithoutSubscriptionId, callback) => {\n        throw new Error('Cannot work on SSR.');\n      },\n    };\n  }\n\n  let currentId = 1;\n  let currentSubscriptionId = 1;\n  const acks = new Map<number, Ack<any>>(); // TODO in progress / unsent / sending => find better name\n  const subscriptions = new Map<number, Subscription<any, any>>();\n\n  if (!url) {\n    url = `ws${window.location.protocol === 'https:' ? 's' : ''}://${\n      window.location.host\n    }/ws`;\n  }\n  logger.info('create', { url });\n\n  const handlers: Record<ToClientMessage[0], Handler<any>> = {\n    ack: (id, error, result) => {\n      logger.debug('ack', { id });\n      const ack = acks.get(id);\n      if (!ack) {\n        logger.warn('no ack found', { id });\n      } else if (error) {\n        ack.reject(createSafeError(error));\n      } else {\n        ack.resolve(result);\n      }\n    },\n    subscription: (id, error, result) => {\n      logger.debug('subscription', { id });\n      const subscription = subscriptions.get(id);\n      if (!subscription) {\n        if (id < currentSubscriptionId) {\n          logger.warn('subscription previously closed', { id });\n        } else {\n          logger.warn('no subscription found', { id });\n        }\n      } else if (error) {\n        subscription.callback(createSafeError(error), null);\n      } else {\n        subscription.callback(null, result);\n      }\n    },\n  };\n\n  const wsClient = createSimpleWebsocketClient({\n    ...options,\n    url,\n    onMessage: (event) => {\n      logger.debug('message', { data: event.data });\n      const [type, id, error, result] = decode<ToClientMessage>(\n        event.data as string,\n      );\n      const handler = handlers[type];\n\n      if (handler) {\n        handler(id, error, result);\n      }\n    },\n  });\n\n  const sendMessage = <T extends keyof ToServerMessages>(\n    type: T,\n    id: number | null,\n    payload: ToServerMessages[T][0],\n  ): void => {\n    wsClient.sendMessage(encode([type, id, payload as any]));\n  };\n\n  const sendWithAck = <T extends keyof ToServerMessages>(\n    type: T,\n    message: ToServerMessages[T][0],\n  ): Promise<ToServerMessages[T][1]> => {\n    return new Promise((resolve, reject) => {\n      const id = currentId++;\n      acks.set(id, {\n        resolve: (result) => {\n          acks.delete(id);\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n          resolve(result);\n        },\n        reject: (err) => {\n          acks.delete(id);\n          reject(err);\n        },\n      });\n      sendMessage(type, id, message);\n    });\n  };\n\n  const sendThrowNotConnected = (): never => {\n    const error = new Error('Websocket not connected');\n    error.name = 'NetworkError';\n    throw error;\n  };\n\n  const resourcesClient: TransportClient = {\n    connect: () => {\n      logger.debug('connect');\n      wsClient.connect();\n    },\n    close: () => {\n      logger.debug('close');\n      wsClient.close();\n    },\n    listenStateChange: wsClient.listenStateChange,\n    send: sendThrowNotConnected,\n\n    subscribe: <\n      T extends keyof ToServerSubscribeMessages<Payload>,\n      Payload extends Record<keyof Payload & string, ExtendedJsonValue>,\n      Result,\n      V extends ToServerSubscribeMessages<Payload>[T][2],\n    >(\n      type: T,\n      messageWithoutSubscriptionId: Omit<\n        ToServerSubscribeMessages<Payload, Result>[T][0],\n        'subscriptionId'\n      >,\n      callback: TransportClientSubscribeCallback<V>,\n    ): TransportClientSubscribeResult<Result, Payload> => {\n      if (isSSR) throw new Error('subscribing is not allowed in SSR');\n      const id = currentId++;\n      const subscriptionId = currentSubscriptionId++;\n      const message = { ...messageWithoutSubscriptionId, subscriptionId };\n\n      return new SubscribeResultPromise<Result, Payload>({\n        executor: (resolve, reject) => {\n          subscriptions.set(subscriptionId, {\n            type,\n            message,\n            resolve,\n            reject,\n            callback,\n          });\n          if (wsClient.isConnected()) {\n            // TODO reject should remove subscription ?\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n            sendWithAck(type, message).then(resolve as any, reject);\n          }\n        },\n        stop: (): void => {\n          acks.delete(id);\n          subscriptions.delete(subscriptionId);\n          // TODO what if reconnect (backend keeps subscription) and closed at this time ?\n          if (wsClient.isConnected()) {\n            sendMessage('subscribe:close', null, { subscriptionId });\n          }\n        },\n\n        // changePayload: (payload: Payload): Promise<void> => {\n        //   return new Promise((resolve, reject) => {\n        //     const subscription = subscriptions.get(subscriptionId);\n        //     if (!subscription) return reject(new Error('Invalid subscription'));\n        //     subscription.message.payload = payload;\n        //     if (wsClient.isConnected()) {\n        //       sendWithAck('subscribe:changePayload', payload).then(\n        //         resolve,\n        //         reject,\n        //       );\n        //     } else {\n        //       return reject(new Error('Not connected'));\n        //     }\n        //   });\n        // },\n      });\n    },\n  };\n\n  wsClient.listenStateChange((newState) => {\n    logger.info('newState', { newState });\n    if (newState === 'connected') {\n      resourcesClient.send = sendWithAck as TransportClient['send'];\n      subscriptions.forEach((subscription, subscriptionId) => {\n        sendWithAck(subscription.type, subscription.message).then(\n          subscription.resolve,\n          subscription.reject,\n        );\n      });\n    } else {\n      resourcesClient.send = sendThrowNotConnected;\n      acks.forEach((ack) => {\n        ack.reject(\n          new Error(`Failed to get ack, connection state is now ${newState}`),\n        );\n      });\n      acks.clear();\n\n      if (newState === 'closed') {\n        subscriptions.forEach((subscription) => {\n          subscription.reject(new Error('Subscription closed'));\n        });\n      }\n    }\n  });\n\n  return resourcesClient;\n}\n"],"names":["createSimpleWebsocketClient","url","protocols","reconnection","reconnectionDelayMin","reconnectionDelayMax","reconnectionAttempts","Infinity","thirdWebsocketArgument","onMessage","onError","ws","currentState","isConnected","stateChangeListeners","Set","backoff","Backoff","min","max","factor","timeouts","maxConnect","tryReconnect","inactivity","setCurrentState","newState","forEach","listener","clearInternalTimeout","timeoutKey","timeout","clearTimeout","closeWebsocket","connect","webSocket","WebSocket","addEventListener","reset","handleCloseOrError","document","visibilityState","message","data","event","console","error","attempts","delay","duration","setTimeout","visibilityChangeHandler","undefined","window","close","send","removeEventListener","sendMessage","Error","listenStateChange","add","logger","Logger","SubscribeResultPromise","executor","stop","promise","Promise","resolve","reject","cancel","then","onfulfilled","onrejected","createSafeError","ResourcesServerError","code","createResourcesWebsocketClient","options","isSSR","subscribe","currentId","currentSubscriptionId","acks","Map","subscriptions","location","protocol","host","info","handlers","ack","id","result","debug","get","warn","subscription","callback","wsClient","decode","type","handler","payload","encode","sendWithAck","set","err","sendThrowNotConnected","name","resourcesClient","messageWithoutSubscriptionId","subscriptionId","clear"],"mappings":"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"}