{"version":3,"file":"index-browsermodern-dev.es.js","sources":["../src/WebsocketCursor.ts","../src/Query.ts","../src/WebsocketStore.ts"],"sourcesContent":["import { AbstractCursor } from 'liwi-store';\nimport { BaseModel, Criteria, Sort } from 'liwi-types';\nimport WebsocketStore from './WebsocketStore';\n\nexport interface Options<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport default class WebsocketCursor<\n  Model extends BaseModel,\n  KeyPath extends string\n> extends AbstractCursor<Model, KeyPath, WebsocketStore<Model, any>> {\n  _idCursor?: number;\n\n  private options: Options<Model>;\n\n  private _result?: Model;\n\n  constructor(store: WebsocketStore<Model, any>, options: Options<Model>) {\n    super(store);\n    this.options = options;\n  }\n\n  /* options */\n\n  limit(newLimit: number): Promise<this> {\n    if (this._idCursor) throw new Error('Cursor already created');\n    this.options.limit = newLimit;\n    return Promise.resolve(this);\n  }\n\n  /* results */\n\n  _create() {\n    if (this._idCursor) throw new Error('Cursor already created');\n    return this.store.connection\n      .emit('createCursor', this.options)\n      .then((idCursor: number) => {\n        if (!idCursor) return;\n        this._idCursor = idCursor;\n      });\n  }\n\n  emit(type: string, ...args: Array<any>): Promise<any> {\n    if (!this._idCursor) {\n      return this._create().then(() => this.emit(type, ...args));\n    }\n\n    return this.store.emit('cursor', { type, id: this._idCursor }, args);\n  }\n\n  advance(count: number) {\n    this.emit('advance', count);\n    return this;\n  }\n\n  next(): Promise<any> {\n    return this.emit('next').then((result) => {\n      this._result = result;\n      this.key = result && result[this._store.keyPath];\n      return this.key;\n    });\n  }\n\n  result(): Promise<Model> {\n    if (!this._result) throw new Error('Cannot call result() before next()');\n    return Promise.resolve(this._result);\n  }\n\n  count(applyLimit: boolean = false) {\n    return this.emit('count', applyLimit);\n  }\n\n  close(): Promise<void> {\n    if (!this._store) return Promise.resolve();\n\n    const closedPromise = this._idCursor\n      ? this.emit('close')\n      : Promise.resolve();\n    this._idCursor = undefined;\n    this._result = undefined;\n    return closedPromise;\n  }\n\n  toArray(): Promise<Array<Model>> {\n    return this.store.emit('cursor toArray', this.options).then((result) => {\n      this.close();\n      return result;\n    });\n  }\n}\n","import { PRODUCTION } from 'pob-babel';\nimport Logger from 'nightingale-logger';\nimport { decode } from 'extended-json';\nimport { AbstractQuery } from 'liwi-store';\nimport { BaseModel } from 'liwi-types';\nimport WebsocketStore from './WebsocketStore';\n\ntype SubscribeReturn = {\n  cancel: () => void;\n  stop: () => void;\n  then: (cb: any) => Promise<any>;\n};\n\ntype UnsubscribeCallback = () => void;\ntype Callback = (err: Error | null, result: any) => void;\n\nconst logger = new Logger('liwi:websocket-client:query');\n\nexport default class Query<\n  Model extends BaseModel,\n  KeyPath extends string\n> extends AbstractQuery<Model, WebsocketStore<Model, KeyPath>> {\n  key: string;\n\n  constructor(store: WebsocketStore<Model, KeyPath>, key: string) {\n    super(store);\n    this.key = key;\n  }\n\n  fetch(onFulfilled?: (value: any) => any): Promise<any> {\n    return super.store.emit('fetch', this.key).then(onFulfilled);\n  }\n\n  _subscribe(\n    callback: Callback,\n    _includeInitial = false,\n    args: Array<any>,\n  ): SubscribeReturn {\n    const eventName = `subscribe:${super.store.restName}.${this.key}`;\n    const listener = (err: Error | null, result?: string) => {\n      const decodedResult = result && decode(result);\n      if (!PRODUCTION) logger.debug(eventName, { result, decodedResult });\n      callback(err, decodedResult);\n    };\n\n    const connection = super.store.connection;\n\n    connection.on(eventName, listener);\n\n    let _stopEmitSubscribe: UnsubscribeCallback;\n    let promise: Promise<void> | undefined = super.store\n      .emitSubscribe(\n        _includeInitial ? 'fetchAndSubscribe' : 'subscribe',\n        this.key,\n        eventName,\n        args,\n      )\n      .then((stopEmitSubscribe: UnsubscribeCallback) => {\n        _stopEmitSubscribe = stopEmitSubscribe;\n        logger.info('subscribed');\n      })\n      .catch((err: Error) => {\n        connection.off(eventName, listener);\n        throw err;\n      });\n\n    const stop = () => {\n      if (!promise) return;\n      _stopEmitSubscribe();\n      promise.then(() => {\n        promise = undefined;\n        connection.off(eventName, listener);\n      });\n    };\n\n    return {\n      cancel: stop,\n      stop,\n      then: (cb) => Promise.resolve(promise).then(cb),\n    };\n  }\n}\n","import Logger from 'nightingale-logger';\nimport { encode, decode } from 'extended-json';\nimport { AbstractStore, AbstractConnection, UpsertResult } from 'liwi-store';\nimport { BaseModel, Update, Criteria, Sort, InsertType } from 'liwi-types';\nimport WebsocketCursor from './WebsocketCursor';\nimport Query from './Query';\n\nconst logger = new Logger('liwi:websocket-client');\n\nexport interface WebsocketConnection extends AbstractConnection {\n  emit: (event: string, ...args: any[]) => Promise<any>;\n  isConnected: () => boolean;\n  isDisconnected: () => boolean;\n  on: (event: string, listener: Function) => this;\n  off: (event: string, listener: Function) => this;\n}\n\ntype UnsubscribeCallback = () => void;\n\nexport default class WebsocketStore<\n  Model extends BaseModel,\n  KeyPath extends string\n> extends AbstractStore<\n  Model,\n  KeyPath,\n  WebsocketConnection,\n  WebsocketCursor<Model, KeyPath>,\n  Query<Model, KeyPath>\n> {\n  restName: string;\n\n  constructor(\n    websocket: WebsocketConnection,\n    restName: string,\n    keyPath: KeyPath,\n  ) {\n    super(websocket, keyPath);\n\n    if (!restName) {\n      throw new Error(`Invalid restName: \"${restName}\"`);\n    }\n\n    this.restName = restName;\n  }\n\n  createQuery(key: string): Query<Model, KeyPath> {\n    logger.debug('createQuery', { key });\n    return new Query(this, key);\n  }\n\n  emitSubscribe(\n    type: string,\n    ...args: Array<any>\n  ): Promise<UnsubscribeCallback> {\n    const connection = super.connection;\n    const emit = () => this.emit(type, ...args);\n    const registerOnConnect = () => {\n      connection.on('connect', emit);\n      return () => {\n        connection.off('connect', emit);\n      };\n    };\n\n    if (connection.isConnected()) {\n      return emit().then(registerOnConnect);\n    }\n\n    return Promise.resolve(registerOnConnect());\n  }\n\n  insertOne(object: Model): Promise<Model> {\n    return this.emit('insertOne', object);\n  }\n\n  replaceOne(object: Model): Promise<Model> {\n    return this.emit('replaceOne', object);\n  }\n\n  replaceSeveral(objects: Array<Model>): Promise<Array<Model>> {\n    return this.emit('replaceSeveral', objects);\n  }\n\n  upsertOneWithInfo(\n    object: InsertType<Model, KeyPath>,\n  ): Promise<UpsertResult<Model>> {\n    return this.emit('upsertOneWithInfo', object);\n  }\n\n  partialUpdateByKey(key: any, partialUpdate: Update<Model>): Promise<Model> {\n    return this.emit('partialUpdateByKey', key, partialUpdate);\n  }\n\n  partialUpdateOne(\n    object: Model,\n    partialUpdate: Update<Model>,\n  ): Promise<Model> {\n    return this.emit('partialUpdateOne', object, partialUpdate);\n  }\n\n  partialUpdateMany(\n    criteria: Criteria<Model>,\n    partialUpdate: Update<Model>,\n  ): Promise<void> {\n    return this.emit('partialUpdateMany', criteria, partialUpdate);\n  }\n\n  cursor(\n    criteria?: Criteria<Model>,\n    sort?: Sort<Model>,\n  ): Promise<WebsocketCursor<Model, KeyPath>> {\n    return Promise.resolve(new WebsocketCursor(this, { criteria, sort }));\n  }\n\n  findByKey(key: any): Promise<Model | undefined> {\n    return this.findOne({ [super.keyPath]: key });\n  }\n\n  findOne(\n    criteria: Criteria<Model>,\n    sort?: Sort<Model>,\n  ): Promise<Model | undefined> {\n    return this.emit('findOne', criteria, sort);\n  }\n\n  deleteByKey(key: any): Promise<void> {\n    return this.emit('deleteByKey', key);\n  }\n\n  deleteMany(criteria: Criteria<Model>): Promise<void> {\n    return this.emit('deleteMany', criteria);\n  }\n\n  emit(type: string, ...args: Array<any>) {\n    logger.debug('emit', { type, args });\n    if (super.connection.isDisconnected()) {\n      throw new Error('Websocket is not connected');\n    }\n\n    return super.connection\n      .emit('rest', {\n        type,\n        restName: this.restName,\n        json: encode(args),\n      })\n      .then((result: any) => result && decode(result));\n  }\n}\n"],"names":["WebsocketCursor","AbstractCursor","constructor","store","options","limit","newLimit","_idCursor","Error","Promise","resolve","_create","connection","emit","then","idCursor","type","args","id","advance","count","next","result","_result","key","_store","keyPath","applyLimit","close","closedPromise","undefined","toArray","logger","Logger","Query","AbstractQuery","fetch","onFulfilled","_subscribe","callback","_includeInitial","eventName","restName","listener","err","decodedResult","decode","debug","on","_stopEmitSubscribe","promise","emitSubscribe","stopEmitSubscribe","info","catch","off","stop","cancel","cb","WebsocketStore","AbstractStore","websocket","createQuery","registerOnConnect","isConnected","insertOne","object","replaceOne","replaceSeveral","objects","upsertOneWithInfo","partialUpdateByKey","partialUpdate","partialUpdateOne","partialUpdateMany","criteria","cursor","sort","findByKey","findOne","deleteByKey","deleteMany","isDisconnected","json","encode"],"mappings":"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"}