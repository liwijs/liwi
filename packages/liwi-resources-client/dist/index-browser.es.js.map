{"version":3,"file":"index-browser.es.js","sources":["../src/ClientQuery.ts","../src/createResourceClientService.ts"],"sourcesContent":["import type {\n  Query,\n  QuerySubscription,\n  SubscribeCallback,\n  QueryParams,\n  QueryResult,\n  ToServerQueryPayload,\n} from 'liwi-resources';\nimport { Logger } from 'nightingale-logger';\nimport type { TransportClient } from './TransportClient';\n\nconst logger = new Logger('liwi:resources:query');\n\nexport class ClientQuery<Result, Params extends QueryParams<Params>>\n  implements Query<Result, Params>\n{\n  private readonly resourceName: string;\n\n  private readonly transportClient: TransportClient;\n\n  key: string;\n\n  private params: Params;\n\n  constructor(\n    resourceName: string,\n    transportClient: TransportClient,\n    key: string,\n    params: Params,\n  ) {\n    this.resourceName = resourceName;\n    this.transportClient = transportClient;\n    this.key = key;\n    this.params = params;\n  }\n\n  changeParams(params: Params): void {\n    this.params = params;\n  }\n\n  changePartialParams(\n    params: Params extends undefined ? never : Partial<Params>,\n  ): void {\n    this.params = { ...this.params, ...params };\n  }\n\n  private getTransportPayload(): ToServerQueryPayload {\n    return {\n      resourceName: this.resourceName,\n      key: this.key,\n      params: this.params,\n    };\n  }\n\n  fetch<T>(onFulfilled?: (result: QueryResult<Result>) => T): Promise<T> {\n    logger.debug('fetch', {\n      resourceName: this.resourceName,\n      key: this.key,\n    });\n    return this.transportClient\n      .send<'fetch', QueryResult<Result>>('fetch', this.getTransportPayload())\n      .then(onFulfilled);\n  }\n\n  fetchAndSubscribe(\n    callback: SubscribeCallback<any, Result>,\n  ): QuerySubscription {\n    logger.debug('fetchAndSubscribe', {\n      resourceName: this.resourceName,\n      key: this.key,\n    });\n\n    return this.transportClient.subscribe(\n      'fetchAndSubscribe',\n      this.getTransportPayload(),\n      callback,\n    );\n  }\n\n  subscribe(callback: SubscribeCallback<any, Result>): QuerySubscription {\n    logger.debug('subscribe', {\n      resourceName: this.resourceName,\n      key: this.key,\n    });\n\n    return this.transportClient.subscribe(\n      'subscribe',\n      this.getTransportPayload(),\n      callback,\n    );\n  }\n}\n","import type { ServiceInterface as ClientServiceInterface } from 'liwi-resources';\nimport { ClientQuery } from './ClientQuery';\nimport type { TransportClient } from './TransportClient';\n\nconst getKeys = <T extends Record<keyof T, unknown>>(o: T): (keyof T)[] =>\n  Object.keys(o) as (keyof T)[];\n\ninterface CreateResourceClientOptions<\n  QueryKeys extends keyof any,\n  OperationKeys extends keyof any,\n> {\n  queries: Record<QueryKeys, null>;\n  operations: Record<OperationKeys, null>;\n}\n\nexport const createResourceClientService = <\n  Service extends ClientServiceInterface<\n    Service['queries'],\n    Service['operations']\n  >,\n>(\n  resourceName: string,\n  options: CreateResourceClientOptions<\n    keyof Service['queries'],\n    keyof Service['operations']\n  >,\n) => {\n  return (transportClient: TransportClient): Service => {\n    const queries: Partial<Service['queries']> = {};\n    const operations: Partial<Service['operations']> = {};\n\n    getKeys(options.queries).forEach((queryKey) => {\n      queries[queryKey] = ((params: any) =>\n        new ClientQuery(\n          resourceName,\n          transportClient,\n          queryKey as string,\n          params,\n        )) as any;\n    });\n\n    getKeys(options.operations).forEach((operationKey) => {\n      operations[operationKey] = ((params: any) =>\n        transportClient.send('do', {\n          resourceName,\n          operationKey: operationKey as string,\n          params,\n        })) as any;\n    });\n\n    return {\n      queries,\n      operations,\n    } as unknown as Service;\n  };\n};\n"],"names":["logger","Logger","ClientQuery","resourceName","transportClient","key","params","_proto","prototype","changeParams","changePartialParams","_extends","getTransportPayload","fetch","onFulfilled","debug","send","then","fetchAndSubscribe","callback","subscribe","getKeys","o","Object","keys","createResourceClientService","options","queries","operations","forEach","queryKey","operationKey"],"mappings":"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"}