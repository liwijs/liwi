{"version":3,"file":"index-browser.es.js","sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable max-lines */\nimport type http from 'http';\nimport type net from 'net';\nimport { encode, decode } from 'extended-json';\nimport type { ExtendedJsonValue } from 'extended-json/src/ExtendedJsonValue';\nimport type {\n  AckError,\n  ToServerMessage,\n  ToClientMessage,\n  ResourcesServerService,\n  SubscriptionCallback,\n} from 'liwi-resources-server';\nimport {\n  ResourcesServerError,\n  createMessageHandler,\n} from 'liwi-resources-server';\nimport { Logger } from 'nightingale-logger';\nimport type { WebSocket } from 'ws';\nimport { WebSocketServer } from 'ws';\n\ntype GetAuthenticatedUser<AuthenticatedUser> = (\n  request: http.IncomingMessage,\n) => AuthenticatedUser | null | Promise<AuthenticatedUser | null>;\n\ninterface ExtendedWebSocket extends WebSocket {\n  isAlive: boolean;\n}\n\nexport interface ResourcesWebsocketServer {\n  wss: WebSocketServer;\n  close: () => void;\n}\n\nconst logger = new Logger('liwi:resources-websocket-server');\n\nexport const createWsServer = <AuthenticatedUser>(\n  server: http.Server,\n  path: string,\n  resourcesServerService: ResourcesServerService,\n  getAuthenticatedUser: GetAuthenticatedUser<AuthenticatedUser>,\n): ResourcesWebsocketServer => {\n  const wss = new WebSocketServer({ noServer: true });\n\n  wss.on(\n    'connection',\n    (ws: ExtendedWebSocket, authenticatedUser: AuthenticatedUser | null) => {\n      ws.isAlive = true;\n\n      const sendMessage = (\n        type: ToClientMessage[0],\n        id: ToClientMessage[1],\n        error: ToClientMessage[2],\n        result: ToClientMessage[3],\n      ): void => {\n        if (!id) throw new Error('Invalid id');\n        logger.debug('sendMessage', { type, id, error, result });\n        ws.send(encode([type, id, error, result]));\n      };\n\n      const createSafeError = (error: Error): AckError => {\n        if (error instanceof ResourcesServerError) {\n          return { code: error.code, message: error.message };\n        }\n\n        logger.error(error);\n\n        return {\n          code: 'INTERNAL_SERVER_ERROR',\n          message: 'Internal Server Error',\n        };\n      };\n\n      const sendAck = (\n        id: number,\n        error: null | Error,\n        result?: ExtendedJsonValue,\n      ): void => {\n        sendMessage('ack', id, error && createSafeError(error), result);\n      };\n\n      const sendSubscriptionMessage: SubscriptionCallback = (\n        subscriptionId: number,\n        error: null | Error,\n        result: ExtendedJsonValue,\n      ): void => {\n        sendMessage(\n          'subscription',\n          subscriptionId,\n          error && createSafeError(error),\n          result,\n        );\n      };\n\n      const { messageHandler, close } = createMessageHandler(\n        resourcesServerService,\n        authenticatedUser,\n        true,\n      );\n\n      const handleDecodedMessage = (\n        message: ToServerMessage,\n      ): Promise<void> => {\n        if (message.id == null) {\n          return messageHandler(message, sendSubscriptionMessage).then(\n            () => {},\n          );\n        } else {\n          return messageHandler(message, sendSubscriptionMessage)\n            .then((result) => {\n              sendAck(message.id, null, result as ExtendedJsonValue);\n            })\n            .catch((err) => {\n              sendAck(message.id, err as Error);\n            });\n        }\n      };\n\n      ws.on('pong', () => {\n        ws.isAlive = true;\n      });\n\n      ws.on('close', (code, data) => {\n        const reason = data.toString();\n        logger.debug('closed', { code, reason });\n        close();\n      });\n\n      ws.on('error', (error) => {\n        logger.error('ws error', { error });\n      });\n\n      ws.on('message', (data, isBinary): void => {\n        if (isBinary) return;\n\n        // eslint-disable-next-line @typescript-eslint/no-base-to-string\n        const message = data.toString();\n\n        if (message === 'close') return;\n\n        if (typeof message !== 'string') {\n          logger.warn('got non string message');\n          return;\n        }\n\n        const decoded =\n          decode<\n            [\n              ToServerMessage['type'],\n              ToServerMessage['id'],\n              ToServerMessage['payload'],\n            ]\n          >(message);\n        try {\n          const [type, id, payload] = decoded;\n          logger.debug('received', { type, id, payload });\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\n          handleDecodedMessage({ type, id, payload } as ToServerMessage);\n        } catch {\n          logger.notice('invalid message', { decoded });\n        }\n      });\n\n      ws.send('connection-ack');\n    },\n  );\n\n  // https://www.npmjs.com/package/ws#how-to-detect-and-close-broken-connections\n  const interval = setInterval(() => {\n    wss.clients.forEach((ws: WebSocket) => {\n      const extWs = ws as ExtendedWebSocket;\n\n      if (!extWs.isAlive) {\n        ws.terminate();\n        return;\n      }\n\n      extWs.isAlive = false;\n      ws.ping(null, undefined);\n    });\n  }, 60 * 1000);\n\n  const handleUpgrade = (\n    request: http.IncomingMessage,\n    socket: net.Socket,\n    upgradeHead: Buffer,\n  ): void => {\n    if (request.url !== path) return;\n\n    const authenticatedUserPromise: Promise<AuthenticatedUser | null> =\n      Promise.resolve(getAuthenticatedUser(request));\n    wss.handleUpgrade(request, socket, upgradeHead, (ws) => {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      authenticatedUserPromise\n        .catch((err) => {\n          logger.warn(\n            'getAuthenticatedUser threw an error, return null instead.',\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n            { err },\n          );\n          return null;\n        })\n        .then((authenticatedUser) => {\n          wss.emit('connection', ws, authenticatedUser);\n        });\n    });\n  };\n\n  server.on('upgrade', handleUpgrade);\n\n  return {\n    wss,\n    close(): void {\n      wss.close();\n      for (const ws of wss.clients) {\n        ws.terminate();\n      }\n      server.removeListener('upgrade', handleUpgrade);\n      clearInterval(interval);\n    },\n  };\n};\n"],"names":["logger","Logger","createWsServer","server","path","resourcesServerService","getAuthenticatedUser","wss","WebSocketServer","noServer","on","ws","authenticatedUser","isAlive","sendMessage","type","id","error","result","Error","debug","send","encode","createSafeError","ResourcesServerError","code","message","sendAck","sendSubscriptionMessage","subscriptionId","_createMessageHandler","createMessageHandler","messageHandler","close","handleDecodedMessage","then","catch","err","data","reason","toString","isBinary","payload","warn","decoded","decode","_unused","notice","interval","setInterval","clients","forEach","extWs","terminate","ping","undefined","handleUpgrade","request","socket","upgradeHead","url","authenticatedUserPromise","Promise","resolve","emit","_iterator","_step","_createForOfIteratorHelperLoose","done","value","removeListener","clearInterval"],"mappings":";;;;;;AAiCA,IAAMA,MAAM,GAAG,IAAIC,MAAM,CAAC,iCAAiC,CAAC,CAAA;AAE/CC,IAAAA,cAAc,GAAG,SAAjBA,cAAcA,CACzBC,MAAmB,EACnBC,IAAY,EACZC,sBAA8C,EAC9CC,oBAA6D,EAChC;AAC7B,EAAA,IAAMC,GAAG,GAAG,IAAIC,eAAe,CAAC;AAAEC,IAAAA,QAAQ,EAAE,IAAA;AAAK,GAAC,CAAC,CAAA;EAEnDF,GAAG,CAACG,EAAE,CACJ,YAAY,EACZ,UAACC,EAAqB,EAAEC,iBAA2C,EAAK;IACtED,EAAE,CAACE,OAAO,GAAG,IAAI,CAAA;AAEjB,IAAA,IAAMC,WAAW,GAAG,SAAdA,WAAWA,CACfC,IAAwB,EACxBC,EAAsB,EACtBC,KAAyB,EACzBC,MAA0B,EACjB;MACT,IAAI,CAACF,EAAE,EAAE,MAAM,IAAIG,KAAK,CAAC,YAAY,CAAC,CAAA;AACtCnB,MAAAA,MAAM,CAACoB,KAAK,CAAC,aAAa,EAAE;AAAEL,QAAAA,IAAI,EAAJA,IAAI;AAAEC,QAAAA,EAAE,EAAFA,EAAE;AAAEC,QAAAA,KAAK,EAALA,KAAK;AAAEC,QAAAA,MAAM,EAANA,MAAAA;AAAO,OAAC,CAAC,CAAA;AACxDP,MAAAA,EAAE,CAACU,IAAI,CAACC,MAAM,CAAC,CAACP,IAAI,EAAEC,EAAE,EAAEC,KAAK,EAAEC,MAAM,CAAC,CAAC,CAAC,CAAA;KAC3C,CAAA;AAED,IAAA,IAAMK,eAAe,GAAG,SAAlBA,eAAeA,CAAIN,KAAY,EAAe;MAClD,IAAIA,KAAK,YAAYO,oBAAoB,EAAE;QACzC,OAAO;UAAEC,IAAI,EAAER,KAAK,CAACQ,IAAI;UAAEC,OAAO,EAAET,KAAK,CAACS,OAAAA;SAAS,CAAA;AACrD,OAAA;AAEA1B,MAAAA,MAAM,CAACiB,KAAK,CAACA,KAAK,CAAC,CAAA;MAEnB,OAAO;AACLQ,QAAAA,IAAI,EAAE,uBAAuB;AAC7BC,QAAAA,OAAO,EAAE,uBAAA;OACV,CAAA;KACF,CAAA;IAED,IAAMC,OAAO,GAAG,SAAVA,OAAOA,CACXX,EAAU,EACVC,KAAmB,EACnBC,MAA0B,EACjB;AACTJ,MAAAA,WAAW,CAAC,KAAK,EAAEE,EAAE,EAAEC,KAAK,IAAIM,eAAe,CAACN,KAAK,CAAC,EAAEC,MAAM,CAAC,CAAA;KAChE,CAAA;IAED,IAAMU,uBAA6C,GAAG,SAAhDA,uBAA6CA,CACjDC,cAAsB,EACtBZ,KAAmB,EACnBC,MAAyB,EAChB;AACTJ,MAAAA,WAAW,CACT,cAAc,EACde,cAAc,EACdZ,KAAK,IAAIM,eAAe,CAACN,KAAK,CAAC,EAC/BC,MAAM,CACP,CAAA;KACF,CAAA;IAED,IAAAY,qBAAA,GAAkCC,oBAAoB,CACpD1B,sBAAsB,EACtBO,iBAAiB,EACjB,IAAI,CACL;MAJOoB,cAAc,GAAAF,qBAAA,CAAdE,cAAc;MAAEC,KAAK,GAAAH,qBAAA,CAALG,KAAK,CAAA;AAM7B,IAAA,IAAMC,oBAAoB,GAAG,SAAvBA,oBAAoBA,CACxBR,OAAwB,EACN;AAClB,MAAA,IAAIA,OAAO,CAACV,EAAE,IAAI,IAAI,EAAE;AACtB,QAAA,OAAOgB,cAAc,CAACN,OAAO,EAAEE,uBAAuB,CAAC,CAACO,IAAI,CAC1D,YAAM,EAAE,CACT,CAAA;AACH,OAAC,MAAM;QACL,OAAOH,cAAc,CAACN,OAAO,EAAEE,uBAAuB,CAAC,CACpDO,IAAI,CAAC,UAACjB,MAAM,EAAK;UAChBS,OAAO,CAACD,OAAO,CAACV,EAAE,EAAE,IAAI,EAAEE,MAAM,CAAsB,CAAA;AACxD,SAAC,CAAC,CACDkB,KAAK,CAAC,UAACC,GAAG,EAAK;AACdV,UAAAA,OAAO,CAACD,OAAO,CAACV,EAAE,EAAEqB,GAAG,CAAU,CAAA;AACnC,SAAC,CAAC,CAAA;AACN,OAAA;KACD,CAAA;AAED1B,IAAAA,EAAE,CAACD,EAAE,CAAC,MAAM,EAAE,YAAM;MAClBC,EAAE,CAACE,OAAO,GAAG,IAAI,CAAA;AACnB,KAAC,CAAC,CAAA;IAEFF,EAAE,CAACD,EAAE,CAAC,OAAO,EAAE,UAACe,IAAI,EAAEa,IAAI,EAAK;AAC7B,MAAA,IAAMC,MAAM,GAAGD,IAAI,CAACE,QAAQ,EAAE,CAAA;AAC9BxC,MAAAA,MAAM,CAACoB,KAAK,CAAC,QAAQ,EAAE;AAAEK,QAAAA,IAAI,EAAJA,IAAI;AAAEc,QAAAA,MAAM,EAANA,MAAAA;AAAO,OAAC,CAAC,CAAA;AACxCN,MAAAA,KAAK,EAAE,CAAA;AACT,KAAC,CAAC,CAAA;AAEFtB,IAAAA,EAAE,CAACD,EAAE,CAAC,OAAO,EAAE,UAACO,KAAK,EAAK;AACxBjB,MAAAA,MAAM,CAACiB,KAAK,CAAC,UAAU,EAAE;AAAEA,QAAAA,KAAK,EAALA,KAAAA;AAAM,OAAC,CAAC,CAAA;AACrC,KAAC,CAAC,CAAA;IAEFN,EAAE,CAACD,EAAE,CAAC,SAAS,EAAE,UAAC4B,IAAI,EAAEG,QAAQ,EAAW;AACzC,MAAA,IAAIA,QAAQ,EAAE,OAAA;;AAEd;AACA,MAAA,IAAMf,OAAO,GAAGY,IAAI,CAACE,QAAQ,EAAE;QAkBtBzB,IAAI;QAAEC,EAAE;QAAE0B,OAAO,CAAA;MAhB1B,IAAIhB,OAAO,KAAK,OAAO,EAAE,OAAA;AAEzB,MAAA,IAAI,OAAOA,OAAO,KAAK,QAAQ,EAAE;AAC/B1B,QAAAA,MAAM,CAAC2C,IAAI,CAAC,wBAAwB,CAAC,CAAA;AACrC,QAAA,OAAA;AACF,OAAA;AAEA,MAAA,IAAMC,OAAO,GACXC,MAAM,CAMJnB,OAAO,CAAC,CAAA;MACZ,IAAI;QACKX,IAAI,GAAiB6B,OAAO,CAAtB5B,CAAAA,CAAAA,EAAAA,EAAE,GAAa4B,OAAO,CAAA,CAAA,CAAA,EAAlBF,OAAO,GAAIE,OAAO,CAAA,CAAA,CAAA,CAAA;AACnC5C,QAAAA,MAAM,CAACoB,KAAK,CAAC,UAAU,EAAE;AAAEL,UAAAA,IAAI,EAAJA,IAAI;AAAEC,UAAAA,EAAE,EAAFA,EAAE;AAAE0B,UAAAA,OAAO,EAAPA,OAAAA;AAAQ,SAAC,CAAC,CAAA;AAC/C;AACAR,QAAAA,oBAAoB,CAAC;AAAEnB,UAAAA,IAAI,EAAJA,IAAI;AAAEC,UAAAA,EAAE,EAAFA,EAAE;AAAE0B,UAAAA,OAAO,EAAPA,OAAAA;AAAQ,SAAC,CAAoB,CAAA;OAC/D,CAAC,OAAAI,OAAA,EAAM;AACN9C,QAAAA,MAAM,CAAC+C,MAAM,CAAC,iBAAiB,EAAE;AAAEH,UAAAA,OAAO,EAAPA,OAAAA;AAAQ,SAAC,CAAC,CAAA;AAC/C,OAAA;AACF,KAAC,CAAC,CAAA;AAEFjC,IAAAA,EAAE,CAACU,IAAI,CAAC,gBAAgB,CAAC,CAAA;AAC3B,GAAC,CACF,CAAA;;AAED;AACA,EAAA,IAAM2B,QAAQ,GAAGC,WAAW,CAAC,YAAM;AACjC1C,IAAAA,GAAG,CAAC2C,OAAO,CAACC,OAAO,CAAC,UAACxC,EAAa,EAAK;MACrC,IAAMyC,KAAK,GAAGzC,EAAuB,CAAA;AAErC,MAAA,IAAI,CAACyC,KAAK,CAACvC,OAAO,EAAE;QAClBF,EAAE,CAAC0C,SAAS,EAAE,CAAA;AACd,QAAA,OAAA;AACF,OAAA;MAEAD,KAAK,CAACvC,OAAO,GAAG,KAAK,CAAA;AACrBF,MAAAA,EAAE,CAAC2C,IAAI,CAAC,IAAI,EAAEC,SAAS,CAAC,CAAA;AAC1B,KAAC,CAAC,CAAA;AACJ,GAAC,EAAY,KAAA,CAAA,CAAA;EAEb,IAAMC,aAAa,GAAG,SAAhBA,aAAaA,CACjBC,OAA6B,EAC7BC,MAAkB,EAClBC,WAAmB,EACV;AACT,IAAA,IAAIF,OAAO,CAACG,GAAG,KAAKxD,IAAI,EAAE,OAAA;IAE1B,IAAMyD,wBAA2D,GAC/DC,OAAO,CAACC,OAAO,CAACzD,oBAAoB,CAACmD,OAAO,CAAC,CAAC,CAAA;IAChDlD,GAAG,CAACiD,aAAa,CAACC,OAAO,EAAEC,MAAM,EAAEC,WAAW,EAAE,UAAChD,EAAE,EAAK;AACtD;AACAkD,MAAAA,wBAAwB,CACrBzB,KAAK,CAAC,UAACC,GAAG,EAAK;QACdrC,MAAM,CAAC2C,IAAI,CACT,2DAA2D;AAC3D;AACA,QAAA;AAAEN,UAAAA,GAAG,EAAHA,GAAAA;AAAI,SAAC,CACR,CAAA;AACD,QAAA,OAAO,IAAI,CAAA;AACb,OAAC,CAAC,CACDF,IAAI,CAAC,UAACvB,iBAAiB,EAAK;QAC3BL,GAAG,CAACyD,IAAI,CAAC,YAAY,EAAErD,EAAE,EAAEC,iBAAiB,CAAC,CAAA;AAC/C,OAAC,CAAC,CAAA;AACN,KAAC,CAAC,CAAA;GACH,CAAA;AAEDT,EAAAA,MAAM,CAACO,EAAE,CAAC,SAAS,EAAE8C,aAAa,CAAC,CAAA;EAEnC,OAAO;AACLjD,IAAAA,GAAG,EAAHA,GAAG;IACH0B,KAAK,EAAA,SAAAA,QAAS;MAAA,IAAAgC,SAAA,EAAAC,KAAA,CAAA;MACZ3D,GAAG,CAAC0B,KAAK,EAAE,CAAA;AACX,MAAA,KAAAgC,SAAA,GAAAE,+BAAA,CAAiB5D,GAAG,CAAC2C,OAAO,CAAA,EAAA,CAAA,CAAAgB,KAAA,GAAAD,SAAA,EAAA,EAAAG,IAAA,GAAE;AAAA,QAAA,IAAnBzD,EAAE,GAAAuD,KAAA,CAAAG,KAAA,CAAA;QACX1D,EAAE,CAAC0C,SAAS,EAAE,CAAA;AAChB,OAAA;AACAlD,MAAAA,MAAM,CAACmE,cAAc,CAAC,SAAS,EAAEd,aAAa,CAAC,CAAA;MAC/Ce,aAAa,CAACvB,QAAQ,CAAC,CAAA;AACzB,KAAA;GACD,CAAA;AACH;;;;"}