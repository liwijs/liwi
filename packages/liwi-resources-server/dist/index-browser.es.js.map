{"version":3,"file":"index-browser.es.js","sources":["../src/ResourceServerCursor.ts","../src/ResourcesServerService.ts"],"sourcesContent":["import { AbstractStoreCursor } from 'liwi-store';\nimport { BaseModel } from 'liwi-types';\nimport CursorResource from './CursorResource';\n\nexport default class ResourceServerCursor<\n  Model extends BaseModel,\n  Transformed = any,\n  ConnectedUser = any\n> {\n  private readonly resource: CursorResource<Model, Transformed, ConnectedUser>;\n\n  private readonly connectedUser?: ConnectedUser;\n\n  private readonly cursor: AbstractStoreCursor<Model, any, any>;\n\n  constructor(\n    resource: CursorResource<Model, Transformed, ConnectedUser>,\n    cursor: AbstractStoreCursor<Model, any, any, Model>,\n    connectedUser?: ConnectedUser,\n  ) {\n    this.resource = resource;\n    this.connectedUser = connectedUser;\n    this.cursor = cursor;\n  }\n\n  toArray(): Promise<Transformed[]> {\n    return this.cursor\n      .toArray()\n      .then((results: Model[]) =>\n        results.map((result) =>\n          this.resource.transform(result, this.connectedUser),\n        ),\n      );\n  }\n}\n","import { BaseModel, Criteria, Sort } from 'liwi-types';\nimport ResourceServerCursor from './ResourceServerCursor';\nimport ServiceResource from './ServiceResource';\nimport CursorResource from './CursorResource';\n\nexport interface CreateCursorOptions<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport default class ResourcesServerService {\n  readonly serviceResources: Map<string, ServiceResource<any, any, any>>;\n\n  readonly cursorResources: Map<string, CursorResource<any, any, any>>;\n\n  constructor({\n    serviceResources = new Map(),\n    cursorResources = new Map(),\n  }: {\n    serviceResources: Map<string, ServiceResource<any, any, any>>;\n    cursorResources: Map<string, CursorResource<any, any, any>>;\n  }) {\n    this.serviceResources = serviceResources;\n    this.cursorResources = cursorResources;\n  }\n\n  addResource(key: string, resource: ServiceResource<any, any, any>) {\n    this.serviceResources.set(key, resource);\n  }\n\n  addCursorResource(\n    key: string,\n    cursorResource: CursorResource<any, any, any>,\n  ) {\n    this.cursorResources.set(key, cursorResource);\n  }\n\n  getServiceResource(key: string) {\n    const resource = this.serviceResources.get(key);\n    if (!resource) throw new Error(`Invalid service resource: \"${key}\"`);\n    return resource;\n  }\n\n  getCursorResource(key: string) {\n    const resource = this.cursorResources.get(key);\n    if (!resource) throw new Error(`Invalid cursor resource: \"${key}\"`);\n    return resource;\n  }\n\n  async createCursor<Model extends BaseModel, Transformed, ConnectedUser>(\n    resource: CursorResource<Model, Transformed, ConnectedUser>,\n    connectedUser: ConnectedUser,\n    { criteria, sort, limit }: CreateCursorOptions<Model>,\n  ): Promise<ResourceServerCursor<Model, Transformed, ConnectedUser>> {\n    // TODO: resource.query(connectedUser, criteria || {}, sort).cursor()\n    criteria = resource.criteria(connectedUser, criteria || {});\n    sort = resource.sort(connectedUser, sort);\n    const cursor = await resource.store.cursor(criteria, sort);\n    limit = resource.limit(limit);\n    if (limit) cursor.limit(connectedUser, limit);\n    return new ResourceServerCursor(resource, cursor, connectedUser);\n  }\n}\n"],"names":["ResourceServerCursor","resource","cursor","connectedUser","toArray","then","results","map","result","transform","ResourcesServerService","serviceResources","Map","cursorResources","addResource","key","set","addCursorResource","cursorResource","getServiceResource","get","Error","getCursorResource","createCursor","criteria","sort","limit","store"],"mappings":";;IAIqBA;;;gCAYjBC,QADF,EAEEC,MAFF,EAGEC,aAHF,EAIE;SACKF,QAAL,GAAgBA,QAAhB;SACKE,aAAL,GAAqBA,aAArB;SACKD,MAAL,GAAcA,MAAd;;;;;SAGFE,UAAA,mBAAkC;;;WACzB,KAAKF,MAAL,CACJE,OADI,GAEJC,IAFI,CAEC,UAACC,OAAD;aACJA,OAAO,CAACC,GAAR,CAAY,UAACC,MAAD;eACV,KAAI,CAACP,QAAL,CAAcQ,SAAd,CAAwBD,MAAxB,EAAgC,KAAI,CAACL,aAArC,CADU;OAAZ,CADI;KAFD,CAAP;;;;;;ICfiBO;;;wCAWhB;qCALDC,gBAKC;QALDA,gBAKC,sCALkB,IAAIC,GAAJ,EAKlB;oCAJDC,eAIC;QAJDA,eAIC,qCAJiB,IAAID,GAAJ,EAIjB;SACID,gBAAL,GAAwBA,gBAAxB;SACKE,eAAL,GAAuBA,eAAvB;;;;;SAGFC,cAAA,qBAAYC,GAAZ,EAAyBd,QAAzB,EAAmE;SAC5DU,gBAAL,CAAsBK,GAAtB,CAA0BD,GAA1B,EAA+Bd,QAA/B;;;SAGFgB,oBAAA,2BACEF,GADF,EAEEG,cAFF,EAGE;SACKL,eAAL,CAAqBG,GAArB,CAAyBD,GAAzB,EAA8BG,cAA9B;;;SAGFC,qBAAA,4BAAmBJ,GAAnB,EAAgC;QACxBd,QAAQ,GAAG,KAAKU,gBAAL,CAAsBS,GAAtB,CAA0BL,GAA1B,CAAjB;QACI,CAACd,QAAL,EAAe,MAAM,IAAIoB,KAAJ,kCAAwCN,GAAxC,QAAN;WACRd,QAAP;;;SAGFqB,oBAAA,2BAAkBP,GAAlB,EAA+B;QACvBd,QAAQ,GAAG,KAAKY,eAAL,CAAqBO,GAArB,CAAyBL,GAAzB,CAAjB;QACI,CAACd,QAAL,EAAe,MAAM,IAAIoB,KAAJ,iCAAuCN,GAAvC,QAAN;WACRd,QAAP;;;SAGIsB,eAAN,sBACEtB,QADF,EAEEE,aAFF;;;;;;YAGIqB,QAHJ,SAGIA,QAHJ,EAGcC,IAHd,SAGcA,IAHd,EAGoBC,KAHpB,SAGoBA,KAHpB;;YAMEF,QAAQ,GAAGvB,QAAQ,CAACuB,QAAT,CAAkBrB,aAAlB,EAAiCqB,QAAQ,IAAI,EAA7C,CAAX;YACAC,IAAI,GAAGxB,QAAQ,CAACwB,IAAT,CAActB,aAAd,EAA6BsB,IAA7B,CAAP;;6CACqBxB,QAAQ,CAAC0B,KAAT,CAAezB,MAAf,CAAsBsB,QAAtB,EAAgCC,IAAhC,CARvB;;;YAQQvB,MARR;YASEwB,KAAK,GAAGzB,QAAQ,CAACyB,KAAT,CAAeA,KAAf,CAAR;gBACIA,KAAJ,EAAWxB,MAAM,CAACwB,KAAP,CAAavB,aAAb,EAA4BuB,KAA5B;6CACJ,IAAI1B,oBAAJ,CAAyBC,QAAzB,EAAmCC,MAAnC,EAA2CC,aAA3C,CAXT;;;;;;;;;;;;;;;"}