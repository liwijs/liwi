{"version":3,"file":"index-browser.es.js","sources":["../src/ResourcesServerService.ts","../src/createMessageHandler.ts"],"sourcesContent":["import type { BaseModel, Criteria, Sort } from 'liwi-store';\n// import ResourceServerCursor from './ResourceServerCursor';\nimport type { ServiceResource } from './ServiceResource';\n\n// import { CursorResource } from './CursorResource';\n\nexport interface CreateCursorOptions<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport class ResourcesServerService {\n  readonly serviceResources: Map<string, ServiceResource<any, any>>;\n\n  // readonly cursorResources: Map<string, CursorResource<any, any, any>>;\n\n  constructor({\n    serviceResources = new Map(),\n  }: // cursorResources = new Map(),\n  {\n    serviceResources: Map<string, ServiceResource<any, any>>;\n    // cursorResources: Map<string, CursorResource<any, any, any>>;\n  }) {\n    this.serviceResources = serviceResources;\n    // this.cursorResources = cursorResources;\n  }\n\n  addResource(key: string, resource: ServiceResource<any, any>): void {\n    this.serviceResources.set(key, resource);\n  }\n\n  // addCursorResource(\n  //   key: string,\n  //   cursorResource: CursorResource<any, any, any>,\n  // ) {\n  //   this.cursorResources.set(key, cursorResource);\n  // }\n\n  getServiceResource(key: string): ServiceResource<any, any> {\n    const resource = this.serviceResources.get(key);\n    if (!resource) throw new Error(`Invalid service resource: \"${key}\"`);\n    return resource;\n  }\n\n  // getCursorResource(key: string) {\n  //   const resource = this.cursorResources.get(key);\n  //   if (!resource) throw new Error(`Invalid cursor resource: \"${key}\"`);\n  //   return resource;\n  // }\n\n  // async createCursor<Model extends BaseModel, Transformed, ConnectedUser>(\n  //   resource: CursorResource<Model, Transformed, ConnectedUser>,\n  //   connectedUser: ConnectedUser,\n  //   { criteria, sort, limit }: CreateCursorOptions<Model>,\n  // ): Promise<ResourceServerCursor<Model, any, Transformed, ConnectedUser>> {\n  //   // TODO: resource.query(connectedUser, criteria || {}, sort).cursor()\n  //   criteria = resource.criteria(connectedUser, criteria || {});\n  //   sort = resource.sort(connectedUser, sort);\n  //   const cursor = await resource.store.cursor(criteria, sort);\n  //   limit = resource.limit(limit);\n  //   if (limit) cursor.limit(limit);\n  //   return new ResourceServerCursor(resource, cursor, connectedUser);\n  // }\n}\n","/* eslint-disable complexity, max-lines */\nimport 'pob-babel';\nimport type {\n  Query,\n  QuerySubscription,\n  ToServerMessage,\n  ToServerSubscribeQueryPayload,\n  ToServerQueryPayload,\n} from 'liwi-resources';\nimport { ResourcesServerError } from 'liwi-resources';\nimport { Logger } from 'nightingale-logger';\nimport type { ResourcesServerService } from './ResourcesServerService';\nimport type { ServiceResource, SubscribeHook } from './ServiceResource';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\nexport type SubscriptionCallback = (\n  subscriptionId: number,\n  error: null | Error,\n  result: any,\n) => void;\n\nexport type MessageHandler = (\n  message: ToServerMessage,\n  subscriptionCallback: SubscriptionCallback,\n) => Promise<unknown>;\n\nexport interface SubscriptionAndSubscribeHook {\n  subscription: QuerySubscription;\n  subscribeHook?: SubscribeHook<any>;\n  params?: any;\n}\n\nconst logUnexpectedError = (\n  error: Error | unknown,\n  message: string,\n  payload: unknown,\n): void => {\n  if (!(error instanceof ResourcesServerError)) {\n    logger.error(message, {\n      error,\n      payload: !__DEV__ ? 'redacted' : payload,\n    });\n  } else if (__DEV__) {\n    logger.info(`ResourcesServerError in ${message}`, {\n      code: error.code,\n      message: error.message,\n      payload,\n    });\n  }\n};\n\nexport const createMessageHandler = <AuthenticatedUser>(\n  resourcesServerService: ResourcesServerService,\n  authenticatedUser: AuthenticatedUser | null,\n  allowSubscriptions: boolean,\n): {\n  messageHandler: MessageHandler;\n  close: () => void;\n} => {\n  const openedSubscriptions = allowSubscriptions\n    ? new Map<number, SubscriptionAndSubscribeHook>()\n    : null;\n\n  const getResource = (payload: {\n    resourceName: string;\n  }): ServiceResource<any, any> => {\n    logger.debug('resource', {\n      resourceName: payload.resourceName,\n    });\n    const resource = resourcesServerService.getServiceResource(\n      payload.resourceName,\n    );\n    return resource;\n  };\n\n  const createQuery = <\n    Service extends ServiceResource<any, any>,\n    Key extends keyof Service['queries'] & string,\n  >(\n    payload: ToServerQueryPayload<Key>,\n    resource: Service,\n  ): Query<any, any> => {\n    if (!payload.key.startsWith('query')) {\n      throw new Error('Invalid query key');\n    }\n\n    return resource.queries[payload.key](payload.params, authenticatedUser);\n  };\n\n  const createSubscription = (\n    type: 'fetchAndSubscribe' | 'subscribe',\n    payload: ToServerSubscribeQueryPayload,\n    resource: ServiceResource<any, any>,\n    query: Query<any, any>,\n    sendSubscriptionMessage: SubscriptionCallback,\n  ): PromiseLike<null> => {\n    if (!openedSubscriptions) {\n      throw new Error('Subscriptions not allowed');\n    }\n\n    const { subscriptionId } = payload;\n    if (openedSubscriptions.has(subscriptionId)) {\n      const error = 'Already have a watcher for this id. Cannot add a new one';\n      logger.warn(error, { subscriptionId, key: payload.key });\n      throw new ResourcesServerError('ALREADY_HAVE_WATCHER', error);\n    }\n\n    const subscription = query[type]((error: Error | null, result: any) => {\n      if (error) {\n        logUnexpectedError(error, type, payload);\n      }\n      sendSubscriptionMessage(subscriptionId, error, result);\n    });\n\n    const subscribeHook = resource.subscribeHooks?.[payload.key];\n    openedSubscriptions.set(subscriptionId, {\n      subscription,\n      subscribeHook,\n      params: subscribeHook ? payload.params : undefined,\n    });\n    if (subscribeHook) {\n      subscribeHook.subscribed(authenticatedUser, payload.params);\n    }\n\n    return subscription.then(() => null);\n  };\n\n  const unsubscribeSubscription = ({\n    subscription,\n    subscribeHook,\n    params,\n  }: SubscriptionAndSubscribeHook): void => {\n    subscription.stop();\n    if (subscribeHook) {\n      subscribeHook.unsubscribed(authenticatedUser, params);\n    }\n  };\n\n  return {\n    close: () => {\n      if (openedSubscriptions) {\n        openedSubscriptions.forEach(unsubscribeSubscription);\n      }\n    },\n    messageHandler: async (message, subscriptionCallback): Promise<unknown> => {\n      switch (message.type) {\n        case 'fetch': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            return await query.fetch((result) => result);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          return;\n        }\n        case 'fetchAndSubscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n\n            return await createSubscription(\n              'fetchAndSubscribe',\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          return;\n        }\n        case 'subscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            await createSubscription(\n              'subscribe',\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          return;\n        }\n        // case 'subscribe:changePayload': {\n        //   break;\n        // }\n        case 'subscribe:close': {\n          if (!openedSubscriptions) {\n            throw new Error('Subscriptions not allowed');\n          }\n          try {\n            const { subscriptionId } = message.payload;\n            const SubscriptionAndSubscribeHook =\n              openedSubscriptions.get(subscriptionId);\n            if (!SubscriptionAndSubscribeHook) {\n              logger.warn('tried to unsubscribe non existing watcher', {\n                subscriptionId,\n              });\n            } else {\n              openedSubscriptions.delete(subscriptionId);\n              unsubscribeSubscription(SubscriptionAndSubscribeHook);\n            }\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n          }\n          return;\n        }\n        case 'do': {\n          try {\n            const resource = getResource(message.payload);\n            const { operationKey, params } = message.payload;\n\n            const operation = resource.operations[operationKey];\n\n            if (!operation) {\n              throw new ResourcesServerError(\n                'OPERATION_NOT_FOUND',\n                `Operation not found: ${operationKey}`,\n              );\n            }\n\n            return operation(params, authenticatedUser);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n        }\n      }\n    },\n  };\n};\n"],"names":["ResourcesServerService","serviceResources","Map","addResource","key","resource","set","getServiceResource","get","Error","logger","Logger","logUnexpectedError","error","message","payload","ResourcesServerError","info","code","createMessageHandler","resourcesServerService","authenticatedUser","allowSubscriptions","openedSubscriptions","getResource","debug","resourceName","createQuery","startsWith","queries","params","createSubscription","type","query","sendSubscriptionMessage","subscriptionId","has","warn","subscription","result","subscribeHook","subscribeHooks","undefined","subscribed","then","unsubscribeSubscription","stop","unsubscribed","close","forEach","messageHandler","subscriptionCallback","fetch","SubscriptionAndSubscribeHook","err","operationKey","operation","operations"],"mappings":"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"}