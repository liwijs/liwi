{"version":3,"file":"index-browser.cjs.js","sources":["../src/ResourcesServerService.ts","../src/createMessageHandler.ts"],"sourcesContent":["import { BaseModel, Criteria, Sort } from 'liwi-types';\n// import ResourceServerCursor from './ResourceServerCursor';\nimport { ServiceResource } from './ServiceResource';\n\n// import { CursorResource } from './CursorResource';\n\nexport interface CreateCursorOptions<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport class ResourcesServerService {\n  readonly serviceResources: Map<string, ServiceResource<any, any>>;\n\n  // readonly cursorResources: Map<string, CursorResource<any, any, any>>;\n\n  constructor({\n    serviceResources = new Map(),\n  }: // cursorResources = new Map(),\n  {\n    serviceResources: Map<string, ServiceResource<any, any>>;\n    // cursorResources: Map<string, CursorResource<any, any, any>>;\n  }) {\n    this.serviceResources = serviceResources;\n    // this.cursorResources = cursorResources;\n  }\n\n  addResource(key: string, resource: ServiceResource<any, any>): void {\n    this.serviceResources.set(key, resource);\n  }\n\n  // addCursorResource(\n  //   key: string,\n  //   cursorResource: CursorResource<any, any, any>,\n  // ) {\n  //   this.cursorResources.set(key, cursorResource);\n  // }\n\n  getServiceResource(key: string): ServiceResource<any, any> {\n    const resource = this.serviceResources.get(key);\n    if (!resource) throw new Error(`Invalid service resource: \"${key}\"`);\n    return resource;\n  }\n\n  // getCursorResource(key: string) {\n  //   const resource = this.cursorResources.get(key);\n  //   if (!resource) throw new Error(`Invalid cursor resource: \"${key}\"`);\n  //   return resource;\n  // }\n\n  // async createCursor<Model extends BaseModel, Transformed, ConnectedUser>(\n  //   resource: CursorResource<Model, Transformed, ConnectedUser>,\n  //   connectedUser: ConnectedUser,\n  //   { criteria, sort, limit }: CreateCursorOptions<Model>,\n  // ): Promise<ResourceServerCursor<Model, any, Transformed, ConnectedUser>> {\n  //   // TODO: resource.query(connectedUser, criteria || {}, sort).cursor()\n  //   criteria = resource.criteria(connectedUser, criteria || {});\n  //   sort = resource.sort(connectedUser, sort);\n  //   const cursor = await resource.store.cursor(criteria, sort);\n  //   limit = resource.limit(limit);\n  //   if (limit) cursor.limit(limit);\n  //   return new ResourceServerCursor(resource, cursor, connectedUser);\n  // }\n}\n","/* eslint-disable complexity, max-lines */\nimport { PRODUCTION } from 'pob-babel';\nimport {\n  Query,\n  QuerySubscription,\n  ToServerMessage,\n  ToServerSubscribeQueryPayload,\n  ResourcesServerError,\n  ToServerQueryPayload,\n} from 'liwi-resources';\nimport Logger from 'nightingale-logger';\nimport { ResourcesServerService } from './ResourcesServerService';\nimport { ServiceResource, SubscribeHook } from './ServiceResource';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\nexport type SubscriptionCallback = (\n  subscriptionId: number,\n  error: null | Error,\n  result: any,\n) => void;\n\nexport type MessageHandler = (\n  message: ToServerMessage,\n  subscriptionCallback: SubscriptionCallback,\n) => Promise<unknown>;\n\nexport interface SubscriptionAndSubscribeHook {\n  subscription: QuerySubscription;\n  subscribeHook?: SubscribeHook<any>;\n  params?: any;\n}\n\nconst logUnexpectedError = (\n  error: Error,\n  message: string,\n  payload: any,\n): void => {\n  if (!PRODUCTION || !(error instanceof ResourcesServerError)) {\n    logger.error(message, {\n      error,\n      payload: PRODUCTION ? 'redacted' : payload,\n    });\n  }\n};\n\nexport const createMessageHandler = <AuthenticatedUser>(\n  resourcesServerService: ResourcesServerService,\n  authenticatedUser: AuthenticatedUser | null,\n  allowSubscriptions: boolean,\n): {\n  messageHandler: MessageHandler;\n  close: () => void;\n} => {\n  const openSubscriptions = allowSubscriptions\n    ? new Map<number, SubscriptionAndSubscribeHook>()\n    : null;\n\n  const getResource = (payload: {\n    resourceName: string;\n  }): ServiceResource<any, any> => {\n    logger.debug('resource', {\n      resourceName: payload.resourceName,\n    });\n    const resource = resourcesServerService.getServiceResource(\n      payload.resourceName,\n    );\n    return resource;\n  };\n\n  const createQuery = (\n    payload: ToServerQueryPayload,\n    resource: ServiceResource<any, any>,\n  ): Query<any, any> => {\n    if (!payload.key.startsWith('query')) {\n      throw new Error('Invalid query key');\n    }\n\n    return resource.queries[payload.key](payload.params, authenticatedUser);\n  };\n\n  const createSubscription = (\n    type: 'fetchAndSubscribe' | 'subscribe',\n    payload: ToServerSubscribeQueryPayload,\n    resource: ServiceResource<any, any>,\n    query: Query<any, any>,\n    sendSubscriptionMessage: SubscriptionCallback,\n  ): PromiseLike<null> => {\n    if (!openSubscriptions) {\n      throw new Error('Subscriptions not allowed');\n    }\n\n    const { subscriptionId } = payload;\n    if (openSubscriptions.has(subscriptionId)) {\n      const error = 'Already have a watcher for this id. Cannot add a new one';\n      logger.warn(error, { subscriptionId, key: payload.key });\n      throw new ResourcesServerError('ALREADY_HAVE_WATCHER', error);\n    }\n\n    const subscription = query[type]((error: Error | null, result: any) => {\n      if (error) {\n        logUnexpectedError(error, type, payload);\n      }\n      sendSubscriptionMessage(subscriptionId, error, result);\n    });\n\n    const subscribeHook =\n      resource.subscribeHooks && resource.subscribeHooks[payload.key];\n    openSubscriptions.set(subscriptionId, {\n      subscription,\n      subscribeHook,\n      params: subscribeHook ? payload.params : undefined,\n    });\n    if (subscribeHook) {\n      subscribeHook.subscribed(authenticatedUser, payload.params);\n    }\n\n    return subscription.then(() => null);\n  };\n\n  const unsubscribeSubscription = ({\n    subscription,\n    subscribeHook,\n    params,\n  }: SubscriptionAndSubscribeHook): void => {\n    subscription.stop();\n    if (subscribeHook) {\n      subscribeHook.unsubscribed(authenticatedUser, params);\n    }\n  };\n\n  return {\n    close: () => {\n      if (openSubscriptions) {\n        openSubscriptions.forEach(unsubscribeSubscription);\n      }\n    },\n    messageHandler: async (message, subscriptionCallback): Promise<void> => {\n      switch (message.type) {\n        case 'fetch': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            await query.fetch((result: any) => result);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          break;\n        }\n        case 'fetchAndSubscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n\n            if (!openSubscriptions) {\n              await query.fetch((result: any) => result);\n            } else {\n              await createSubscription(\n                'fetchAndSubscribe',\n                message.payload,\n                resource,\n                query,\n                subscriptionCallback,\n              );\n            }\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          break;\n        }\n        case 'subscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            await createSubscription(\n              'subscribe',\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          break;\n        }\n        // case 'subscribe:changePayload': {\n        //   break;\n        // }\n        case 'subscribe:close': {\n          if (!openSubscriptions) {\n            throw new Error('Subscriptions not allowed');\n          }\n          try {\n            const { subscriptionId } = message.payload;\n            const SubscriptionAndSubscribeHook = openSubscriptions.get(\n              subscriptionId,\n            );\n            if (!SubscriptionAndSubscribeHook) {\n              logger.warn('tried to unsubscribe non existing watcher', {\n                subscriptionId,\n              });\n            } else {\n              openSubscriptions.delete(subscriptionId);\n              unsubscribeSubscription(SubscriptionAndSubscribeHook);\n            }\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n          }\n          break;\n        }\n        case 'do': {\n          try {\n            const resource = getResource(message.payload);\n            const { operationKey, params } = message.payload;\n\n            const operation = resource.operations[operationKey];\n\n            if (!operation) {\n              throw new ResourcesServerError(\n                'OPERATION_NOT_FOUND',\n                `Operation not found: ${operationKey}`,\n              );\n            }\n\n            return await operation(params, authenticatedUser);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n        }\n      }\n    },\n  };\n};\n"],"names":["ResourcesServerService","serviceResources","Map","addResource","key","resource","set","getServiceResource","get","Error","logger","Logger","logUnexpectedError","error","message","payload","ResourcesServerError","createMessageHandler","resourcesServerService","authenticatedUser","allowSubscriptions","openSubscriptions","getResource","debug","resourceName","createQuery","startsWith","queries","params","createSubscription","type","query","sendSubscriptionMessage","subscriptionId","has","warn","subscription","result","subscribeHook","subscribeHooks","undefined","subscribed","then","unsubscribeSubscription","stop","unsubscribed","close","forEach","messageHandler","subscriptionCallback","fetch","SubscriptionAndSubscribeHook","delete","err","operationKey","operation","operations"],"mappings":"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"}