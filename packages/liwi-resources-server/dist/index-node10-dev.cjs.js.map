{"version":3,"file":"index-node10-dev.cjs.js","sources":["../src/ResourceServerCursor.ts","../src/ResourcesServerService.ts"],"sourcesContent":["import { AbstractStoreCursor } from 'liwi-store';\nimport { BaseModel } from 'liwi-types';\nimport CursorResource from './CursorResource';\n\nexport default class ResourceServerCursor<\n  Model extends BaseModel,\n  Transformed = any,\n  ConnectedUser = any\n> {\n  private resource: CursorResource<Model, Transformed, ConnectedUser>;\n\n  private connectedUser: any;\n\n  private cursor: AbstractStoreCursor<Model, any, any>;\n\n  constructor(\n    resource: CursorResource<Model, Transformed, ConnectedUser>,\n    cursor: AbstractStoreCursor<Model, any, any>,\n    connectedUser?: ConnectedUser,\n  ) {\n    this.resource = resource;\n    this.connectedUser = connectedUser;\n    this.cursor = cursor;\n  }\n\n  toArray(): Promise<Transformed[]> {\n    return this.cursor\n      .toArray()\n      .then((results: Model[]) =>\n        results.map((result) =>\n          this.resource.transform(result, this.connectedUser),\n        ),\n      );\n  }\n}\n","import { BaseModel, Criteria, Sort } from 'liwi-types';\nimport ResourceServerCursor from './ResourceServerCursor';\nimport ServiceResource from './ServiceResource';\nimport CursorResource from './CursorResource';\n\nexport interface CreateCursorOptions<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport default class ResourcesServerService {\n  public readonly serviceResources: Map<string, ServiceResource<any, any, any>>;\n\n  public readonly cursorResources: Map<string, CursorResource<any, any, any>>;\n\n  public constructor({\n    serviceResources = new Map(),\n    cursorResources = new Map(),\n  }: {\n    serviceResources: Map<string, ServiceResource<any, any, any>>;\n    cursorResources: Map<string, CursorResource<any, any, any>>;\n  }) {\n    this.serviceResources = serviceResources;\n    this.cursorResources = cursorResources;\n  }\n\n  public addResource(key: string, resource: ServiceResource<any, any, any>) {\n    this.serviceResources.set(key, resource);\n  }\n\n  public addCursorResource(\n    key: string,\n    cursorResource: CursorResource<any, any, any>,\n  ) {\n    this.cursorResources.set(key, cursorResource);\n  }\n\n  getServiceResource(key: string) {\n    const resource = this.serviceResources.get(key);\n    if (!resource) throw new Error(`Invalid service resource: \"${key}\"`);\n    return resource;\n  }\n\n  getCursorResource(key: string) {\n    const resource = this.cursorResources.get(key);\n    if (!resource) throw new Error(`Invalid cursor resource: \"${key}\"`);\n    return resource;\n  }\n\n  async createCursor<Model extends BaseModel, Transformed, ConnectedUser>(\n    resource: CursorResource<Model, Transformed, ConnectedUser>,\n    connectedUser: ConnectedUser,\n    { criteria, sort, limit }: CreateCursorOptions<Model>,\n  ): Promise<ResourceServerCursor<Model, Transformed, ConnectedUser>> {\n    // TODO: resource.query(connectedUser, criteria || {}, sort).cursor()\n    criteria = resource.criteria(connectedUser, criteria || {});\n    sort = resource.sort(connectedUser, sort);\n    const cursor = await resource.store.cursor(criteria, sort);\n    limit = resource.limit(limit);\n    if (limit) cursor.limit(connectedUser, limit);\n    return new ResourceServerCursor(resource, cursor, connectedUser);\n  }\n}\n"],"names":["ResourceServerCursor","constructor","resource","cursor","connectedUser","toArray","then","results","map","result","transform","ResourcesServerService","serviceResources","Map","cursorResources","addResource","key","set","addCursorResource","cursorResource","getServiceResource","get","Error","getCursorResource","createCursor","criteria","sort","limit","store"],"mappings":";;;;AAIe,MAAMA,oBAAN,CAIb;EAOAC,WAAW,CACTC,QADS,EAETC,MAFS,EAGTC,aAHS,EAIT;SACKF,QAAL,GAAgBA,QAAhB;SACKE,aAAL,GAAqBA,aAArB;SACKD,MAAL,GAAcA,MAAd;;;EAGFE,OAAO,GAA2B;WACzB,KAAKF,MAAL,CACJE,OADI,GAEJC,IAFI,CAEEC,OAAD,IACJA,OAAO,CAACC,GAAR,CAAaC,MAAD,IACV,KAAKP,QAAL,CAAcQ,SAAd,CAAwBD,MAAxB,EAAgC,KAAKL,aAArC,CADF,CAHG,CAAP;;;;;ACfW,MAAMO,sBAAN,CAA6B;EAKnCV,WAAP,CAAmB;IACjBW,gBAAgB,GAAG,IAAIC,GAAJ,EADF;IAEjBC,eAAe,GAAG,IAAID,GAAJ;GAFpB,EAMG;SACID,gBAAL,GAAwBA,gBAAxB;SACKE,eAAL,GAAuBA,eAAvB;;;EAGKC,WAAP,CAAmBC,GAAnB,EAAgCd,QAAhC,EAA0E;SACnEU,gBAAL,CAAsBK,GAAtB,CAA0BD,GAA1B,EAA+Bd,QAA/B;;;EAGKgB,iBAAP,CACEF,GADF,EAEEG,cAFF,EAGE;SACKL,eAAL,CAAqBG,GAArB,CAAyBD,GAAzB,EAA8BG,cAA9B;;;EAGFC,kBAAkB,CAACJ,GAAD,EAAc;UACxBd,QAAQ,GAAG,KAAKU,gBAAL,CAAsBS,GAAtB,CAA0BL,GAA1B,CAAjB;QACI,CAACd,QAAL,EAAe,MAAM,IAAIoB,KAAJ,CAAW,8BAA6BN,GAAI,GAA5C,CAAN;WACRd,QAAP;;;EAGFqB,iBAAiB,CAACP,GAAD,EAAc;UACvBd,QAAQ,GAAG,KAAKY,eAAL,CAAqBO,GAArB,CAAyBL,GAAzB,CAAjB;QACI,CAACd,QAAL,EAAe,MAAM,IAAIoB,KAAJ,CAAW,6BAA4BN,GAAI,GAA3C,CAAN;WACRd,QAAP;;;QAGIsB,YAAN,CACEtB,QADF,EAEEE,aAFF,EAGE;IAAEqB,QAAF;IAAYC,IAAZ;IAAkBC;GAHpB,EAIoE;;IAElEF,QAAQ,GAAGvB,QAAQ,CAACuB,QAAT,CAAkBrB,aAAlB,EAAiCqB,QAAQ,IAAI,EAA7C,CAAX;IACAC,IAAI,GAAGxB,QAAQ,CAACwB,IAAT,CAActB,aAAd,EAA6BsB,IAA7B,CAAP;UACMvB,MAAM,GAAG,MAAMD,QAAQ,CAAC0B,KAAT,CAAezB,MAAf,CAAsBsB,QAAtB,EAAgCC,IAAhC,CAArB;IACAC,KAAK,GAAGzB,QAAQ,CAACyB,KAAT,CAAeA,KAAf,CAAR;QACIA,KAAJ,EAAWxB,MAAM,CAACwB,KAAP,CAAavB,aAAb,EAA4BuB,KAA5B;WACJ,IAAI3B,oBAAJ,CAAyBE,QAAzB,EAAmCC,MAAnC,EAA2CC,aAA3C,CAAP;;;;;;;"}