{"version":3,"file":"index-browsermodern.es.js","sources":["../src/ResourcesServerService.ts","../src/createMessageHandler.ts"],"sourcesContent":["import { BaseModel, Criteria, Sort } from 'liwi-types';\n// import ResourceServerCursor from './ResourceServerCursor';\nimport { ServiceResource } from './ServiceResource';\n\n// import { CursorResource } from './CursorResource';\n\nexport interface CreateCursorOptions<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport class ResourcesServerService {\n  readonly serviceResources: Map<string, ServiceResource<any, any>>;\n\n  // readonly cursorResources: Map<string, CursorResource<any, any, any>>;\n\n  constructor({\n    serviceResources = new Map(),\n  }: // cursorResources = new Map(),\n  {\n    serviceResources: Map<string, ServiceResource<any, any>>;\n    // cursorResources: Map<string, CursorResource<any, any, any>>;\n  }) {\n    this.serviceResources = serviceResources;\n    // this.cursorResources = cursorResources;\n  }\n\n  addResource(key: string, resource: ServiceResource<any, any>): void {\n    this.serviceResources.set(key, resource);\n  }\n\n  // addCursorResource(\n  //   key: string,\n  //   cursorResource: CursorResource<any, any, any>,\n  // ) {\n  //   this.cursorResources.set(key, cursorResource);\n  // }\n\n  getServiceResource(key: string): ServiceResource<any, any> {\n    const resource = this.serviceResources.get(key);\n    if (!resource) throw new Error(`Invalid service resource: \"${key}\"`);\n    return resource;\n  }\n\n  // getCursorResource(key: string) {\n  //   const resource = this.cursorResources.get(key);\n  //   if (!resource) throw new Error(`Invalid cursor resource: \"${key}\"`);\n  //   return resource;\n  // }\n\n  // async createCursor<Model extends BaseModel, Transformed, ConnectedUser>(\n  //   resource: CursorResource<Model, Transformed, ConnectedUser>,\n  //   connectedUser: ConnectedUser,\n  //   { criteria, sort, limit }: CreateCursorOptions<Model>,\n  // ): Promise<ResourceServerCursor<Model, any, Transformed, ConnectedUser>> {\n  //   // TODO: resource.query(connectedUser, criteria || {}, sort).cursor()\n  //   criteria = resource.criteria(connectedUser, criteria || {});\n  //   sort = resource.sort(connectedUser, sort);\n  //   const cursor = await resource.store.cursor(criteria, sort);\n  //   limit = resource.limit(limit);\n  //   if (limit) cursor.limit(limit);\n  //   return new ResourceServerCursor(resource, cursor, connectedUser);\n  // }\n}\n","/* eslint-disable complexity, max-lines */\nimport { PRODUCTION } from 'pob-babel';\nimport {\n  Query,\n  QuerySubscription,\n  ToServerMessage,\n  ToServerSubscribeQueryPayload,\n  ResourcesServerError,\n  ToServerQueryPayload,\n} from 'liwi-resources';\nimport Logger from 'nightingale-logger';\nimport { ResourcesServerService } from './ResourcesServerService';\nimport { ServiceResource, SubscribeHook } from './ServiceResource';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\nexport type SubscriptionCallback = (\n  subscriptionId: number,\n  error: null | Error,\n  result: any,\n) => void;\n\nexport type MessageHandler = (\n  message: ToServerMessage,\n  subscriptionCallback: SubscriptionCallback,\n) => Promise<unknown>;\n\nexport interface SubscriptionAndSubscribeHook {\n  subscription: QuerySubscription;\n  subscribeHook?: SubscribeHook<any>;\n  params?: any;\n}\n\nconst logUnexpectedError = (\n  error: Error,\n  message: string,\n  payload: any,\n): void => {\n  if (!PRODUCTION || !(error instanceof ResourcesServerError)) {\n    logger.error(message, {\n      error,\n      payload: PRODUCTION ? 'redacted' : payload,\n    });\n  }\n};\n\nexport const createMessageHandler = <AuthenticatedUser>(\n  resourcesServerService: ResourcesServerService,\n  authenticatedUser: AuthenticatedUser | null,\n  allowSubscriptions: boolean,\n): {\n  messageHandler: MessageHandler;\n  close: () => void;\n} => {\n  const openSubscriptions = allowSubscriptions\n    ? new Map<number, SubscriptionAndSubscribeHook>()\n    : null;\n\n  const getResource = (payload: {\n    resourceName: string;\n  }): ServiceResource<any, any> => {\n    logger.debug('resource', {\n      resourceName: payload.resourceName,\n    });\n    const resource = resourcesServerService.getServiceResource(\n      payload.resourceName,\n    );\n    return resource;\n  };\n\n  const createQuery = (\n    payload: ToServerQueryPayload,\n    resource: ServiceResource<any, any>,\n  ): Query<any, any> => {\n    if (!payload.key.startsWith('query')) {\n      throw new Error('Invalid query key');\n    }\n\n    return resource.queries[payload.key](payload.params, authenticatedUser);\n  };\n\n  const createSubscription = (\n    type: 'fetchAndSubscribe' | 'subscribe',\n    payload: ToServerSubscribeQueryPayload,\n    resource: ServiceResource<any, any>,\n    query: Query<any, any>,\n    sendSubscriptionMessage: SubscriptionCallback,\n  ): PromiseLike<null> => {\n    if (!openSubscriptions) {\n      throw new Error('Subscriptions not allowed');\n    }\n\n    const { subscriptionId } = payload;\n    if (openSubscriptions.has(subscriptionId)) {\n      const error = 'Already have a watcher for this id. Cannot add a new one';\n      logger.warn(error, { subscriptionId, key: payload.key });\n      throw new ResourcesServerError('ALREADY_HAVE_WATCHER', error);\n    }\n\n    const subscription = query[type]((error: Error | null, result: any) => {\n      if (error) {\n        logUnexpectedError(error, type, payload);\n      }\n      sendSubscriptionMessage(subscriptionId, error, result);\n    });\n\n    const subscribeHook =\n      resource.subscribeHooks && resource.subscribeHooks[payload.key];\n    openSubscriptions.set(subscriptionId, {\n      subscription,\n      subscribeHook,\n      params: subscribeHook ? payload.params : undefined,\n    });\n    if (subscribeHook) {\n      subscribeHook.subscribed(authenticatedUser, payload.params);\n    }\n\n    return subscription.then(() => null);\n  };\n\n  const unsubscribeSubscription = ({\n    subscription,\n    subscribeHook,\n    params,\n  }: SubscriptionAndSubscribeHook): void => {\n    subscription.stop();\n    if (subscribeHook) {\n      subscribeHook.unsubscribed(authenticatedUser, params);\n    }\n  };\n\n  return {\n    close: () => {\n      if (openSubscriptions) {\n        openSubscriptions.forEach(unsubscribeSubscription);\n      }\n    },\n    messageHandler: async (message, subscriptionCallback): Promise<void> => {\n      switch (message.type) {\n        case 'fetch': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            return await query.fetch((result: any) => result);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n        }\n        case 'fetchAndSubscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n\n            if (!openSubscriptions) {\n              return await query.fetch((result: any) => result);\n            } else {\n              await createSubscription(\n                'fetchAndSubscribe',\n                message.payload,\n                resource,\n                query,\n                subscriptionCallback,\n              );\n            }\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          break;\n        }\n        case 'subscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            await createSubscription(\n              'subscribe',\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          break;\n        }\n        // case 'subscribe:changePayload': {\n        //   break;\n        // }\n        case 'subscribe:close': {\n          if (!openSubscriptions) {\n            throw new Error('Subscriptions not allowed');\n          }\n          try {\n            const { subscriptionId } = message.payload;\n            const SubscriptionAndSubscribeHook = openSubscriptions.get(\n              subscriptionId,\n            );\n            if (!SubscriptionAndSubscribeHook) {\n              logger.warn('tried to unsubscribe non existing watcher', {\n                subscriptionId,\n              });\n            } else {\n              openSubscriptions.delete(subscriptionId);\n              unsubscribeSubscription(SubscriptionAndSubscribeHook);\n            }\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n          }\n          break;\n        }\n        case 'do': {\n          try {\n            const resource = getResource(message.payload);\n            const { operationKey, params } = message.payload;\n\n            const operation = resource.operations[operationKey];\n\n            if (!operation) {\n              throw new ResourcesServerError(\n                'OPERATION_NOT_FOUND',\n                `Operation not found: ${operationKey}`,\n              );\n            }\n\n            return await operation(params, authenticatedUser);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n        }\n      }\n    },\n  };\n};\n"],"names":["ResourcesServerService","constructor","serviceResources","Map","addResource","key","resource","set","getServiceResource","get","Error","logger","Logger","logUnexpectedError","error","message","payload","ResourcesServerError","createMessageHandler","resourcesServerService","authenticatedUser","allowSubscriptions","openSubscriptions","getResource","debug","resourceName","createQuery","startsWith","queries","params","createSubscription","type","query","sendSubscriptionMessage","subscriptionId","has","warn","subscription","result","subscribeHook","subscribeHooks","undefined","subscribed","then","unsubscribeSubscription","stop","unsubscribed","close","forEach","messageHandler","subscriptionCallback","fetch","err","SubscriptionAndSubscribeHook","delete","operationKey","operation","operations"],"mappings":"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"}