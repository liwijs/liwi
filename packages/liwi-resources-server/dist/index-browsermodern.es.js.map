{"version":3,"file":"index-browsermodern.es.js","sources":["../src/ResourcesServerService.ts","../src/createMessageHandler.ts"],"sourcesContent":["import type { BaseModel, Criteria, Sort } from 'liwi-store';\n// import ResourceServerCursor from './ResourceServerCursor';\nimport type { ServiceResource } from './ServiceResource';\n\n// import { CursorResource } from './CursorResource';\n\nexport interface CreateCursorOptions<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport class ResourcesServerService {\n  readonly serviceResources: Map<string, ServiceResource<any, any>>;\n\n  // readonly cursorResources: Map<string, CursorResource<any, any, any>>;\n\n  constructor({\n    serviceResources = new Map(),\n  }: // cursorResources = new Map(),\n  {\n    serviceResources: Map<string, ServiceResource<any, any>>;\n    // cursorResources: Map<string, CursorResource<any, any, any>>;\n  }) {\n    this.serviceResources = serviceResources;\n    // this.cursorResources = cursorResources;\n  }\n\n  addResource(key: string, resource: ServiceResource<any, any>): void {\n    this.serviceResources.set(key, resource);\n  }\n\n  // addCursorResource(\n  //   key: string,\n  //   cursorResource: CursorResource<any, any, any>,\n  // ) {\n  //   this.cursorResources.set(key, cursorResource);\n  // }\n\n  getServiceResource(key: string): ServiceResource<any, any> {\n    const resource = this.serviceResources.get(key);\n    if (!resource) throw new Error(`Invalid service resource: \"${key}\"`);\n    return resource;\n  }\n\n  // getCursorResource(key: string) {\n  //   const resource = this.cursorResources.get(key);\n  //   if (!resource) throw new Error(`Invalid cursor resource: \"${key}\"`);\n  //   return resource;\n  // }\n\n  // async createCursor<Model extends BaseModel, Transformed, ConnectedUser>(\n  //   resource: CursorResource<Model, Transformed, ConnectedUser>,\n  //   connectedUser: ConnectedUser,\n  //   { criteria, sort, limit }: CreateCursorOptions<Model>,\n  // ): Promise<ResourceServerCursor<Model, any, Transformed, ConnectedUser>> {\n  //   // TODO: resource.query(connectedUser, criteria || {}, sort).cursor()\n  //   criteria = resource.criteria(connectedUser, criteria || {});\n  //   sort = resource.sort(connectedUser, sort);\n  //   const cursor = await resource.store.cursor(criteria, sort);\n  //   limit = resource.limit(limit);\n  //   if (limit) cursor.limit(limit);\n  //   return new ResourceServerCursor(resource, cursor, connectedUser);\n  // }\n}\n","/* eslint-disable complexity, max-lines */\nimport 'pob-babel';\nimport type {\n  Query,\n  QuerySubscription,\n  ToServerMessage,\n  ToServerSubscribeQueryPayload,\n  ToServerQueryPayload,\n} from 'liwi-resources';\nimport { ResourcesServerError } from 'liwi-resources';\nimport { Logger } from 'nightingale-logger';\nimport type { ResourcesServerService } from './ResourcesServerService';\nimport type { ServiceResource, SubscribeHook } from './ServiceResource';\n\nconst logger = new Logger('liwi:resources-websocket-client');\n\nexport type SubscriptionCallback = (\n  subscriptionId: number,\n  error: null | Error,\n  result: any,\n) => void;\n\nexport type MessageHandler = (\n  message: ToServerMessage,\n  subscriptionCallback: SubscriptionCallback,\n) => Promise<unknown>;\n\nexport interface SubscriptionAndSubscribeHook {\n  subscription: QuerySubscription;\n  subscribeHook?: SubscribeHook<any>;\n  params?: any;\n}\n\nconst logUnexpectedError = (\n  error: Error | unknown,\n  message: string,\n  payload: unknown,\n): void => {\n  if (__DEV__ || !(error instanceof ResourcesServerError)) {\n    logger.error(message, {\n      error,\n      payload: !__DEV__ ? 'redacted' : payload,\n    });\n  }\n};\n\nexport const createMessageHandler = <AuthenticatedUser>(\n  resourcesServerService: ResourcesServerService,\n  authenticatedUser: AuthenticatedUser | null,\n  allowSubscriptions: boolean,\n): {\n  messageHandler: MessageHandler;\n  close: () => void;\n} => {\n  const openedSubscriptions = allowSubscriptions\n    ? new Map<number, SubscriptionAndSubscribeHook>()\n    : null;\n\n  const getResource = (payload: {\n    resourceName: string;\n  }): ServiceResource<any, any> => {\n    logger.debug('resource', {\n      resourceName: payload.resourceName,\n    });\n    const resource = resourcesServerService.getServiceResource(\n      payload.resourceName,\n    );\n    return resource;\n  };\n\n  const createQuery = <\n    Service extends ServiceResource<any, any>,\n    Key extends keyof Service['queries'] & string,\n  >(\n    payload: ToServerQueryPayload<Key>,\n    resource: Service,\n  ): Query<any, any> => {\n    if (!payload.key.startsWith('query')) {\n      throw new Error('Invalid query key');\n    }\n\n    return resource.queries[payload.key](payload.params, authenticatedUser);\n  };\n\n  const createSubscription = (\n    type: 'fetchAndSubscribe' | 'subscribe',\n    payload: ToServerSubscribeQueryPayload,\n    resource: ServiceResource<any, any>,\n    query: Query<any, any>,\n    sendSubscriptionMessage: SubscriptionCallback,\n  ): PromiseLike<null> => {\n    if (!openedSubscriptions) {\n      throw new Error('Subscriptions not allowed');\n    }\n\n    const { subscriptionId } = payload;\n    if (openedSubscriptions.has(subscriptionId)) {\n      const error = 'Already have a watcher for this id. Cannot add a new one';\n      logger.warn(error, { subscriptionId, key: payload.key });\n      throw new ResourcesServerError('ALREADY_HAVE_WATCHER', error);\n    }\n\n    const subscription = query[type]((error: Error | null, result: any) => {\n      if (error) {\n        logUnexpectedError(error, type, payload);\n      }\n      sendSubscriptionMessage(subscriptionId, error, result);\n    });\n\n    const subscribeHook = resource.subscribeHooks?.[payload.key];\n    openedSubscriptions.set(subscriptionId, {\n      subscription,\n      subscribeHook,\n      params: subscribeHook ? payload.params : undefined,\n    });\n    if (subscribeHook) {\n      subscribeHook.subscribed(authenticatedUser, payload.params);\n    }\n\n    return subscription.then(() => null);\n  };\n\n  const unsubscribeSubscription = ({\n    subscription,\n    subscribeHook,\n    params,\n  }: SubscriptionAndSubscribeHook): void => {\n    subscription.stop();\n    if (subscribeHook) {\n      subscribeHook.unsubscribed(authenticatedUser, params);\n    }\n  };\n\n  return {\n    close: () => {\n      if (openedSubscriptions) {\n        openedSubscriptions.forEach(unsubscribeSubscription);\n      }\n    },\n    messageHandler: async (message, subscriptionCallback): Promise<unknown> => {\n      switch (message.type) {\n        case 'fetch': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            return await query.fetch((result) => result);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          return;\n        }\n        case 'fetchAndSubscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n\n            return await createSubscription(\n              'fetchAndSubscribe',\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          return;\n        }\n        case 'subscribe': {\n          try {\n            const resource = getResource(message.payload);\n            const query = createQuery(message.payload, resource);\n            await createSubscription(\n              'subscribe',\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n          return;\n        }\n        // case 'subscribe:changePayload': {\n        //   break;\n        // }\n        case 'subscribe:close': {\n          if (!openedSubscriptions) {\n            throw new Error('Subscriptions not allowed');\n          }\n          try {\n            const { subscriptionId } = message.payload;\n            const SubscriptionAndSubscribeHook =\n              openedSubscriptions.get(subscriptionId);\n            if (!SubscriptionAndSubscribeHook) {\n              logger.warn('tried to unsubscribe non existing watcher', {\n                subscriptionId,\n              });\n            } else {\n              openedSubscriptions.delete(subscriptionId);\n              unsubscribeSubscription(SubscriptionAndSubscribeHook);\n            }\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n          }\n          return;\n        }\n        case 'do': {\n          try {\n            const resource = getResource(message.payload);\n            const { operationKey, params } = message.payload;\n\n            const operation = resource.operations[operationKey];\n\n            if (!operation) {\n              throw new ResourcesServerError(\n                'OPERATION_NOT_FOUND',\n                `Operation not found: ${operationKey}`,\n              );\n            }\n\n            return operation(params, authenticatedUser);\n          } catch (err) {\n            logUnexpectedError(err, message.type, message.payload);\n            throw err;\n          }\n        }\n      }\n    },\n  };\n};\n"],"names":["ResourcesServerService","constructor","serviceResources","Map","addResource","key","resource","set","getServiceResource","get","Error","logger","Logger","logUnexpectedError","error","message","payload","ResourcesServerError","createMessageHandler","resourcesServerService","authenticatedUser","allowSubscriptions","openedSubscriptions","getResource","debug","resourceName","createQuery","startsWith","queries","params","createSubscription","type","query","sendSubscriptionMessage","subscriptionId","has","warn","subscription","result","subscribeHook","subscribeHooks","undefined","subscribed","then","unsubscribeSubscription","stop","unsubscribed","close","forEach","messageHandler","subscriptionCallback","fetch","err","SubscriptionAndSubscribeHook","delete","operationKey","operation","operations"],"mappings":"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"}