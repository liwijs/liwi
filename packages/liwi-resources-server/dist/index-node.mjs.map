{"version":3,"file":"index-node.mjs","sources":["../src/ResourcesServerService.ts","../src/createMessageHandler.ts"],"sourcesContent":["import type { BaseModel, Criteria, Sort } from \"liwi-store\";\n// import ResourceServerCursor from './ResourceServerCursor';\nimport type { ServiceResource } from \"./ServiceResource\";\n\n// import { CursorResource } from './CursorResource';\n\nexport interface CreateCursorOptions<Model extends BaseModel> {\n  criteria?: Criteria<Model>;\n  sort?: Sort<Model>;\n  limit?: number;\n}\n\nexport class ResourcesServerService {\n  readonly serviceResources: Map<string, ServiceResource<any, any>>;\n\n  // readonly cursorResources: Map<string, CursorResource<any, any, any>>;\n\n  constructor({\n    serviceResources = new Map(),\n  }: // cursorResources = new Map(),\n  {\n    serviceResources: Map<string, ServiceResource<any, any>>;\n    // cursorResources: Map<string, CursorResource<any, any, any>>;\n  }) {\n    this.serviceResources = serviceResources;\n    // this.cursorResources = cursorResources;\n  }\n\n  addResource(key: string, resource: ServiceResource<any, any>): void {\n    this.serviceResources.set(key, resource);\n  }\n\n  // addCursorResource(\n  //   key: string,\n  //   cursorResource: CursorResource<any, any, any>,\n  // ) {\n  //   this.cursorResources.set(key, cursorResource);\n  // }\n\n  getServiceResource(key: string): ServiceResource<any, any> {\n    const resource = this.serviceResources.get(key);\n    if (!resource) throw new Error(`Invalid service resource: \"${key}\"`);\n    return resource;\n  }\n\n  // getCursorResource(key: string) {\n  //   const resource = this.cursorResources.get(key);\n  //   if (!resource) throw new Error(`Invalid cursor resource: \"${key}\"`);\n  //   return resource;\n  // }\n\n  // async createCursor<Model extends BaseModel, Transformed, ConnectedUser>(\n  //   resource: CursorResource<Model, Transformed, ConnectedUser>,\n  //   connectedUser: ConnectedUser,\n  //   { criteria, sort, limit }: CreateCursorOptions<Model>,\n  // ): Promise<ResourceServerCursor<Model, any, Transformed, ConnectedUser>> {\n  //   // TODO: resource.query(connectedUser, criteria || {}, sort).cursor()\n  //   criteria = resource.criteria(connectedUser, criteria || {});\n  //   sort = resource.sort(connectedUser, sort);\n  //   const cursor = await resource.store.cursor(criteria, sort);\n  //   limit = resource.limit(limit);\n  //   if (limit) cursor.limit(limit);\n  //   return new ResourceServerCursor(resource, cursor, connectedUser);\n  // }\n}\n","import type {\n  Query,\n  QuerySubscription,\n  ToServerMessage,\n  ToServerQueryPayload,\n  ToServerSubscribeQueryPayload,\n} from \"liwi-resources\";\nimport { ResourcesServerError } from \"liwi-resources\";\nimport { Logger } from \"nightingale-logger\";\nimport type { ResourcesServerService } from \"./ResourcesServerService\";\nimport type { ServiceResource, SubscribeHook } from \"./ServiceResource\";\n\nconst logger = new Logger(\"liwi:resources-websocket-client\");\n\nexport type SubscriptionCallback = (\n  subscriptionId: number,\n  error: Error | null,\n  result: any,\n) => void;\n\nexport type MessageHandler = (\n  message: ToServerMessage,\n  subscriptionCallback: SubscriptionCallback,\n) => Promise<unknown>;\n\nexport interface SubscriptionAndSubscribeHook {\n  subscription: QuerySubscription;\n  subscribeHook?: SubscribeHook<any>;\n  params?: any;\n}\n\nconst logUnexpectedError = (\n  error: Error | unknown,\n  message: string,\n  payload: unknown,\n): void => {\n  if (!(error instanceof ResourcesServerError)) {\n    logger.error(message, {\n      error,\n      payload: process.env.NODE_ENV === \"production\" ? \"redacted\" : payload,\n    });\n  } else if (process.env.NODE_ENV !== \"production\") {\n    logger.info(`ResourcesServerError in ${message}`, {\n      code: error.code,\n      message: error.message,\n      payload,\n    });\n  }\n};\n\nexport const createMessageHandler = <AuthenticatedUser>(\n  resourcesServerService: ResourcesServerService,\n  authenticatedUser: AuthenticatedUser | null,\n  allowSubscriptions: boolean,\n): {\n  messageHandler: MessageHandler;\n  close: () => void;\n} => {\n  const openedSubscriptions = allowSubscriptions\n    ? new Map<number, SubscriptionAndSubscribeHook>()\n    : null;\n\n  const getResource = (payload: {\n    resourceName: string;\n  }): ServiceResource<any, any> => {\n    logger.debug(\"resource\", {\n      resourceName: payload.resourceName,\n    });\n    const resource = resourcesServerService.getServiceResource(\n      payload.resourceName,\n    );\n    return resource;\n  };\n\n  const createQuery = async <\n    Service extends ServiceResource<any, any>,\n    Key extends string & keyof Service[\"queries\"],\n  >(\n    payload: ToServerQueryPayload<Key>,\n    resource: Service,\n  ): Promise<Query<any, any>> => {\n    if (!payload.key.startsWith(\"query\")) {\n      throw new Error(\"Invalid query key\");\n    }\n\n    const result = await resource.queries[payload.key]!(\n      payload.params,\n      authenticatedUser,\n    );\n    return result;\n  };\n\n  const createSubscription = (\n    type: \"fetchAndSubscribe\" | \"subscribe\",\n    payload: ToServerSubscribeQueryPayload,\n    resource: ServiceResource<any, any>,\n    query: Query<any, any>,\n    sendSubscriptionMessage: SubscriptionCallback,\n    // eslint-disable-next-line @typescript-eslint/max-params\n  ): PromiseLike<null> => {\n    if (!openedSubscriptions) {\n      throw new Error(\"Subscriptions not allowed\");\n    }\n\n    const { subscriptionId } = payload;\n    if (openedSubscriptions.has(subscriptionId)) {\n      const error = \"Already have a watcher for this id. Cannot add a new one\";\n      logger.warn(error, { subscriptionId, key: payload.key });\n      throw new ResourcesServerError(\"ALREADY_HAVE_WATCHER\", error);\n    }\n\n    const subscription = query[type]((error: Error | null, result: any) => {\n      if (error) {\n        logUnexpectedError(error, type, payload);\n      }\n      sendSubscriptionMessage(subscriptionId, error, result);\n    });\n\n    const subscribeHook = resource.subscribeHooks?.[payload.key];\n    openedSubscriptions.set(subscriptionId, {\n      subscription,\n      subscribeHook,\n      params: subscribeHook ? payload.params : undefined,\n    });\n    if (subscribeHook) {\n      subscribeHook.subscribed(authenticatedUser, payload.params);\n    }\n\n    return subscription.then(() => null);\n  };\n\n  const unsubscribeSubscription = ({\n    subscription,\n    subscribeHook,\n    params,\n  }: SubscriptionAndSubscribeHook): void => {\n    subscription.stop();\n    if (subscribeHook) {\n      subscribeHook.unsubscribed(authenticatedUser, params);\n    }\n  };\n\n  return {\n    close: () => {\n      if (openedSubscriptions) {\n        openedSubscriptions.forEach(unsubscribeSubscription);\n      }\n    },\n    messageHandler: async (message, subscriptionCallback): Promise<unknown> => {\n      switch (message.type) {\n        case \"fetch\": {\n          try {\n            const resource = getResource(message.payload);\n            const query = await createQuery(message.payload, resource);\n            return await query.fetch((result) => result);\n          } catch (error) {\n            logUnexpectedError(error, message.type, message.payload);\n            throw error;\n          }\n        }\n        case \"fetchAndSubscribe\": {\n          try {\n            const resource = getResource(message.payload);\n            const query = await createQuery(message.payload, resource);\n\n            return await createSubscription(\n              \"fetchAndSubscribe\",\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (error) {\n            logUnexpectedError(error, message.type, message.payload);\n            throw error;\n          }\n        }\n        case \"subscribe\": {\n          try {\n            const resource = getResource(message.payload);\n            const query = await createQuery(message.payload, resource);\n            await createSubscription(\n              \"subscribe\",\n              message.payload,\n              resource,\n              query,\n              subscriptionCallback,\n            );\n          } catch (error) {\n            logUnexpectedError(error, message.type, message.payload);\n            throw error;\n          }\n          return;\n        }\n        // case 'subscribe:changePayload': {\n        //   break;\n        // }\n        case \"subscribe:close\": {\n          if (!openedSubscriptions) {\n            throw new Error(\"Subscriptions not allowed\");\n          }\n          try {\n            const { subscriptionId } = message.payload;\n            const SubscriptionAndSubscribeHook =\n              openedSubscriptions.get(subscriptionId);\n            if (!SubscriptionAndSubscribeHook) {\n              logger.warn(\"tried to unsubscribe non existing watcher\", {\n                subscriptionId,\n              });\n            } else {\n              openedSubscriptions.delete(subscriptionId);\n              unsubscribeSubscription(SubscriptionAndSubscribeHook);\n            }\n          } catch (error) {\n            logUnexpectedError(error, message.type, message.payload);\n          }\n          return;\n        }\n        case \"do\": {\n          try {\n            const resource = getResource(message.payload);\n            const { operationKey, params } = message.payload;\n\n            const operation = resource.operations[operationKey];\n\n            if (!operation) {\n              throw new ResourcesServerError(\n                \"OPERATION_NOT_FOUND\",\n                `Operation not found: ${operationKey}`,\n              );\n            }\n\n            return operation(params, authenticatedUser);\n          } catch (error) {\n            logUnexpectedError(error, message.type, message.payload);\n            throw error;\n          }\n        }\n        default:\n          throw new ResourcesServerError(\n            \"INVALID_MESSAGE_TYPE\",\n            \"Invalid message type\",\n          );\n      }\n    },\n  };\n};\n"],"names":["ResourcesServerService","constructor","serviceResources","Map","addResource","key","resource","set","getServiceResource","get","Error","logger","Logger","logUnexpectedError","error","message","payload","ResourcesServerError","process","env","NODE_ENV","info","code","createMessageHandler","resourcesServerService","authenticatedUser","allowSubscriptions","openedSubscriptions","getResource","debug","resourceName","createQuery","startsWith","result","queries","params","createSubscription","type","query","sendSubscriptionMessage","subscriptionId","has","warn","subscription","subscribeHook","subscribeHooks","undefined","subscribed","then","unsubscribeSubscription","stop","unsubscribed","close","forEach","messageHandler","subscriptionCallback","fetch","SubscriptionAndSubscribeHook","delete","operationKey","operation","operations"],"mappings":"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"}