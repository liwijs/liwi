{"version":3,"file":"index-browsermodern-dev.es.js","sources":["../src/index.js"],"sourcesContent":["import Logger from 'nightingale-logger';\nimport { encode, decode } from 'extended-json';\n\nconst logger = new Logger('liwi:rest-websocket');\n\nexport default function init(io, restService) {\n  io.on('connection', socket => {\n    const openWatchers = new Set();\n\n    socket.on('disconnect', () => {\n      openWatchers.forEach(watcher => watcher.stop());\n    });\n\n    socket.on(\n      'rest',\n      (\n        { type, restName, json }: { json?: ?string, restName: string, type: string },\n        args: ?Array<any> | Function,\n        callback: ?Function,\n      ) => {\n        try {\n          if (json) {\n            if (!PRODUCTION && callback) {\n              throw new Error('Cannot have args and json.');\n            }\n\n            callback = args;\n            args = decode(json);\n            if (!Array.isArray(args)) {\n              logger.debug('args', { args });\n\n              if (callback) {\n                throw new Error('Invalid args');\n              }\n            }\n          }\n\n          if (!callback) {\n            logger[!PRODUCTION ? 'warn' : 'error']('callback missing');\n            return;\n          }\n\n          const restResource = restService.get(restName);\n\n          logger.info('rest', { type, restName, args });\n          switch (type) {\n            case 'cursor toArray': {\n              const [options] = args;\n              return restService\n                .createCursor(restResource, socket.user, options)\n                .then(cursor => cursor.toArray())\n                .then(results => callback(null, encode(results)))\n                .catch(err => {\n                  logger.error(type, err);\n                  callback(err.message);\n                });\n            }\n\n            case 'insertOne':\n            case 'updateOne':\n            case 'updateSeveral':\n            case 'partialUpdateByKey':\n            case 'partialUpdateOne':\n            case 'partialUpdateMany':\n            case 'deleteByKey':\n            case 'deleteOne':\n            case 'findOne':\n              try {\n                if (!PRODUCTION && !restResource[type]) {\n                  throw new Error(`rest: ${restName}.${type} is not available`);\n                }\n\n                // eslint-disable-next-line prettier/prettier\n                return restResource[type](socket.user, ...args)\n                  .then(result => callback(null, encode(result)))\n                  .catch(err => {\n                    logger.error(type, { err });\n                    callback(err.message || err);\n                  });\n              } catch (err) {\n                logger.error(type, { err });\n                callback(err.message || err);\n              }\n              break;\n\n            case 'fetch':\n            case 'subscribe':\n            case 'fetchAndSubscribe':\n              try {\n                const [key, eventName, otherArgs = []] = args;\n\n                if (!key.startsWith('query')) {\n                  throw new Error('Invalid query key');\n                }\n\n                const query = restResource.queries[key]; // todo pass connected user\n                if (!query) {\n                  throw new Error(`rest: ${restName}.${type}.${key} is not available`);\n                }\n\n                if (type === 'fetch') {\n                  return query[type](\n                    result => callback(null, result && encode(result)),\n                    ...otherArgs,\n                  ).catch(err => {\n                    logger.error(type, { err });\n                    callback(err.message || err);\n                  });\n                } else {\n                  const watcher = query[type]((err, result) => {\n                    if (err) {\n                      logger.error(type, { err });\n                    }\n\n                    socket.emit(eventName, err, result && encode(result));\n                  });\n                  watcher.then(\n                    () => callback(),\n                    err => {\n                      logger.error(type, { err });\n                      callback(err.message || err);\n                    },\n                  );\n\n                  openWatchers.add(watcher);\n                }\n              } catch (err) {\n                logger.error(type, { err });\n                callback(err.message || err);\n              }\n              break;\n\n            default:\n              try {\n                logger.warn('Unknown command', { type });\n                callback(`rest: unknown command \"${type}\"`);\n              } catch (err) {\n                logger.error(type, { err });\n                callback(err.message || err);\n              }\n          }\n        } catch (err) {\n          logger.warn('rest error', { err });\n          callback(err.message || err);\n        }\n      },\n    );\n  });\n}\n"],"names":["logger","Logger","init","io","restService","on","openWatchers","Set","forEach","watcher","stop","args","callback","type","restName","json","Error","decode","Array","isArray","debug","restResource","get","info","options","createCursor","socket","user","then","cursor","toArray","encode","results","catch","error","err","message","result","key","eventName","otherArgs","startsWith","query","queries","emit","add","warn"],"mappings":"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"}