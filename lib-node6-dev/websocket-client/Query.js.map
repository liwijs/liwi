{"version":3,"sources":["../../src/websocket-client/Query.js"],"names":["logger","Query","constructor","store","key","fetch","callback","emit","then","_subscribe","_includeInitial","args","eventName","restName","listener","err","result","decodedResult","debug","connection","on","_stopEmitSubscribe","promise","emitSubscribe","stopEmitSubscribe","info","catch","off","stop","cancel","cb","Promise","resolve"],"mappings":";;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEA,8EAA2B,6BACzB,yCAAQ,gCAAR,CADyB,EAEzB,uCAAM,gCAAN,CAFyB,CAA3B;;AAKA,MAAMA,SAAS,gCAAW,6BAAX,CAAf;;IAEqBC,K,GAAN,sCAAkD;AAC/DC,cAAYC,KAAZ,EAAmCC,GAAnC,EAAgD;AAAA,qBAA/B,mDAA+B;;AAAA,mBAAV,8BAAU;;AAAA,8HAC9C,MAAMD,KAAN,CAD8C,iDADD,mDACC,GAE9C,KAAKC,GAAL,GAAWA,GAFmC;AAG/C;;AAEDC,QAAMC,QAAN,EAAyC;AAAA,wBAA3B,+BAAG,gCAAH,CAA2B;;AAAA,qDAAL,2BAAK;;AACvC,oFAAO,KAAKH,KAAL,CAAWI,IAAX,CAAgB,OAAhB,EAAyB,KAAKH,GAA9B,EAAmCI,IAAnC,CAAwCF,QAAxC,CAAP;AACD;;AAEDG,aAAWH,QAAX,EAA+BI,kBAAkB,KAAjD,EAAwDC,IAAxD,EAA+F;AAAA,yBAA5E,gCAA4E;;AAAA,oBAAnC,4BAAQ,2BAAR,CAAmC;;AAAA,sDAApB,mBAAoB;;AAAA;;AAC7F,UAAMC,YAAa,aAAY,KAAKT,KAAL,CAAWU,QAAS,IAAG,KAAKT,GAAI,EAA/D;AACA,UAAMU,WAAW,CAACC,GAAD,EAAMC,MAAN,KAAiB;AAChC,YAAMC,gBAAgBD,UAAU,0BAAOA,MAAP,CAAhC;AACiBhB,aAAOkB,KAAP,CAAaN,SAAb,EAAwB,EAAEI,MAAF,EAAUC,aAAV,EAAxB,CAFe,EAGhCX,SAASS,GAAT,EAAcE,aAAd,CAHgC;AAIjC,KAJD;AAKA,SAAKd,KAAL,CAAWgB,UAAX,CAAsBC,EAAtB,CAAyBR,SAAzB,EAAoCE,QAApC,CAP6F;;;AAS7F,QAAIO,kBAAJ;AACA,QAAIC,UAAU,KAAKnB,KAAL,CACXoB,aADW,CACGb,kBAAkB,mBAAlB,GAAwC,WAD3C,EACwD,KAAKN,GAD7D,EACkEQ,SADlE,EAC6ED,IAD7E,EAEXH,IAFW,CAENgB,qBAAqB;AACzBH,2BAAqBG,iBADI,EAEzBxB,OAAOyB,IAAP,CAAY,YAAZ,CAFyB;AAG1B,KALW,EAMXC,KANW,CAMLX,OAAO;AAEZ,YADA,KAAKZ,KAAL,CAAWgB,UAAX,CAAsBQ,GAAtB,CAA0Bf,SAA1B,EAAqCE,QAArC,CACA,EAAMC,GAAN;AACD,KATW,CAAd;;AAWA,UAAMa,OAAO,MAAM;AACZN,aADY,KAEjBD,oBAFiB,EAGjBC,QAAQd,IAAR,CAAa,MAAM;AACjBc,kBAAU,IADO,EAEjB,KAAKnB,KAAL,CAAWgB,UAAX,CAAsBQ,GAAtB,CAA0Bf,SAA1B,EAAqCE,QAArC,CAFiB;AAGlB,OAHD,CAHiB;AAOlB,KAPD;;AASA,+BAAO;AACLe,cAAQD,IADH;AAELA,UAFK;AAGLpB,YAAMsB,MAAMC,QAAQC,OAAR,CAAgBV,OAAhB,EAAyBd,IAAzB,CAA8BsB,EAA9B;AAHP,KAAP;AAKD;AA7C8D,C;kBAA5C7B,K","file":"Query.js","sourcesContent":["import Logger from 'nightingale-logger';\nimport AbstractQuery from '../store/AbstractQuery';\nimport WebsocketStore from './WebsocketStore';\nimport { decode } from '../extended-json';\n\ntype SubscribeReturnType = {\n  cancel: Function,\n  stop: Function,\n};\n\nconst logger = new Logger('liwi:websocket-client:query');\n\nexport default class Query extends AbstractQuery<WebsocketStore> {\n  constructor(store: WebsocketStore, key: string) {\n    super(store);\n    this.key = key;\n  }\n\n  fetch(callback: ?Function): Promise<any> {\n    return this.store.emit('fetch', this.key).then(callback);\n  }\n\n  _subscribe(callback: Function, _includeInitial = false, args: Array<any>): SubscribeReturnType {\n    const eventName = `subscribe:${this.store.restName}.${this.key}`;\n    const listener = (err, result) => {\n      const decodedResult = result && decode(result);\n      if (!PRODUCTION) logger.debug(eventName, { result, decodedResult });\n      callback(err, decodedResult);\n    };\n    this.store.connection.on(eventName, listener);\n\n    let _stopEmitSubscribe;\n    let promise = this.store\n      .emitSubscribe(_includeInitial ? 'fetchAndSubscribe' : 'subscribe', this.key, eventName, args)\n      .then(stopEmitSubscribe => {\n        _stopEmitSubscribe = stopEmitSubscribe;\n        logger.info('subscribed');\n      })\n      .catch(err => {\n        this.store.connection.off(eventName, listener);\n        throw err;\n      });\n\n    const stop = () => {\n      if (!promise) return;\n      _stopEmitSubscribe();\n      promise.then(() => {\n        promise = null;\n        this.store.connection.off(eventName, listener);\n      });\n    };\n\n    return {\n      cancel: stop,\n      stop,\n      then: cb => Promise.resolve(promise).then(cb),\n    };\n  }\n}\n"]}