{"version":3,"sources":["../../src/websocket-client/Query.js"],"names":["SubscribeReturnType","cancel","stop","logger","Query","constructor","store","key","fetch","callback","emit","then","_subscribe","_includeInitial","args","eventName","restName","connection","on","err","result","_stopEmitSubscribe","promise","emitSubscribe","stopEmitSubscribe","info","catch","off","cb","Promise","resolve"],"mappings":";;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;MAEKA,mB;AACHC,Q;AACAC,M;;;AAGF,MAAMC,SAAS,gCAAW,6BAAX,CAAf;;AAEe,MAAMC,KAAN,iCAAkD;AAC/DC,cAAYC,KAAZ,EAAmCC,GAAnC,EAAgD;AAAA,YAApCD,KAAoC;;AAAA,YAAbC,GAAa;;AAC9C,UAAMD,KAAN;AACA,SAAKC,GAAL,GAAWA,GAAX;AACD;;AAEDC,QAAMC,QAAN,EAAoC;AAAA,YAA9BA,QAA8B;;AAAA;AAClC,aAAO,KAAKH,KAAL,CAAWI,IAAX,CAAgB,OAAhB,EAAyB,KAAKH,GAA9B,EAAmCI,IAAnC,CAAwCF,QAAxC,CAAP;AADkC;AAEnC;;AAEDG,aAAWH,QAAX,EAA+BI,kBAAkB,KAAjD,EAAwDC,IAAxD,EAA+F;AAAA,YAApFL,QAAoF;;AAAA,YAAvCK,IAAuC;;AAAA;AAC7F,YAAMC,YAAa,cAAY,KAAKT,KAAL,CAAWU,QAAS,MAAG,KAAKT,GAAI,GAA/D;AACA,WAAKD,KAAL,CAAWW,UAAX,CAAsBC,EAAtB,CAAyBH,SAAzB,EAAoC,CAACI,GAAD,EAAMC,MAAN,KAAiB;AACnDX,iBAASU,GAAT,EAAc,qBAAOC,MAAP,CAAd;AACD,OAFD;;AAIA,UAAIC,kBAAJ;AACA,UAAIC,UAAU,KAAKhB,KAAL,CAAWiB,aAAX,CACZV,kBAAkB,mBAAlB,GAAwC,WAD5B,EAEZ,KAAKN,GAFO,EAGZQ,SAHY,EAIZD,IAJY,EAKZH,IALY,CAKPa,qBAAqB;AAC1BH,6BAAqBG,iBAArB;AACArB,eAAOsB,IAAP,CAAY,YAAZ;AACD,OARa,EAQXC,KARW,CAQLP,OAAO;AACd,aAAKb,KAAL,CAAWW,UAAX,CAAsBU,GAAtB,CAA0BZ,SAA1B,EAAqCN,QAArC;AACA,cAAMU,GAAN;AACD,OAXa,CAAd;;AAaA,YAAMjB,OAAO,MAAM;AACjB,YAAI,CAACoB,OAAL,EAAc;AACdD;AACAC,gBAAQX,IAAR,CAAa,MAAM;AACjBW,oBAAU,IAAV;AACA,eAAKhB,KAAL,CAAWW,UAAX,CAAsBU,GAAtB,CAA0BZ,SAA1B,EAAqCN,QAArC;AACD,SAHD;AAID,OAPD;;AASA,aAAO;AACLR,gBAAQC,IADH;AAELA,YAFK;AAGLS,cAAMiB,MAAMC,QAAQC,OAAR,CAAgBR,OAAhB,EAAyBX,IAAzB,CAA8BiB,EAA9B;AAHP,OAAP;AA7B6F,8BAApB5B,mBAAoB;AAkC9F;AA5C8D;kBAA5CI,K","file":"Query.js","sourcesContent":["import Logger from 'nightingale-logger';\nimport AbstractQuery from '../store/AbstractQuery';\nimport WebsocketStore from './WebsocketStore';\nimport { decode } from '../msgpack';\n\ntype SubscribeReturnType = {\n  cancel: Function,\n  stop: Function,\n};\n\nconst logger = new Logger('liwi:websocket-client:query');\n\nexport default class Query extends AbstractQuery<WebsocketStore> {\n  constructor(store: WebsocketStore, key: string) {\n    super(store);\n    this.key = key;\n  }\n\n  fetch(callback: ?Function): Promise {\n    return this.store.emit('fetch', this.key).then(callback);\n  }\n\n  _subscribe(callback: Function, _includeInitial = false, args: Array<any>): SubscribeReturnType {\n    const eventName = `subscribe:${this.store.restName}.${this.key}`;\n    this.store.connection.on(eventName, (err, result) => {\n      callback(err, decode(result));\n    });\n\n    let _stopEmitSubscribe;\n    let promise = this.store.emitSubscribe(\n      _includeInitial ? 'fetchAndSubscribe' : 'subscribe',\n      this.key,\n      eventName,\n      args,\n    ).then(stopEmitSubscribe => {\n      _stopEmitSubscribe = stopEmitSubscribe;\n      logger.info('subscribed');\n    }).catch(err => {\n      this.store.connection.off(eventName, callback);\n      throw err;\n    });\n\n    const stop = () => {\n      if (!promise) return;\n      _stopEmitSubscribe();\n      promise.then(() => {\n        promise = null;\n        this.store.connection.off(eventName, callback);\n      });\n    };\n\n    return {\n      cancel: stop,\n      stop,\n      then: cb => Promise.resolve(promise).then(cb),\n    };\n  }\n}\n"]}